(function(){"use strict";var t,e=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};!function(t){!function(t){t[t.Unspecified=0]="Unspecified",t[t.RetryLimitExceeded=1]="RetryLimitExceeded",t[t.NetworkError=2]="NetworkError",t[t.ClientError=3]="ClientError",t[t.ServerError=4]="ServerError"}(t.AssetLoadErrorType||(t.AssetLoadErrorType={}))}(t||(t={}));var t;!function(t){!function(e){function i(t,e){var i=new Error(t);return i.name="AssertionError",i.cause=e,i}function r(t,e,i,r){var s="Type mismatch on "+t+", expected type is "+e;if(arguments.length>2)try{var n;n=i&&i.constructor&&i.constructor.name?i.constructor.name:typeof i,s+=", actual type is "+(n.length>40?n.substr(0,40):n)}catch(t){}s+=".";var o=new Error(s);return o.name="TypeMismatchError",o.cause=r,o.expected=e,o.actual=i,o}function s(e,i,r,s){void 0===i&&(i=!0),void 0===r&&(r=t.AssetLoadErrorType.Unspecified);var n=new Error(e);return n.name="AssetLoadError",n.cause=s,n.retriable=i,n.type=r,n}e.createAssertionError=i,e.createTypeMismatchError=r,e.createAssetLoadError=s}(t.ExceptionFactory||(t.ExceptionFactory={}))}(t||(t={}));var t;!function(t){var e=function(){function e(){}return e.prototype.createSurfaceAtlas=function(e,i){return new t.SurfaceAtlas(this.createSurface(e,i))},e}();t.ResourceFactory=e}(t||(t={}));var t;!function(t){var e=function(){function t(t){this._value=t}return t.prototype._cachedValue=function(){return this._value},t}();t.RequireCachedValue=e}(t||(t={}));var t;!function(t){var e=function(){function t(t){this.seed=t,this[0]=this}return t}();t.RandomGenerator=e}(t||(t={}));var t;!function(t){var i=function(){function e(e,i){this.id=e,this.originalPath=i,this.path=this._assetPathFilter(i),this.onDestroyed=new t.Trigger}return e.prototype.destroy=function(){this.onDestroyed.fire(this),this.id=void 0,this.originalPath=void 0,this.path=void 0,this.onDestroyed.destroy(),this.onDestroyed=void 0},e.prototype.destroyed=function(){return void 0===this.id},e.prototype.inUse=function(){return!1},e.prototype._assetPathFilter=function(t){return t},e}();t.Asset=i;var r=function(t){function i(e,i,r,s){var n=t.call(this,e,i)||this;return n.width=r,n.height=s,n}return e(i,t),i}(i);t.ImageAsset=r;var s=function(t){function i(e,i,r,s,n,o,a){var h=t.call(this,e,i,r,s)||this;return h.realWidth=0,h.realHeight=0,h._system=n,h._loop=o,h._useRealSize=a,h}return e(i,t),i.prototype.play=function(t){return this.getPlayer().play(this),this.getPlayer()},i.prototype.stop=function(){this.getPlayer().stop()},i.prototype.destroy=function(){this._system=void 0,t.prototype.destroy.call(this)},i}(r);t.VideoAsset=s;var n=function(t){function i(e,i,r,s,n,o){var a=t.call(this,e,i)||this;return a.duration=r,a.loop=n,a.hint=o,a._system=s,a.data=void 0,a}return e(i,t),i.prototype.play=function(){var t=this._system.createPlayer();return t.play(this),this._lastPlayedPlayer=t,t},i.prototype.stop=function(){for(var t=this._system.findPlayers(this),e=0;e<t.length;++e)t[e].stop()},i.prototype.inUse=function(){return this._system.findPlayers(this).length>0},i.prototype.destroy=function(){this._system&&this.stop(),this.data=void 0,this._system=void 0,this._lastPlayedPlayer=void 0,t.prototype.destroy.call(this)},i}(i);t.AudioAsset=n;var o=function(t){function i(e,i){var r=t.call(this,e,i)||this;return r.data=void 0,r}return e(i,t),i.prototype.destroy=function(){this.data=void 0,t.prototype.destroy.call(this)},i}(i);t.TextAsset=o;var a=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.destroy=function(){this.script=void 0,t.prototype.destroy.call(this)},i}(i);t.ScriptAsset=a}(t||(t={}));var t;!function(t){function e(t){t=t||{};var e={music:{loop:!0,hint:{streaming:!0}},sound:{loop:!1,hint:{streaming:!1}}};for(var i in e)i in t||(t[i]=e[i]);return t}var i=function(){function t(t,e){this.asset=t,this.handlers=[e],this.errorCount=0,this.loading=!1}return t}(),r=function(){function r(t,i,r,s){this.game=t,this.configuration=this._normalize(i||{},e(r)),this._assets={},this._liveAssetVirtualPathTable={},this._liveAbsolutePathTable={},this._moduleMainScripts=s||{},this._refCounts={},this._loadings={}}return r.prototype.destroy=function(){for(var t=Object.keys(this._refCounts),e=0;e<t.length;++e)this._releaseAsset(t[e]);this.game=void 0,this.configuration=void 0,this._assets=void 0,this._liveAssetVirtualPathTable=void 0,this._liveAbsolutePathTable=void 0,this._refCounts=void 0,this._loadings=void 0},r.prototype.destroyed=function(){return void 0===this.game},r.prototype.retryLoad=function(e){if(!this._loadings.hasOwnProperty(e.id))throw t.ExceptionFactory.createAssertionError("AssetManager#retryLoad: invalid argument.");var i=this._loadings[e.id];if(i.errorCount>r.MAX_ERROR_COUNT){if(!this.configuration[e.id])return;throw t.ExceptionFactory.createAssertionError("AssetManager#retryLoad: too many retrying.")}i.loading||(i.loading=!0,e._load(this))},r.prototype.globalAssetIds=function(){var t=[],e=this.configuration;for(var i in e)e.hasOwnProperty(i)&&e[i].global&&t.push(i);return t},r.prototype.requestAsset=function(t,e){var r,s="string"==typeof t?t:t.id,n=!1;if(this._assets.hasOwnProperty(s))++this._refCounts[s],e._onAssetLoad(this._assets[s]);else if(this._loadings.hasOwnProperty(s))r=this._loadings[s],r.handlers.push(e),++this._refCounts[s],n=!0;else{var o=this._createAssetFor(t);r=new i(o,e),this._loadings[s]=r,this._refCounts[s]=1,n=!0,r.loading=!0,o._load(this)}return n},r.prototype.unrefAsset=function(t){var e="string"==typeof t?t:t.id;--this._refCounts[e]>0||this._releaseAsset(e)},r.prototype.requestAssets=function(t,e){for(var i=0,r=0,s=t.length;r<s;++r)this.requestAsset(t[r],e)&&++i;return i},r.prototype.unrefAssets=function(t){for(var e=0,i=t.length;e<i;++e)this.unrefAsset(t[e])},r.prototype._normalize=function(e,i){var r={};if(!(e instanceof Object))throw t.ExceptionFactory.createAssertionError("AssetManager#_normalize: invalid arguments.");for(var s in e)if(e.hasOwnProperty(s)){var n=Object.create(e[s]);if(!n.path)throw t.ExceptionFactory.createAssertionError("AssetManager#_normalize: No path given for: "+s);if(!n.virtualPath)throw t.ExceptionFactory.createAssertionError("AssetManager#_normalize: No virtualPath given for: "+s);if(!n.type)throw t.ExceptionFactory.createAssertionError("AssetManager#_normalize: No type given for: "+s);if("image"===n.type){if("number"!=typeof n.width)throw t.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the image asset: "+s);if("number"!=typeof n.height)throw t.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the image asset: "+s)}if("audio"===n.type){void 0===n.duration&&(n.duration=0);var o=i[n.systemId];void 0===n.loop&&(n.loop=!!o&&!!o.loop),void 0===n.hint&&(n.hint=o?o.hint:{})}if("video"===n.type&&!n.useRealSize){if("number"!=typeof n.width)throw t.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the video asset: "+s);if("number"!=typeof n.height)throw t.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the video asset: "+s);n.useRealSize=!1}n.global||(n.global=!1),r[s]=n}return r},r.prototype._createAssetFor=function(e){var i,r,s;if("string"==typeof e)i=e,s=this.configuration[i],r=this.configuration[i].path;else{var n=e;i=n.id,s=n,r=n.uri}var o=this.game.resourceFactory;if(!s)throw t.ExceptionFactory.createAssertionError("AssetManager#_createAssetFor: unknown asset ID: "+i);switch(s.type){case"image":return o.createImageAsset(i,r,s.width,s.height);case"audio":var a=s.systemId?this.game.audio[s.systemId]:this.game.audio[this.game.defaultAudioSystemId];return o.createAudioAsset(i,r,s.duration,a,s.loop,s.hint);case"text":return o.createTextAsset(i,r);case"script":return o.createScriptAsset(i,r);case"video":return o.createVideoAsset(i,r,s.width,s.height,new t.VideoSystem,s.loop,s.useRealSize);default:throw t.ExceptionFactory.createAssertionError("AssertionError#_createAssetFor: unknown asset type "+s.type+" for asset ID: "+i)}},r.prototype._releaseAsset=function(e){var i,r=this._assets[e]||this._loadings[e]&&this._loadings[e].asset;if(r)if(i=r.path,r.inUse())if(r instanceof t.AudioAsset)r._system.requestDestroy(r);else{if(!(r instanceof t.VideoAsset))throw t.ExceptionFactory.createAssertionError("AssetManager#unrefAssets: Unsupported in-use "+r.id);r.destroy()}else r.destroy();if(delete this._refCounts[e],delete this._loadings[e],delete this._assets[e],this.configuration[e]){var s=this.configuration[e].virtualPath;s&&this._liveAssetVirtualPathTable.hasOwnProperty(s)&&delete this._liveAssetVirtualPathTable[s],i&&this._liveAbsolutePathTable.hasOwnProperty(i)&&delete this._liveAbsolutePathTable[i]}},r.prototype._countLoadingAsset=function(){return Object.keys(this._loadings).length},r.prototype._onAssetError=function(e,i){if(!this.destroyed()&&!e.destroyed()){var s=this._loadings[e.id],n=s.handlers;s.loading=!1,++s.errorCount,s.errorCount>r.MAX_ERROR_COUNT&&i.retriable&&(i=t.ExceptionFactory.createAssetLoadError("Retry limit exceeded",!1,t.AssetLoadErrorType.RetryLimitExceeded,i)),i.retriable||delete this._loadings[e.id];for(var o=0;o<n.length;++o)n[o]._onAssetError(e,i,this)}},r.prototype._onAssetLoad=function(e){if(!this.destroyed()&&!e.destroyed()){var i=this._loadings[e.id];if(i.loading=!1,delete this._loadings[e.id],this._assets[e.id]=e,this.configuration[e.id]){var r=this.configuration[e.id].virtualPath;if(this._liveAssetVirtualPathTable.hasOwnProperty(r)){if(this._liveAssetVirtualPathTable[r].path!==e.path)throw t.ExceptionFactory.createAssertionError("AssetManager#_onAssetLoad(): duplicated asset path")}else this._liveAssetVirtualPathTable[r]=e;this._liveAbsolutePathTable.hasOwnProperty(e.path)||(this._liveAbsolutePathTable[e.path]=r)}for(var s=i.handlers,n=0;n<s.length;++n)s[n]._onAssetLoad(e)}},r}();r.MAX_ERROR_COUNT=3,t.AssetManager=r}(t||(t={}));var t;!function(t){function e(e,i,r){var s,n,o,a=r?r._dirname:e.assetBase,h=e._assetManager._liveAssetVirtualPathTable,d=e._assetManager._moduleMainScripts;if(-1===i.indexOf("/")&&e._assetManager._assets.hasOwnProperty(i)&&(s=e._assetManager._assets[i]),/^\.\/|^\.\.\/|^\//.test(i)){if(n=t.PathUtil.resolvePath(a,i),e._scriptCaches.hasOwnProperty(n))return e._scriptCaches[n]._cachedValue();if(e._scriptCaches.hasOwnProperty(n+".js"))return e._scriptCaches[n+".js"]._cachedValue();if(r){if(!r._virtualDirname)throw t.ExceptionFactory.createAssertionError("g._require: require from DynamicAsset is not supported");o=t.PathUtil.resolvePath(r._virtualDirname,i)}else{if("./"!==i.substring(0,2))throw t.ExceptionFactory.createAssertionError("g._require: entry point must start with './'");o=i.substring(2)}s||(s=t.Util.findAssetByPathAsFile(o,h)),s||(s=t.Util.findAssetByPathAsDirectory(o,h))}else if(d[i]&&(s=e._assetManager._liveAssetVirtualPathTable[d[i]]),!s){var c=r?r.paths:[];c.push("node_modules");for(var l=0;l<c.length;++l){var u=c[l];if(o=t.PathUtil.resolvePath(u,i),s=t.Util.findAssetByPathAsFile(o,h))break;if(s=t.Util.findAssetByPathAsDirectory(o,h))break}}if(s){if(e._scriptCaches.hasOwnProperty(s.path))return e._scriptCaches[s.path]._cachedValue();if(s instanceof t.ScriptAsset){var p=new t.ScriptAssetContext(e,s);return e._scriptCaches[s.path]=p,p._executeScript(r)}if(s instanceof t.TextAsset&&s&&".json"===t.PathUtil.resolveExtname(i)){return(e._scriptCaches[s.path]=new t.RequireCachedValue(JSON.parse(s.data)))._cachedValue()}}throw t.ExceptionFactory.createAssertionError("g._require: can not find module: "+i)}t._require=e;var i=function(){function e(e,i,r){var s=this,n=t.PathUtil.resolveDirname(r),o=e._assetManager._liveAbsolutePathTable[r],a=o?t.PathUtil.resolveDirname(o):void 0,h=Object.create(t,{game:{value:e,enumerable:!0},filename:{value:r,enumerable:!0},dirname:{value:n,enumerable:!0},module:{value:this,writable:!0,enumerable:!0,configurable:!0}});this.id=i,this.filename=r,this.exports={},this.parent=null,this.loaded=!1,this.children=[],this.paths=a?t.PathUtil.makeNodeModulePaths(a):[],this._dirname=n,this._virtualDirname=a,this._g=h,this.require=function(i){return"g"===i?h:t._require(e,i,s)}}return e}();t.Module=i}(t||(t={}));var t;!function(t){var e=function(){function e(e,i){this._game=e,this._asset=i,this._module=new t.Module(e,i.path,i.path),this._g=this._module._g,this._started=!1}return e.prototype._cachedValue=function(){if(!this._started)throw t.ExceptionFactory.createAssertionError("ScriptAssetContext#_cachedValue: not executed yet.");return this._module.exports},e.prototype._executeScript=function(t){return this._started?this._module.exports:(t&&(this._module.parent=t,t.children.push(this._module)),this._started=!0,this._asset.execute(this._g),this._module.loaded=!0,this._module.exports)},e}();t.ScriptAssetContext=e}(t||(t={}));var t;!function(t){var e=function(){function t(t,e,i,r,s){void 0===t?(this._modified=!1,this._matrix=[1,0,0,1,0,0]):"number"==typeof t?(this._modified=!1,this._matrix=new Array(6),this.update(t,e,i,r,s,0,0)):(this._modified=t._modified,this._matrix=[t._matrix[0],t._matrix[1],t._matrix[2],t._matrix[3],t._matrix[4],t._matrix[5]])}return t.prototype.update=function(t,e,i,r,s,n,o){var a=s*Math.PI/180,h=Math.cos(a),d=Math.sin(a),c=h*i,l=d*i,u=d*r,p=h*r,f=t/2,g=e/2;this._matrix[0]=c,this._matrix[1]=l,this._matrix[2]=-u,this._matrix[3]=p,this._matrix[4]=-c*f+u*g+f+n,this._matrix[5]=-l*f-p*g+g+o},t.prototype.updateByInverse=function(t,e,i,r,s,n,o){var a=s*Math.PI/180,h=Math.cos(a),d=Math.sin(a),c=h/i,l=d/r,u=d/i,p=h/r,f=t/2,g=e/2;this._matrix[0]=c,this._matrix[1]=-l,this._matrix[2]=u,this._matrix[3]=p,this._matrix[4]=-c*(f+n)-u*(g+o)+f,this._matrix[5]=l*(f+n)-p*(g+o)+g},t.prototype.multiply=function(t){var e=this._matrix,i=t._matrix,r=e[0],s=e[1],n=e[2],o=e[3];e[0]=r*i[0]+n*i[1],e[1]=s*i[0]+o*i[1],e[2]=r*i[2]+n*i[3],e[3]=s*i[2]+o*i[3],e[4]=r*i[4]+n*i[5]+e[4],e[5]=s*i[4]+o*i[5]+e[5]},t.prototype.multiplyNew=function(t){var e=this.clone();return e.multiply(t),e},t.prototype.reset=function(t,e){this._matrix[0]=1,this._matrix[1]=0,this._matrix[2]=0,this._matrix[3]=1,this._matrix[4]=t||0,this._matrix[5]=e||0},t.prototype.clone=function(){return new t(this)},t.prototype.multiplyInverseForPoint=function(t){var e=this._matrix,i=1/(e[0]*e[3]+e[2]*-e[1]);return{x:e[3]*i*t.x+-e[2]*i*t.y+(e[5]*e[2]-e[4]*e[3])*i,y:e[0]*i*t.y+-e[1]*i*t.x+(-e[5]*e[0]+e[4]*e[1])*i}},t.prototype.scale=function(t,e){var i=this._matrix;i[0]*=t,i[1]*=e,i[2]*=t,i[3]*=e,i[4]*=t,i[5]*=e},t.prototype.multiplyPoint=function(t){var e=this._matrix;return{x:e[0]*t.x+e[2]*t.y+e[4],y:e[1]*t.x+e[3]*t.y+e[5]}},t}();t.PlainMatrix=e}(t||(t={}));var t;!function(t){!function(e){function i(t,e,i,r){return Math.sqrt(Math.pow(t-i,2)+Math.pow(e-r,2))}function r(t,i){return e.distance(t.x,t.y,i.x,i.y)}function s(t,i){return e.distance(t.x-t.width/2,t.y-t.height/2,i.x-i.width/2,i.y-i.height/2)}function n(e,i,r,s,n){return void 0===e?new t.PlainMatrix:new t.PlainMatrix(e,i,r,s,n)}function o(e,i,r){var s=i.x,n=i.y,o=0,a=0,h=i.width,d=i.height,c=i.calculateBoundingRect(r);if(!c)throw t.ExceptionFactory.createAssertionError("Util#createSpriteFromE: camera must look e");h=c.right-c.left,d=c.bottom-c.top,c.left<i.x&&(o=i.x-c.left),c.top<i.y&&(a=i.y-c.top),i.moveTo(o,a),i._matrix&&(i._matrix._modified=!0);var l=e.game.resourceFactory.createSurface(Math.ceil(h),Math.ceil(d)),u=l.renderer();u.begin(),i.render(u,r),u.end();var p=new t.Sprite({scene:e,src:l,width:h,height:d});return p.moveTo(c.left,c.top),i.moveTo(s,n),i._matrix&&(i._matrix._modified=!0),p}function a(e,i,r){var s=e.game.resourceFactory.createSurface(Math.ceil(i.game.width),Math.ceil(i.game.height)),n=s.renderer();n.begin();for(var o=i.children,a=0;a<o.length;++a)o[a].render(n,r);return n.end(),new t.Sprite({scene:e,src:s,width:i.game.width,height:i.game.height})}function h(e){if(!e)return e;if(e instanceof t.Surface)return e;if(e instanceof t.ImageAsset)return e.asSurface();throw t.ExceptionFactory.createTypeMismatchError("Util#asSurface","ImageAsset|Surface",e)}function d(t,e){return e.hasOwnProperty(t)?e[t]:e.hasOwnProperty(t+".js")?e[t+".js"]:void 0}function c(i,r){var s;if(s=i+"/package.json",r.hasOwnProperty(s)&&r[s]instanceof t.TextAsset){var n=JSON.parse(r[s].data);if(n&&"string"==typeof n.main){var o=e.findAssetByPathAsFile(t.PathUtil.resolvePath(i,n.main),r);if(o)return o}}if(s=i+"/index.js",r.hasOwnProperty(s))return r[s]}function l(t,e){var i=t.charCodeAt(e);if(55296<=i&&i<=56319){return i<<16|t.charCodeAt(e+1)}return 56320<=i&&i<=57343?null:i}function u(t,e){e.isDynamic&&(e.animatingStarted.add(t._onAnimatingStarted,t),e.animatingStopped.add(t._onAnimatingStopped,t),e.isPlaying()&&t._onAnimatingStarted())}function p(t,e,i){t._onAnimatingStopped(),!e.destroyed()&&e.isDynamic&&(e.animatingStarted.remove(t._onAnimatingStarted,t),e.animatingStopped.remove(t._onAnimatingStopped,t)),i.isDynamic&&(i.animatingStarted.add(t._onAnimatingStarted,t),i.animatingStopped.add(t._onAnimatingStopped,t),i.isPlaying()&&t._onAnimatingStarted())}e.distance=i,e.distanceBetweenOffsets=r,e.distanceBetweenAreas=s,e.createMatrix=n,e.createSpriteFromE=o,e.createSpriteFromScene=a,e.asSurface=h,e.findAssetByPathAsFile=d,e.findAssetByPathAsDirectory=c,e.charCodeAt=l,e.setupAnimatingHandler=u,e.migrateAnimatingHandler=p}(t.Util||(t.Util={}))}(t||(t={}));var t;!function(t){!function(e){function i(t,e,i,r,s,n,o,a){return t<=s+o&&s<=t+i&&e<=n+a&&n<=e+r}function r(t,i){return e.intersect(t.x,t.y,t.width,t.height,i.x,i.y,i.width,i.height)}function s(e,i,r,s,n){return void 0===n&&(n=1),n>=t.Util.distance(e,i,r,s)}function n(e,i,r){return void 0===r&&(r=1),r>=t.Util.distanceBetweenAreas(e,i)}e.intersect=i,e.intersectAreas=r,e.within=s,e.withinAreas=n}(t.Collision||(t.Collision={}))}(t||(t={}));var t;!function(t){var i=function(){function t(){this._handlers=[],this.length=0}return t.prototype.add=function(t,e){if("function"==typeof t)this._handlers.push({func:t,owner:e,once:!1,name:void 0});else{var i=t;"number"==typeof i.index?this._handlers.splice(i.index,0,{func:i.func,owner:i.owner,once:!1,name:i.name}):this._handlers.push({func:i.func,owner:i.owner,once:!1,name:i.name})}this.length=this._handlers.length},t.prototype.addOnce=function(t,e){if("function"==typeof t)this._handlers.push({func:t,owner:e,once:!0,name:void 0});else{var i=t;"number"==typeof i.index?this._handlers.splice(i.index,0,{func:i.func,owner:i.owner,once:!0,name:i.name}):this._handlers.push({func:i.func,owner:i.owner,once:!0,name:i.name})}this.length=this._handlers.length},t.prototype.handle=function(t,e,i){this.add(e?{owner:t,func:e,name:i}:{func:t})},t.prototype.fire=function(t){if(this._handlers.length){for(var e=this._handlers.concat(),i=0;i<e.length;i++){var r=e[i];if(r.func.call(r.owner,t)||r.once){var s=this._handlers.indexOf(r);-1!==s&&this._handlers.splice(s,1)}}this._handlers&&(this.length=this._handlers.length)}},t.prototype.contains=function(t,e){for(var i="function"==typeof t?{func:t,owner:e}:t,r=0;r<this._handlers.length;r++)if(this._comparePartial(i,this._handlers[r]))return!0;return!1},t.prototype.remove=function(t,e){for(var i="function"==typeof t?{func:t,owner:e}:t,r=0;r<this._handlers.length;r++){var s=this._handlers[r];if(i.func===s.func&&i.owner===s.owner&&i.name===s.name)return this._handlers.splice(r,1),void--this.length}},t.prototype.removeAll=function(t){var e=[];if(t)for(var i=0;i<this._handlers.length;i++){var r=this._handlers[i];this._comparePartial(t,r)||e.push(r)}this._handlers=e,this.length=this._handlers.length},t.prototype.destroy=function(){this._handlers=null,this.length=null},t.prototype.destroyed=function(){return null===this._handlers},t.prototype._comparePartial=function(t,e){return(void 0===t.func||t.func===e.func)&&((void 0===t.owner||t.owner===e.owner)&&(void 0===t.name||t.name===e.name))},t}();t.Trigger=i;var r=function(t){function i(e,i,r){var s=t.call(this)||this;return s.chain=e,s.filter=i,s.filterOwner=r,s._isActivated=!1,s}return e(i,t),i.prototype.add=function(e,i){t.prototype.add.call(this,e,i),this._isActivated||(this.chain.add(this._onChainTriggerFired,this),this._isActivated=!0)},i.prototype.addOnce=function(e,i){t.prototype.addOnce.call(this,e,i),this._isActivated||(this.chain.add(this._onChainTriggerFired,this),this._isActivated=!0)},i.prototype.remove=function(e,i){t.prototype.remove.call(this,e,i),0===this.length&&this._isActivated&&(this.chain.remove(this._onChainTriggerFired,this),this._isActivated=!1)},i.prototype.removeAll=function(e){t.prototype.removeAll.call(this,e),0===this.length&&this._isActivated&&(this.chain.remove(this._onChainTriggerFired,this),this._isActivated=!1)},i.prototype.destroy=function(){t.prototype.destroy.call(this),this.chain.remove(this._onChainTriggerFired,this),this.filter=null,this.filterOwner=null,this._isActivated=!1},i.prototype._onChainTriggerFired=function(t){this.filter&&!this.filter.call(this.filterOwner,t)||this.fire(t)},i}(i);t.ChainTrigger=r}(t||(t={}));var t;!function(t){var e=function(){function e(e,i){this.interval=e,this._scaledInterval=Math.round(e*i),this.elapsed=new t.Trigger,this._scaledElapsed=0}return e.prototype.tick=function(){for(this._scaledElapsed+=1e3;this._scaledElapsed>=this._scaledInterval&&this.elapsed;)this.elapsed.fire(),this._scaledElapsed-=this._scaledInterval},e.prototype.canDelete=function(){return!this.elapsed||0===this.elapsed.length},e.prototype.destroy=function(){this.interval=void 0,this.elapsed.destroy(),this.elapsed=void 0,this._scaledInterval=0,this._scaledElapsed=0},e.prototype.destroyed=function(){return void 0===this.elapsed},e}();t.Timer=e}(t||(t={}));var t;!function(t){var e=function(){function t(t,e,i,r,s){this._timer=t,this._handler=e,this._handlerOwner=i,this._fired=r,this._firedOwner=s,this._timer.elapsed.add(this._fire,this)}return t.prototype.destroy=function(){this._timer.elapsed.remove(this._fire,this),this._timer=void 0,this._handler=void 0,this._handlerOwner=void 0,this._fired=void 0,this._firedOwner=void 0},t.prototype.destroyed=function(){return void 0===this._timer},t.prototype._fire=function(){this._handler.call(this._handlerOwner),this._fired&&this._fired.call(this._firedOwner,this)},t}();t.TimerIdentifier=e;var i=function(){function i(t,e){this._timers=[],this._trigger=t,this._identifiers=[],this._fps=e,this._registered=!1}return i.prototype.destroy=function(){for(var t=0;t<this._identifiers.length;++t)this._identifiers[t].destroy();for(var t=0;t<this._timers.length;++t)this._timers[t].destroy();this._timers=void 0,this._trigger=void 0,this._identifiers=void 0,this._fps=void 0},i.prototype.destroyed=function(){return void 0===this._timers},i.prototype.createTimer=function(e){if(this._registered||(this._trigger.add(this._tick,this),this._registered=!0),e<0)throw t.ExceptionFactory.createAssertionError("TimerManager#createTimer: invalid interval");e<1&&(e=1);for(var i=Math.min(1e3,e*this._fps),r=0;r<this._timers.length;++r)if(this._timers[r].interval===e&&this._timers[r]._scaledElapsed<i)return this._timers[r];var s=new t.Timer(e,this._fps);return this._timers.push(s),s},i.prototype.deleteTimer=function(e){if(e.canDelete()){var i=this._timers.indexOf(e);if(i<0)throw t.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: can not find timer");if(this._timers.splice(i,1),e.destroy(),!this._timers.length){if(!this._registered)throw t.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: handler is not handled");this._trigger.remove(this._tick,this),this._registered=!1}}},i.prototype.setTimeout=function(t,i,r){var s=this.createTimer(i),n=new e(s,t,r,this._onTimeoutFired,this);return this._identifiers.push(n),n},i.prototype.clearTimeout=function(t){this._clear(t)},i.prototype.setInterval=function(t,i,r){var s=this.createTimer(i),n=new e(s,t,r);return this._identifiers.push(n),n},i.prototype.clearInterval=function(t){this._clear(t)},i.prototype._tick=function(){for(var t=this._timers.concat(),e=0;e<t.length;++e)t[e].tick()},i.prototype._onTimeoutFired=function(e){var i=this._identifiers.indexOf(e);if(i<0)throw t.ExceptionFactory.createAssertionError("TimerManager#_onTimeoutFired: can not find identifier");this._identifiers.splice(i,1);var r=e._timer;e.destroy(),this.deleteTimer(r)},i.prototype._clear=function(e){var i=this._identifiers.indexOf(e);if(i<0)throw t.ExceptionFactory.createAssertionError("TimerManager#_clear: can not find identifier");if(e.destroyed())throw t.ExceptionFactory.createAssertionError("TimerManager#_clear: invalid identifier");this._identifiers.splice(i,1);var r=e._timer;e.destroy(),this.deleteTimer(r)},i}();t.TimerManager=i}(t||(t={}));var t;!function(t){var e=function(){function e(e){this.played=new t.Trigger,this.stopped=new t.Trigger,this.currentAudio=void 0,this.volume=e.volume,this._muted=e._muted,this._playbackRate=e._playbackRate,this._system=e}return e.prototype.play=function(t){this.currentAudio=t,this.played.fire({player:this,audio:t})},e.prototype.stop=function(){var t=this.currentAudio;this.currentAudio=void 0,this.stopped.fire({player:this,audio:t})},e.prototype.canHandleStopped=function(){return!0},e.prototype.changeVolume=function(t){this.volume=t},e.prototype._changeMuted=function(t){this._muted=t},e.prototype._changePlaybackRate=function(t){this._playbackRate=t},e.prototype._supportsPlaybackRate=function(){return!1},e.prototype._onVolumeChanged=function(){},e}();t.AudioPlayer=e}(t||(t={}));var t;!function(t){var i=function(){function e(t,e){var i=e._audioSystemManager;this.id=t,this.game=e,this._volume=1,this._destroyRequestedAssets={},this._muted=i._muted,this._playbackRate=i._playbackRate}return Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(e){if(e<0||e>1||isNaN(e)||"number"!=typeof e)throw t.ExceptionFactory.createAssertionError("AudioSystem#volume: expected: 0.0-1.0, actual: "+e);this._volume=e,this._onVolumeChanged()},enumerable:!0,configurable:!0}),e.prototype.requestDestroy=function(t){this._destroyRequestedAssets[t.id]=t},e.prototype._setMuted=function(t){var e=this._muted;this._muted=!!t,this._muted!==e&&this._onMutedChanged()},e.prototype._setPlaybackRate=function(e){if(e<0||isNaN(e)||"number"!=typeof e)throw t.ExceptionFactory.createAssertionError("AudioSystem#playbackRate: expected: greater or equal to 0.0, actual: "+e);var i=this._playbackRate;this._playbackRate=e,this._playbackRate!==i&&this._onPlaybackRateChanged()},e}();t.AudioSystem=i;var r=function(i){function r(t,e){var r=i.call(this,t,e)||this;return r._player=void 0,r._suppressingAudio=void 0,r}return e(r,i),Object.defineProperty(r.prototype,"player",{get:function(){return this._player||(this._player=this.game.resourceFactory.createAudioPlayer(this),this._player.played.handle(this,this._onPlayerPlayed),this._player.stopped.handle(this,this._onPlayerStopped)),this._player},set:function(t){this._player=t},enumerable:!0,configurable:!0}),r.prototype.findPlayers=function(t){return this.player.currentAudio&&this.player.currentAudio.id===t.id?[this.player]:[]},r.prototype.createPlayer=function(){return this.player},r.prototype.stopAll=function(){this._player&&this._player.stop()},r.prototype._onVolumeChanged=function(){this.player.changeVolume(this._volume)},r.prototype._onMutedChanged=function(){this.player._changeMuted(this._muted)},r.prototype._onPlaybackRateChanged=function(){var t=this.player;t._changePlaybackRate(this._playbackRate),t._supportsPlaybackRate()||this._onUnsupportedPlaybackRateChanged()},r.prototype._onUnsupportedPlaybackRateChanged=function(){if(1===this._playbackRate&&this._suppressingAudio){var t=this._suppressingAudio;this._suppressingAudio=void 0,t.destroyed()||this.player.play(t)}},r.prototype._onPlayerPlayed=function(e){if(e.player!==this._player)throw t.ExceptionFactory.createAssertionError("MusicAudioSystem#_onPlayerPlayed: unexpected audio player");e.player._supportsPlaybackRate()||1!==this._playbackRate&&(e.player.stop(),this._suppressingAudio=e.audio)},r.prototype._onPlayerStopped=function(t){this._destroyRequestedAssets[t.audio.id]&&(delete this._destroyRequestedAssets[t.audio.id],t.audio.destroy())},r}(i);t.MusicAudioSystem=r;var s=function(t){function i(e,i){var r=t.call(this,e,i)||this;return r.players=[],r}return e(i,t),i.prototype.createPlayer=function(){var t=this.game.resourceFactory.createAudioPlayer(this);return t.canHandleStopped()&&this.players.push(t),t.played.handle(this,this._onPlayerPlayed),t.stopped.handle(this,this._onPlayerStopped),t},i.prototype.findPlayers=function(t){for(var e=[],i=0;i<this.players.length;++i)this.players[i].currentAudio&&this.players[i].currentAudio.id===t.id&&e.push(this.players[i]);return e},i.prototype.stopAll=function(){for(var t=this.players.concat(),e=0;e<t.length;++e)t[e].stop()},i.prototype._onMutedChanged=function(){for(var t=this.players,e=0;e<t.length;++e)t[e]._changeMuted(this._muted)},i.prototype._onPlaybackRateChanged=function(){for(var t=this.players,e=0;e<t.length;++e)t[e]._changePlaybackRate(this._playbackRate)},i.prototype._onPlayerPlayed=function(t){t.player._supportsPlaybackRate()||1!==this._playbackRate&&t.player.stop()},i.prototype._onPlayerStopped=function(t){var e=this.players.indexOf(t.player);e<0||(t.player.stopped.remove({owner:this,func:this._onPlayerStopped}),this.players.splice(e,1),this._destroyRequestedAssets[t.audio.id]&&(delete this._destroyRequestedAssets[t.audio.id],t.audio.destroy()))},i.prototype._onVolumeChanged=function(){for(var t=0;t<this.players.length;++t)this.players[t].changeVolume(this._volume)},i}(i);t.SoundAudioSystem=s}(t||(t={}));var t;!function(t){var e=function(){function e(e){this._loop=!!e,this.played=new t.Trigger,this.stopped=new t.Trigger,this.currentVideo=void 0,this.volume=1}return e.prototype.play=function(t){this.currentVideo=t,this.played.fire({player:this,video:t}),t.asSurface().animatingStarted.fire()},e.prototype.stop=function(){var t=this.currentVideo;this.stopped.fire({player:this,video:t}),t.asSurface().animatingStopped.fire()},e.prototype.changeVolume=function(t){this.volume=t},e}();t.VideoPlayer=e}(t||(t={}));var t;!function(t){var e=function(){function t(){}return t}();t.VideoSystem=e}(t||(t={}));var t;!function(t){var e=function(){function e(t){t?(this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.opacity="opacity"in t?t.opacity:1,this.scaleX="scaleX"in t?t.scaleX:1,this.scaleY="scaleY"in t?t.scaleY:1,this.angle=t.angle||0,this.compositeOperation=t.compositeOperation,this._matrix=void 0):(this.x=0,this.y=0,this.width=0,this.height=0,this.opacity=1,this.scaleX=1,this.scaleY=1,this.angle=0,this.compositeOperation=void 0,this._matrix=void 0)}return e.prototype.moveTo=function(e,i){if("number"==typeof e&&"number"!=typeof i)throw t.ExceptionFactory.createAssertionError("Object2D#moveTo: arguments must be CommonOffset or pair of x and y as a number.");"number"==typeof e?(this.x=e,this.y=i):(this.x=e.x,this.y=e.y)},e.prototype.moveBy=function(t,e){this.x+=t,this.y+=e},e.prototype.resizeTo=function(e,i){if("number"==typeof e&&"number"!=typeof i)throw t.ExceptionFactory.createAssertionError("Object2D#resizeTo: arguments must be CommonSize or pair of width and height as a number.");"number"==typeof e?(this.width=e,this.height=i):(this.width=e.width,this.height=e.height)},e.prototype.resizeBy=function(t,e){this.width+=t,this.height+=e},e.prototype.scale=function(t){this.scaleX=t,this.scaleY=t},e.prototype.getMatrix=function(){if(this._matrix){if(!this._matrix._modified)return this._matrix}else this._matrix=t.Util.createMatrix();return this._updateMatrix(),this._matrix._modified=!1,this._matrix},e.prototype._updateMatrix=function(){this.angle||1!==this.scaleX||1!==this.scaleY?this._matrix.update(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y):this._matrix.reset(this.x,this.y)},e}();t.Object2D=e}(t||(t={}));var t;!function(t){var i=function(i){function r(e){
var r=i.call(this,e)||this;if(r.children=void 0,r.parent=void 0,r._touchable=!1,r.state=0,r._hasTouchableChildren=!1,r._update=void 0,r._message=void 0,r._pointDown=void 0,r._pointMove=void 0,r._pointUp=void 0,r._targetCameras=void 0,r.tag=e.tag,r.local=e.scene.local!==t.LocalTickMode.NonLocal||!!e.local,e.children)for(var s=0;s<e.children.length;++s)r.append(e.children[s]);return e.parent&&e.parent.append(r),e.targetCameras&&(r.targetCameras=e.targetCameras),"touchable"in e&&(r.touchable=e.touchable),e.hidden&&r.hide(),r.id=e.id,e.scene.register(r),r}return e(r,i),Object.defineProperty(r.prototype,"update",{get:function(){return this._update||(this._update=new t.ChainTrigger(this.scene.update)),this._update},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"message",{get:function(){return this._message||(this._message=new t.ChainTrigger(this.scene.message)),this._message},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointDown",{get:function(){return this._pointDown||(this._pointDown=new t.ChainTrigger(this.scene.pointDownCapture,this._isTargetOperation,this)),this._pointDown},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointUp",{get:function(){return this._pointUp||(this._pointUp=new t.ChainTrigger(this.scene.pointUpCapture,this._isTargetOperation,this)),this._pointUp},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointMove",{get:function(){return this._pointMove||(this._pointMove=new t.ChainTrigger(this.scene.pointMoveCapture,this._isTargetOperation,this)),this._pointMove},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"targetCameras",{get:function(){return this._targetCameras||(this._targetCameras=[])},set:function(t){this._targetCameras=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"touchable",{get:function(){return this._touchable},set:function(t){this._touchable!==t&&(this._touchable=t,t?this._enableTouchPropagation():this._disableTouchPropagation())},enumerable:!0,configurable:!0}),r.prototype.render=function(t,e){if(this.state&=-5,!(1&this.state)){var i=this._targetCameras;if(!(i&&i.length>0)||e&&-1!==i.indexOf(e)){if(8&this.state){t.translate(this.x,this.y);var r=this.renderSelf(t,e);if(r&&this.children)for(var s=this.children,n=s.length,o=0;o<n;++o)s[o].render(t,e);return void t.translate(-this.x,-this.y)}t.save(),this.angle||1!==this.scaleX||1!==this.scaleY?t.transform(this.getMatrix()._matrix):t.translate(this.x,this.y),1!==this.opacity&&t.opacity(this.opacity),void 0!==this.compositeOperation&&t.setCompositeOperation(this.compositeOperation);var r=this.renderSelf(t,e);if(r&&this.children)for(var s=this.children,o=0;o<s.length;++o)s[o].render(t,e);t.restore()}}},r.prototype.renderSelf=function(t,e){return!0},r.prototype.game=function(){return this.scene.game},r.prototype.append=function(t){this.insertBefore(t,void 0)},r.prototype.insertBefore=function(t,e){t.parent&&t.remove(),this.children||(this.children=[]),t.parent=this;var i=-1;void 0!==e&&(i=this.children.indexOf(e))>-1?this.children.splice(i,0,t):this.children.push(t),(t._touchable||t._hasTouchableChildren)&&(this._hasTouchableChildren=!0,this._enableTouchPropagation()),this.modified(!0)},r.prototype.remove=function(e){if(void 0===e)return void this.parent.remove(this);var i=this.children?this.children.indexOf(e):-1;if(i<0)throw t.ExceptionFactory.createAssertionError("E#remove: invalid child");this.children[i].parent=void 0,this.children.splice(i,1),(e._touchable||e._hasTouchableChildren)&&(this._findTouchableChildren(this)||(this._hasTouchableChildren=!1,this._disableTouchPropagation())),this.modified(!0)},r.prototype.destroy=function(){if(this.parent&&this.remove(),this.children){for(;this.children.length;)this.children[this.children.length-1].destroy();this.children=void 0}this._update&&(this._update.destroy(),this._update=void 0),this._message&&(this._message.destroy(),this._message=void 0),this._pointDown&&(this._pointDown.destroy(),this._pointDown=void 0),this._pointMove&&(this._pointMove.destroy(),this._pointMove=void 0),this._pointUp&&(this._pointUp.destroy(),this._pointUp=void 0),this.scene.unregister(this)},r.prototype.destroyed=function(){return void 0===this.scene},r.prototype.modified=function(t){this._matrix&&(this._matrix._modified=!0),this.angle||1!==this.scaleX||1!==this.scaleY||1!==this.opacity||void 0!==this.compositeOperation?this.state&=-9:this.state|=8,4&this.state||(this.state|=4,this.parent&&this.parent.modified(!0))},r.prototype.shouldFindChildrenByPoint=function(t){return!0},r.prototype.findPointSourceByPoint=function(t,e,i,r){if(!(1&this.state)){var s=this._targetCameras;if(!(s&&s.length>0)||r&&-1!==s.indexOf(r)){e=e?e.multiplyNew(this.getMatrix()):this.getMatrix().clone();var n=e.multiplyInverseForPoint(t);if((this._hasTouchableChildren||i&&this.children&&this.children.length)&&this.shouldFindChildrenByPoint(n))for(var o=this.children.length-1;o>=0;--o){var a=this.children[o];if(i||a._touchable||a._hasTouchableChildren){var h=a.findPointSourceByPoint(t,e,i,r);if(h)return h}}if(i||this._touchable)return 0<=n.x&&this.width>n.x&&0<=n.y&&this.height>n.y?{target:this,point:n}:void 0}}},r.prototype.visible=function(){return 1!=(1&this.state)},r.prototype.show=function(){1&this.state&&(this.state&=-2,this.parent&&this.parent.modified(!0))},r.prototype.hide=function(){1&this.state||(this.state|=1,this.parent&&this.parent.modified(!0))},r.prototype.calculateBoundingRect=function(t){return this._calculateBoundingRect(void 0,t)},r.prototype._calculateBoundingRect=function(t,e){var i=this.getMatrix();if(t&&(i=t.multiplyNew(i)),this.visible()&&(!e||this._targetCameras&&-1!==this._targetCameras.indexOf(e))){for(var r={left:0,right:this.width,top:0,bottom:this.height},s=[{x:r.left,y:r.top},{x:r.left,y:r.bottom},{x:r.right,y:r.top},{x:r.right,y:r.bottom}],n=i.multiplyPoint(s[0]),o={left:n.x,right:n.x,top:n.y,bottom:n.y},a=1;a<s.length;++a)n=i.multiplyPoint(s[a]),o.left>n.x&&(o.left=n.x),o.right<n.x&&(o.right=n.x),o.top>n.y&&(o.top=n.y),o.bottom<n.y&&(o.bottom=n.y);if(void 0!==this.children)for(var a=0;a<this.children.length;++a){var h=this.children[a]._calculateBoundingRect(i,e);h&&(o.left>h.left&&(o.left=h.left),o.right<h.right&&(o.right=h.right),o.top>h.top&&(o.top=h.top),o.bottom<h.bottom&&(o.bottom=h.bottom))}return o}},r.prototype._enableTouchPropagation=function(){for(var t=this.parent;t instanceof r&&!t._hasTouchableChildren;)t._hasTouchableChildren=!0,t=t.parent},r.prototype._disableTouchPropagation=function(){for(var t=this.parent;t instanceof r&&t._hasTouchableChildren&&!this._findTouchableChildren(t);)t._hasTouchableChildren=!1,t=t.parent},r.prototype._isTargetOperation=function(e){return!(1&this.state)&&(e instanceof t.PointEvent&&(this._touchable&&e.target===this))},r.prototype._findTouchableChildren=function(t){if(t.children)for(var e=0;e<t.children.length;++e){if(t.children[e].touchable)return t.children[e];var i=this._findTouchableChildren(t.children[e]);if(i)return i}},r}(t.Object2D);t.E=i}(t||(t={}));var t;!function(t){var i=function(t){function i(e){var i=t.call(this,e)||this;return i._shouldRenderChildren=!0,i._cache=void 0,i._renderer=void 0,i._renderedCamera=void 0,i}return e(i,t),i.prototype.invalidate=function(){this.state&=-3,this.modified()},i.prototype.renderSelf=function(t,e){if(this._renderedCamera!==e&&(this.state&=-3,this._renderedCamera=e),!(2&this.state)){this._cacheSize=this.calculateCacheSize();var i=!this._cache||this._cache.width<Math.ceil(this._cacheSize.width)||this._cache.height<Math.ceil(this._cacheSize.height);i&&(this._cache&&!this._cache.destroyed()&&this._cache.destroy(),this._cache=this.scene.game.resourceFactory.createSurface(Math.ceil(this._cacheSize.width),Math.ceil(this._cacheSize.height)),this._renderer=this._cache.renderer()),this._renderer.begin(),i||this._renderer.clear(),this.renderCache(this._renderer,e),this.state|=2,this._renderer.end()}return this._cache&&this._cacheSize.width>0&&this._cacheSize.height>0&&t.drawImage(this._cache,0,0,this._cacheSize.width,this._cacheSize.height,0,0),this._shouldRenderChildren},i.prototype.destroy=function(){this._cache&&!this._cache.destroyed()&&this._cache.destroy(),this._cache=void 0,t.prototype.destroy.call(this)},i.prototype.calculateCacheSize=function(){return{width:this.width,height:this.height}},i}(t.E);t.CacheableE=i}(t||(t={}));var t;!function(t){!function(t){t[t.Slots=1]="Slots",t[t.Scores=2]="Scores",t[t.Counts=3]="Counts",t[t.Values=4]="Values"}(t.StorageRegion||(t.StorageRegion={}));!function(t){t[t.Asc=0]="Asc",t[t.Desc=1]="Desc"}(t.StorageOrder||(t.StorageOrder={}));!function(t){t[t.Equal=1]="Equal",t[t.GreaterThan=2]="GreaterThan",t[t.LessThan=3]="LessThan"}(t.StorageCondition||(t.StorageCondition={}));!function(t){t[t.Incr=1]="Incr",t[t.Decr=2]="Decr"}(t.StorageCountsOperation||(t.StorageCountsOperation={}));var e=function(){function t(t,e){this._keys=t,this._values=e}return t.prototype.get=function(t){if(void 0===this._values)return[];if("number"==typeof t)return this._values[t];var e=this._keys.indexOf(t);if(-1!==e)return this._values[e];for(var i=0;i<this._keys.length;++i){var r=this._keys[i];if(r.region===t.region&&r.regionKey===t.regionKey&&r.userId===t.userId&&r.gameId===t.gameId)return this._values[i]}return[]},t.prototype.getOne=function(t){var e=this.get(t);if(e)return e[0]},t}();t.StorageValueStore=e;var i=function(){function t(t,i,r){this._loaded=!1,this._storage=t,this._valueStore=new e(i),this._handler=void 0,this._valueStoreSerialization=r}return t.prototype._load=function(t){this._handler=t,this._storage._load&&this._storage._load.call(this._storage,this._valueStore._keys,this,this._valueStoreSerialization)},t.prototype._onLoaded=function(t,e){this._valueStore._values=t,this._loaded=!0,e&&(this._valueStoreSerialization=e),this._handler&&this._handler._onStorageLoaded()},t.prototype._onError=function(t){this._handler&&this._handler._onStorageLoadError(t)},t}();t.StorageLoader=i;var r=function(){function t(t){this._game=t}return t.prototype.write=function(t,e,i){this._write&&this._write(t,e,i)},t.prototype.requestValuesForJoinPlayer=function(t){this._requestedKeysForJoinPlayer=t},t.prototype._createLoader=function(t,e){return new i(this,t,e)},t.prototype._registerWrite=function(t){this._write=t},t.prototype._registerLoad=function(t){this._load=t},t}();t.Storage=r}(t||(t={}));var t;!function(t){var e=function(){function e(t){this.waitingAssetsCount=t.assetIds.length,this._scene=t.scene,this._assetManager=t.assetManager,this._assetIds=t.assetIds,this._assets=[],this._handler=t.handler,this._handlerOwner=t.handlerOwner||null,this._direct=!!t.direct,this._requested=!1}return e.prototype.request=function(){return 0!==this.waitingAssetsCount&&(!!this._requested||(this._requested=!0,this._assetManager.requestAssets(this._assetIds,this),!0))},e.prototype.destroy=function(){this._requested&&this._assetManager.unrefAssets(this._assets),this.waitingAssetsCount=0,this._scene=void 0,this._assetIds=void 0,this._handler=void 0,this._requested=!1},e.prototype.destroyed=function(){return!this._scene},e.prototype.callHandler=function(){this._handler.call(this._handlerOwner)},e.prototype._onAssetError=function(t,e,i){if(!this.destroyed()&&!this._scene.destroyed()){var r={asset:t,error:e,cancelRetry:!1};this._scene.assetLoadFailed.fire(r),e.retriable&&!r.cancelRetry?this._assetManager.retryLoad(t):this._assetManager.configuration[t.id]&&this._scene.game.terminateGame(),this._scene.assetLoadCompleted.fire(t)}},e.prototype._onAssetLoad=function(e){if(!this.destroyed()&&!this._scene.destroyed()){if(this._scene.assets[e.id]=e,this._scene.assetLoaded.fire(e),this._scene.assetLoadCompleted.fire(e),this._assets.push(e),--this.waitingAssetsCount<0)throw t.ExceptionFactory.createAssertionError("SceneAssetHolder#_onAssetLoad: broken waitingAssetsCount");this.waitingAssetsCount>0||(this._direct?this.callHandler():this._scene.game._callSceneAssetHolderHandler(this))}},e}();t.SceneAssetHolder=e;var i;!function(t){t[t.Destroyed=0]="Destroyed",t[t.Standby=1]="Standby",t[t.Active=2]="Active",t[t.Deactive=3]="Deactive",t[t.BeforeDestroyed=4]="BeforeDestroyed"}(i=t.SceneState||(t.SceneState={}));var r;!function(t){t[t.Initial=0]="Initial",t[t.Ready=1]="Ready",t[t.ReadyFired=2]="ReadyFired",t[t.LoadedFired=3]="LoadedFired"}(r=t.SceneLoadState||(t.SceneLoadState={}));var s=function(){function s(s){var n,o,a,h;n=s.game,h=s.assetIds,s.storageKeys?(this._storageLoader=n.storage._createLoader(s.storageKeys,s.storageValuesSerialization),this.storageValues=this._storageLoader._valueStore):(this._storageLoader=void 0,this.storageValues=void 0),o=void 0===s.local?t.LocalTickMode.NonLocal:!1===s.local?t.LocalTickMode.NonLocal:!0===s.local?t.LocalTickMode.FullLocal:s.local,a=void 0!==s.tickGenerationMode?s.tickGenerationMode:t.TickGenerationMode.ByClock,this.name=s.name,h||(h=[]),this.game=n,this.local=o,this.tickGenerationMode=a,this.loaded=new t.Trigger,this._ready=new t.Trigger,this.assets={},this._loaded=!1,this._prefetchRequested=!1,this._loadingState=r.Initial,this.update=new t.Trigger,this._timer=new t.TimerManager(this.update,this.game.fps),this.assetLoaded=new t.Trigger,this.assetLoadFailed=new t.Trigger,this.assetLoadCompleted=new t.Trigger,this.message=new t.Trigger,this.pointDownCapture=new t.Trigger,this.pointMoveCapture=new t.Trigger,this.pointUpCapture=new t.Trigger,this.operation=new t.Trigger,this.children=[],this.state=i.Standby,this.stateChanged=new t.Trigger,this._assetHolders=[],this._sceneAssetHolder=new e({scene:this,assetManager:this.game._assetManager,assetIds:h,handler:this._onSceneAssetsLoad,handlerOwner:this,direct:!0})}return s.prototype.modified=function(t){this.game.modified=!0},s.prototype.destroy=function(){this.state=i.BeforeDestroyed,this.stateChanged.fire(this.state);var t=this.game.db;for(var e in t)t.hasOwnProperty(e)&&t[e].scene===this&&t[e].destroy();var t=this.game._localDb;for(var e in t)t.hasOwnProperty(e)&&t[e].scene===this&&t[e].destroy();this._timer.destroy(),this.update.destroy(),this.message.destroy(),this.pointDownCapture.destroy(),this.pointMoveCapture.destroy(),this.pointUpCapture.destroy(),this.operation.destroy(),this.loaded.destroy(),this.assetLoaded.destroy(),this.assetLoadFailed.destroy(),this.assetLoadCompleted.destroy(),this.assets={};for(var r=0;r<this._assetHolders.length;++r)this._assetHolders[r].destroy();this._sceneAssetHolder.destroy(),this._storageLoader=void 0,this.game=void 0,this.state=i.Destroyed,this.stateChanged.fire(this.state),this.stateChanged.destroy()},s.prototype.destroyed=function(){return void 0===this.game},s.prototype.createTimer=function(t){return this._timer.createTimer(t)},s.prototype.deleteTimer=function(t){this._timer.deleteTimer(t)},s.prototype.setInterval=function(t,e,i){var r=this._timer;return"number"==typeof t?(this.game.logger.warn("[deprecated] Scene#setInterval(): this arguments ordering is now deprecated. Specify the function first."),null!=i?r.setInterval(i,t,e):r.setInterval(e,t,null)):r.setInterval(t,e,i)},s.prototype.clearInterval=function(t){this._timer.clearInterval(t)},s.prototype.setTimeout=function(t,e,i){var r=this._timer;return"number"==typeof t?(this.game.logger.warn("[deprecated] Scene#setTimeout(): this arguments ordering is now deprecated. Specify the function first."),null!=i?r.setTimeout(i,t,e):r.setTimeout(e,t,null)):r.setTimeout(t,e,i)},s.prototype.clearTimeout=function(t){this._timer.clearTimeout(t)},s.prototype.isCurrentScene=function(){return this.game.scene()===this},s.prototype.gotoScene=function(e,i){if(!this.isCurrentScene())throw t.ExceptionFactory.createAssertionError("Scene#gotoScene: this scene is not the current scene");i?this.game.pushScene(e):this.game.replaceScene(e)},s.prototype.end=function(){if(!this.isCurrentScene())throw t.ExceptionFactory.createAssertionError("Scene#end: this scene is not the current scene");this.game.popScene()},s.prototype.register=function(t){this.game.register(t),t.scene=this},s.prototype.unregister=function(t){t.scene=void 0,this.game.unregister(t)},s.prototype.append=function(t){this.insertBefore(t,void 0)},s.prototype.insertBefore=function(t,e){t.parent&&t.remove(),t.parent=this;var i=-1;void 0!==e&&(i=this.children.indexOf(e))>-1?this.children.splice(i,0,t):this.children.push(t),this.modified(!0)},s.prototype.remove=function(t){var e=this.children.indexOf(t);-1!==e&&(this.children[e].parent=void 0,this.children.splice(e,1),this.modified(!0))},s.prototype.findPointSourceByPoint=function(e,i,r){var s=this.local!==t.LocalTickMode.NonLocal,n=this.children,o=void 0;r&&r instanceof t.Camera2D&&(o=r.getMatrix());for(var a=n.length-1;a>=0;--a){var h=n[a].findPointSourceByPoint(e,o,i,r);if(h)return h.local=h.target.local||s,h}return{target:void 0,point:void 0,local:s}},s.prototype.prefetch=function(){this._loaded||this._prefetchRequested||(this._prefetchRequested=!0,this._sceneAssetHolder.request())},s.prototype.serializeStorageValues=function(){if(this._storageLoader)return this._storageLoader._valueStoreSerialization},s.prototype.requestAssets=function(i,s){if(this._loadingState<r.ReadyFired)throw t.ExceptionFactory.createAssertionError("Scene#requestAsset(): can be called after loaded.");var n=new e({scene:this,assetManager:this.game._assetManager,assetIds:i,handler:s});this._assetHolders.push(n),n.request()},s.prototype._activate=function(){this.state=i.Active,this.stateChanged.fire(this.state)},s.prototype._deactivate=function(){this.state=i.Deactive,this.stateChanged.fire(this.state)},s.prototype._needsLoading=function(){return this._sceneAssetHolder.waitingAssetsCount>0||this._storageLoader&&!this._storageLoader._loaded},s.prototype._load=function(){if(!this._loaded){this._loaded=!0;var t=this._sceneAssetHolder.request();this._storageLoader&&(this._storageLoader._load(this),t=!0),t||this._notifySceneReady()}},s.prototype._onSceneAssetsLoad=function(){this._loaded&&(this._storageLoader&&!this._storageLoader._loaded||this._notifySceneReady())},s.prototype._onStorageLoadError=function(t){this.game.terminateGame()},s.prototype._onStorageLoaded=function(){0===this._sceneAssetHolder.waitingAssetsCount&&this._notifySceneReady()},s.prototype._notifySceneReady=function(){this._loadingState=r.Ready,this.game._fireSceneReady(this)},s.prototype._fireReady=function(){this._ready.fire(this),this._loadingState=r.ReadyFired},s.prototype._fireLoaded=function(){this.loaded.fire(this),this._loadingState=r.LoadedFired},s}();t.Scene=s}(t||(t={}));var t;!function(t){var i=function(i){function r(e){var r=this;return e.local=!0,r=i.call(this,e)||this,r.targetReset=new t.Trigger,r.targetReady=new t.Trigger,r.targetAssetLoaded=new t.Trigger,r._explicitEnd=!!e.explicitEnd,r._targetScene=void 0,r}return e(r,i),r.prototype.destroy=function(){this._clearTargetScene(),i.prototype.destroy.call(this)},r.prototype.reset=function(e){this._clearTargetScene(),this._targetScene=e,this._loadingState<t.SceneLoadState.LoadedFired?this.loaded.addOnce(this._doReset,this):this._doReset()},r.prototype.getTargetWaitingAssetsCount=function(){return this._targetScene?this._targetScene._sceneAssetHolder.waitingAssetsCount:0},r.prototype.end=function(){if(!this._targetScene||this._targetScene._loadingState<t.SceneLoadState.Ready){var e=this._targetScene?t.SceneLoadState[this._targetScene._loadingState]:"(no scene)",i="LoadingScene#end(): the target scene is in invalid state: "+e;throw t.ExceptionFactory.createAssertionError(i)}this.game.popScene(!0),this.game._fireSceneLoaded(this._targetScene),this._clearTargetScene()},r.prototype._clearTargetScene=function(){this._targetScene&&(this._targetScene._ready.removeAll({owner:this}),this._targetScene.assetLoaded.removeAll({owner:this}),this._targetScene=void 0)},r.prototype._doReset=function(){this.targetReset.fire(this._targetScene),this._targetScene._loadingState<t.SceneLoadState.ReadyFired?(this._targetScene._ready.add(this._fireTriggerOnTargetReady,this),this._targetScene.assetLoaded.add(this._fireTriggerOnTargetAssetLoad,this),this._targetScene._load()):this._fireTriggerOnTargetReady(this._targetScene)},r.prototype._fireTriggerOnTargetAssetLoad=function(t){this.targetAssetLoaded.fire(t)},r.prototype._fireTriggerOnTargetReady=function(t){this.targetReady.fire(t),this._explicitEnd||this.end()},r}(t.Scene);t.LoadingScene=i}(t||(t={}));var t;!function(t){var i=function(i){function r(e){var r=i.call(this,e)||this;return r._canceller=new t.Object2D,r}return e(r,i),r.prototype.renderSelf=function(t,e){if(!this.children)return!1;if(e){var i=e,r=this._canceller;i.x===r.x&&i.y===r.y&&i.angle===r.angle&&i.scaleX===r.scaleX&&i.scaleY===r.scaleY||(r.x=i.x,r.y=i.y,r.angle=i.angle,r.scaleX=i.scaleX,r.scaleY=i.scaleY,r._matrix&&(r._matrix._modified=!0)),t.save(),t.transform(r.getMatrix()._matrix)}for(var s=this.children,n=0;n<s.length;++n)s[n].render(t,e);return e&&t.restore(),!1},r}(t.E),r=function(r){function s(t){var e=r.call(this,{game:t.game,name:"akashic:default-loading-scene"})||this;return e._barWidth=Math.min(t.game.width,Math.max(100,t.game.width/2)),e._barHeight=5,e._gauge=void 0,e._gaugeUpdateCount=0,e._totalWaitingAssetCount=0,e.loaded.handle(e,e._onLoaded),e.targetReset.handle(e,e._onTargetReset),e.targetAssetLoaded.handle(e,e._onTargetAssetLoaded),e}return e(s,r),s.prototype._onLoaded=function(){var e;return this.append(new i({scene:this,children:[new t.FilledRect({scene:this,width:this.game.width,height:this.game.height,cssColor:"rgba(0, 0, 0, 0.8)",children:[new t.FilledRect({scene:this,x:(this.game.width-this._barWidth)/2,y:(this.game.height-this._barHeight)/2,width:this._barWidth,height:this._barHeight,cssColor:"gray",children:[e=new t.FilledRect({scene:this,width:0,height:this._barHeight,cssColor:"white"})]})]})]})),e.update.handle(this,this._onUpdateGuage),this._gauge=e,!0},s.prototype._onUpdateGuage=function(){++this._gaugeUpdateCount;var t=Math.round(205+50*Math.sin(this._gaugeUpdateCount/this.game.fps*(2/3)*(2*Math.PI)));this._gauge.cssColor="rgb("+t+","+t+","+t+")",this._gauge.modified()},s.prototype._onTargetReset=function(t){this._gauge&&(this._gauge.width=0,this._gauge.modified()),this._totalWaitingAssetCount=t._sceneAssetHolder.waitingAssetsCount},s.prototype._onTargetAssetLoaded=function(t){var e=this._targetScene._sceneAssetHolder.waitingAssetsCount;this._gauge.width=Math.ceil((1-e/this._totalWaitingAssetCount)*this._barWidth),this._gauge.modified()},s}(t.LoadingScene);t.DefaultLoadingScene=r}(t||(t={}));var t;!function(t){var i=function(i){function r(e){var r=i.call(this,e)||this;return r.surface=t.Util.asSurface(e.src),"width"in e||(r.width=r.surface.width),"height"in e||(r.height=r.surface.height),r.srcWidth="srcWidth"in e?e.srcWidth:r.width,r.srcHeight="srcHeight"in e?e.srcHeight:r.height,r.srcX=e.srcX||0,r.srcY=e.srcY||0,r._stretchMatrix=void 0,r._beforeSurface=r.surface,t.Util.setupAnimatingHandler(r,r.surface),r._invalidateSelf(),r}return e(r,i),r.prototype._onUpdate=function(){this.modified()},r.prototype._onAnimatingStarted=function(){this.update.contains(this._onUpdate,this)||this.update.add(this._onUpdate,this)},r.prototype._onAnimatingStopped=function(){this.destroyed()||this.update.remove(this._onUpdate,this)},r.prototype.renderSelf=function(t,e){return this.srcWidth<=0||this.srcHeight<=0||(this._stretchMatrix&&(t.save(),t.transform(this._stretchMatrix._matrix)),t.drawImage(this.surface,this.srcX,this.srcY,this.srcWidth,this.srcHeight,0,0),this._stretchMatrix&&t.restore(),!0)},r.prototype.invalidate=function(){this._invalidateSelf(),this.modified()},r.prototype.destroy=function(t){this.surface&&!this.surface.destroyed()&&(t?this.surface.destroy():this.surface.isDynamic&&(this.surface.animatingStarted.remove(this._onAnimatingStarted,this),this.surface.animatingStopped.remove(this._onAnimatingStopped,this))),this.surface=void 0,i.prototype.destroy.call(this)},r.prototype._invalidateSelf=function(){this.width===this.srcWidth&&this.height===this.srcHeight?this._stretchMatrix=void 0:(this._stretchMatrix=t.Util.createMatrix(),this._stretchMatrix.scale(this.width/this.srcWidth,this.height/this.srcHeight)),this.surface!==this._beforeSurface&&(t.Util.migrateAnimatingHandler(this,this._beforeSurface,this.surface),this._beforeSurface=this.surface)},r}(t.E);t.Sprite=i}(t||(t={}));var t;!function(t){var i=function(t){function i(e){var i=t.call(this,e)||this;return i._lastUsedIndex=0,i.frameNumber=e.frameNumber||0,i.frames="frames"in e?e.frames:[0],i.interval=e.interval,i._timer=void 0,i._modifiedSelf(),i}return e(i,t),i.createBySprite=function(t,e,r){var s=new i({scene:t.scene,src:t.surface,width:void 0===e?t.width:e,height:void 0===r?t.height:r});return s.srcHeight=void 0===r?t.srcHeight:r,s.srcWidth=void 0===e?t.srcWidth:e,s},i.prototype.start=function(){void 0===this.interval&&(this.interval=1e3/this.game().fps),this._timer&&this._free(),this._timer=this.scene.createTimer(this.interval),this._timer.elapsed.add(this._onElapsed,this)},i.prototype.destroy=function(e){this.stop(),t.prototype.destroy.call(this,e)},i.prototype.stop=function(){this._timer&&this._free()},i.prototype.modified=function(e){this._modifiedSelf(e),t.prototype.modified.call(this,e)},i.prototype._onElapsed=function(){++this.frameNumber>=this.frames.length&&(this.frameNumber=0),this.modified()},i.prototype._free=function(){this._timer&&(this._timer.elapsed.remove(this._onElapsed,this),this._timer.canDelete()&&this.scene.deleteTimer(this._timer),this._timer=void 0)},i.prototype._changeFrame=function(){var t=this.frames[this.frameNumber],e=Math.floor(this.surface.width/this.srcWidth);this.srcX=t%e*this.srcWidth,this.srcY=Math.floor(t/e)*this.srcHeight,this._lastUsedIndex=t},i.prototype._modifiedSelf=function(t){this._lastUsedIndex!==this.frames[this.frameNumber]&&this._changeFrame()},i}(t.Sprite);t.FrameSprite=i}(t||(t={}));var t;!function(t){var i;!function(t){t[t.Unknown=0]="Unknown",t[t.Join=1]="Join",t[t.Leave=2]="Leave",t[t.Timestamp=3]="Timestamp",t[t.Seed=4]="Seed",t[t.PointDown=5]="PointDown",t[t.PointMove=6]="PointMove",t[t.PointUp=7]="PointUp",t[t.Message=8]="Message",t[t.Operation=9]="Operation"}(i=t.EventType||(t.EventType={}));var r=function(){function t(t,e,i,r,s,n){this.priority=n,this.local=s,this.player=r,this.pointerId=t,this.target=e,this.point=i}return t}();t.PointEvent=r;var s=function(t){function r(e,r,s,n,o,a){var h=t.call(this,e,r,s,n,o,a)||this;return h.type=i.PointDown,h}return e(r,t),r}(r);t.PointDownEvent=s;var n=function(t){function r(e,r,s,n,o,a,h,d){var c=t.call(this,e,r,s,a,h,d)||this;return c.type=i.PointUp,c.prevDelta=n,c.startDelta=o,c}return e(r,t),r}(r);t.PointUpEvent=n;var o=function(t){function r(e,r,s,n,o,a,h,d){var c=t.call(this,e,r,s,a,h,d)||this;return c.type=i.PointMove,c.prevDelta=n,c.startDelta=o,c}return e(r,t),r}(r);t.PointMoveEvent=o;var a=function(){function t(t,e,r,s){this.type=i.Message,this.priority=s,this.local=r,this.player=e,this.data=t}return t}();t.MessageEvent=a;var h=function(){function t(t,e,r,s,n){this.type=i.Operation,this.priority=n,this.local=s,this.player=r,this.code=t,this.data=e}return t}();t.OperationEvent=h;var d=function(){function t(t,e,r){this.type=i.Join,this.priority=r,this.player=t,this.storageValues=e}return t}();t.JoinEvent=d;var c=function(){function t(t,e){this.type=i.Leave,this.priority=e,this.player=t}return t}();t.LeaveEvent=c;var l=function(){function t(t,e,r){this.type=i.Timestamp,this.priority=r,this.player=e,this.timestamp=t}return t}();t.TimestampEvent=l;var u=function(){function t(t,e){this.type=i.Seed,this.priority=e,this.generator=t}return t}();t.SeedEvent=u}(t||(t={}));var t;!function(t){var e;!function(t){t[t.Error=0]="Error",t[t.Warn=1]="Warn",t[t.Info=2]="Info",t[t.Debug=3]="Debug"}(e=t.LogLevel||(t.LogLevel={}));var i=function(){function i(e){this.game=e,this.logging=new t.Trigger}return i.prototype.error=function(t,i){this.logging.fire({game:this.game,level:e.Error,message:t,cause:i})},i.prototype.warn=function(t,i){this.logging.fire({game:this.game,level:e.Warn,message:t,cause:i})},i.prototype.info=function(t,i){this.logging.fire({game:this.game,level:e.Info,message:t,cause:i})},i.prototype.debug=function(t,i){this.logging.fire({game:this.game,level:e.Debug,message:t,cause:i})},i}();t.Logger=i}(t||(t={}));var t;!function(t){var e=function(){function e(e,i,r,s,n){e=this._normalizeConfiguration(e),this.fps=e.fps,this.width=e.width,this.height=e.height,this.renderers=[],this.scenes=[],this.random=null,this.age=0,this.assetBase=r||"",this.resourceFactory=i,this.selfId=s||void 0,this.playId=void 0,this._audioSystemManager=new t.AudioSystemManager(this),this.audio={music:new t.MusicAudioSystem("music",this),sound:new t.SoundAudioSystem("sound",this)},this.defaultAudioSystemId="sound",this.storage=new t.Storage(this),this.assets={},this.join=new t.Trigger,this.leave=new t.Trigger,this.seed=new t.Trigger,this._eventTriggerMap={},this._eventTriggerMap[t.EventType.Join]=this.join,this._eventTriggerMap[t.EventType.Leave]=this.leave,this._eventTriggerMap[t.EventType.Seed]=this.seed,this._eventTriggerMap[t.EventType.Message]=void 0,this._eventTriggerMap[t.EventType.PointDown]=void 0,this._eventTriggerMap[t.EventType.PointMove]=void 0,this._eventTriggerMap[t.EventType.PointUp]=void 0,this._eventTriggerMap[t.EventType.Operation]=void 0,this.resized=new t.Trigger,this._loaded=new t.Trigger,this._started=new t.Trigger,this.isLoaded=!1,this.snapshotRequest=new t.Trigger,this.external={},this.logger=new t.Logger(this),this._main=e.main,this._mainParameter=void 0,this._configuration=e,this._assetManager=new t.AssetManager(this,e.assets,e.audio,e.moduleMainScripts);var o=e.operationPlugins||[];this._operationPluginManager=new t.OperationPluginManager(this,n,o),this._operationPluginOperated=new t.Trigger,this._operationPluginManager.operated.add(this._operationPluginOperated.fire,this._operationPluginOperated),this._sceneChanged=new t.Trigger,this._sceneChanged.add(this._updateEventTriggers,this),this._initialScene=new t.Scene({game:this,assetIds:this._assetManager.globalAssetIds(),local:!0,name:"akashic:initial-scene"}),this._initialScene.loaded.add(this._onInitialSceneLoaded,this),this._reset({age:0})}return Object.defineProperty(e.prototype,"focusingCamera",{get:function(){return this._focusingCamera},set:function(t){t!==this._focusingCamera&&(this.modified&&this.render(this._focusingCamera),this._focusingCamera=t)},enumerable:!0,configurable:!0}),e.prototype.pushScene=function(t){this._sceneChangeRequests.push({type:0,scene:t})},e.prototype.replaceScene=function(t,e){this._sceneChangeRequests.push({type:1,scene:t,preserveCurrent:e})},e.prototype.popScene=function(t){this._sceneChangeRequests.push({type:2,preserveCurrent:t})},e.prototype.scene=function(){if(this.scenes.length)return this.scenes[this.scenes.length-1]},e.prototype.tick=function(e){var i=void 0;if(this._isTerminated)return!1;if(this.scenes.length){if(i=this.scenes[this.scenes.length-1],this.events.length){var r=this.events;this.events=[];for(var s=0;s<r.length;++s){var n=this._eventTriggerMap[r[s].type];n&&n.fire(r[s])}}i.update.fire(),(!0===e||void 0===e&&i.local!==t.LocalTickMode.FullLocal)&&++this.age}return!!this._sceneChangeRequests.length&&(this._flushSceneChangeRequests(),i!==this.scenes[this.scenes.length-1])},e.prototype.render=function(t){t||(t=this.focusingCamera);for(var e=this.renderers,i=0;i<e.length;++i)e[i].draw(this,t);this.modified=!1},e.prototype.findPointSource=function(t,e){return e||(e=this.focusingCamera),this.scene().findPointSourceByPoint(t,!1,e)},e.prototype.register=function(e){if(e.local){if(void 0===e.id)e.id=--this._localIdx;else{if(e.id>0)throw t.ExceptionFactory.createAssertionError("Game#register: invalid local id: "+e.id);if(this._localDb.hasOwnProperty(String(e.id)))throw t.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+e.id);this._localIdx>e.id&&(this._localIdx=e.id)}this._localDb[e.id]=e}else{if(void 0===e.id)e.id=++this._idx;else{
if(e.id<0)throw t.ExceptionFactory.createAssertionError("Game#register: invalid non-local id: "+e.id);if(this.db.hasOwnProperty(String(e.id)))throw t.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+e.id);this._idx<e.id&&(this._idx=e.id)}this.db[e.id]=e}},e.prototype.unregister=function(t){t.local?delete this._localDb[t.id]:delete this.db[t.id]},e.prototype.leaveGame=function(){this._leaveGame()},e.prototype.terminateGame=function(){this._leaveGame(),this._isTerminated=!0,this._terminateGame()},e.prototype._fireSceneReady=function(t){this._sceneChangeRequests.push({type:3,scene:t})},e.prototype._fireSceneLoaded=function(e){e._loadingState<t.SceneLoadState.LoadedFired&&this._sceneChangeRequests.push({type:4,scene:e})},e.prototype._callSceneAssetHolderHandler=function(t){this._sceneChangeRequests.push({type:5,assetHolder:t})},e.prototype._normalizeConfiguration=function(e){if(!e)throw t.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: invalid arguments");if("assets"in e||(e.assets={}),"fps"in e||(e.fps=30),"number"!=typeof e.fps)throw t.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be given as a number");if(!(0<=e.fps&&e.fps<=60))throw t.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be a number in (0, 60].");if("number"!=typeof e.width)throw t.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: width must be given as a number");if("number"!=typeof e.height)throw t.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: height must be given as a number");return e},e.prototype._setAudioPlaybackRate=function(t){this._audioSystemManager._setPlaybackRate(t)},e.prototype._setMuted=function(t){this._audioSystemManager._setMuted(t)},e.prototype._decodeOperationPluginOperation=function(t,e){var i=this._operationPluginManager.plugins;return i[t]&&i[t].decode?i[t].decode(e):e},e.prototype._reset=function(e){if(this._operationPluginManager.stopAll(),this.scene()){for(;this.scene()!==this._initialScene;)this.popScene(),this._flushSceneChangeRequests();this.isLoaded||this.scenes.pop()}switch(e&&(void 0!==e.age&&(this.age=e.age),void 0!==e.randGen&&(this.random=e.randGen)),this._loaded.removeAll({func:this._start,owner:this}),this.join.removeAll(),this.leave.removeAll(),this.seed.removeAll(),this.resized.removeAll(),this._idx=0,this._localIdx=0,this._cameraIdx=0,this.db={},this._localDb={},this.events=[],this.modified=!0,this.loadingScene=void 0,this._focusingCamera=void 0,this._scriptCaches={},this.snapshotRequest.removeAll(),this._sceneChangeRequests=[],this._isTerminated=!1,this.vars={},this._configuration.defaultLoadingScene){case"none":this._defaultLoadingScene=new t.LoadingScene({game:this});break;default:this._defaultLoadingScene=new t.DefaultLoadingScene({game:this})}},e.prototype._loadAndStart=function(t){this._mainParameter=t||{},this.isLoaded?this._start():(this._loaded.add(this._start,this),this.pushScene(this._initialScene),this._flushSceneChangeRequests())},e.prototype._startLoadingGlobalAssets=function(){if(this.isLoaded)throw t.ExceptionFactory.createAssertionError("Game#_startLoadingGlobalAssets: already loaded.");this.pushScene(this._initialScene),this._flushSceneChangeRequests()},e.prototype._updateEventTriggers=function(e){if(this.modified=!0,!e)return this._eventTriggerMap[t.EventType.Message]=void 0,this._eventTriggerMap[t.EventType.PointDown]=void 0,this._eventTriggerMap[t.EventType.PointMove]=void 0,this._eventTriggerMap[t.EventType.PointUp]=void 0,void(this._eventTriggerMap[t.EventType.Operation]=void 0);this._eventTriggerMap[t.EventType.Message]=e.message,this._eventTriggerMap[t.EventType.PointDown]=e.pointDownCapture,this._eventTriggerMap[t.EventType.PointMove]=e.pointMoveCapture,this._eventTriggerMap[t.EventType.PointUp]=e.pointUpCapture,this._eventTriggerMap[t.EventType.Operation]=e.operation,e._activate()},e.prototype._onInitialSceneLoaded=function(){this._initialScene.loaded.remove(this._onInitialSceneLoaded,this),this.assets=this._initialScene.assets,this.isLoaded=!0,this._loaded.fire()},e.prototype._terminateGame=function(){},e.prototype._flushSceneChangeRequests=function(){do{var e=this._sceneChangeRequests;this._sceneChangeRequests=[];for(var i=0;i<e.length;++i){var r=e[i];switch(r.type){case 0:var s=this.scene();s&&s._deactivate(),this._doPushScene(r.scene);break;case 1:this._doPopScene(r.preserveCurrent,!1),this._doPushScene(r.scene);break;case 2:this._doPopScene(r.preserveCurrent,!0);break;case 3:r.scene.destroyed()||r.scene._fireReady();break;case 4:r.scene.destroyed()||r.scene._fireLoaded();break;case 5:r.assetHolder.callHandler();break;default:throw t.ExceptionFactory.createAssertionError("Game#_flushSceneChangeRequests: unknown scene change request.")}}}while(this._sceneChangeRequests.length>0)},e.prototype._doPopScene=function(e,i){var r=this.scenes.pop();if(r===this._initialScene)throw t.ExceptionFactory.createAssertionError("Game#_doPopScene: invalid call; attempting to pop the initial scene");e||r.destroy(),i&&this._sceneChanged.fire(this.scene())},e.prototype._start=function(){if(this._operationPluginManager.initialize(),this.operationPlugins=this._operationPluginManager.plugins,!this._main){if(this._mainParameter.snapshot){if(!this.assets.snapshotLoader)throw t.ExceptionFactory.createAssertionError("Game#_start: global asset 'snapshotLoader' not found.");t._require(this,"snapshotLoader")(this._mainParameter.snapshot),this._flushSceneChangeRequests()}else{if(!this.assets.mainScene)throw t.ExceptionFactory.createAssertionError("Game#_start: global asset 'mainScene' not found.");var e=t._require(this,"mainScene")();this.pushScene(e),this._flushSceneChangeRequests()}return void this._started.fire()}var i=t._require(this,this._main);if(!i||"function"!=typeof i)throw t.ExceptionFactory.createAssertionError("Game#_start: Entry point '"+this._main+"' not found.");i(this._mainParameter),this._flushSceneChangeRequests(),this._started.fire()},e.prototype._doPushScene=function(e,i){if(i||(i=this.loadingScene||this._defaultLoadingScene),this.scenes.push(e),e._needsLoading()&&e._loadingState<t.SceneLoadState.LoadedFired){if(this._defaultLoadingScene._needsLoading())throw t.ExceptionFactory.createAssertionError("Game#_doPushScene: _defaultLoadingScene must not depend on any assets/storages.");this._doPushScene(i,this._defaultLoadingScene),i.reset(e)}else this._sceneChanged.fire(e),e._loaded||(e._load(),this._fireSceneLoaded(e));this.modified=!0},e}();t.Game=e}(t||(t={}));var t;!function(t){var i=function(t){function i(e){var i=t.call(this,e)||this;return i.game=e.game,i.local=!!e.local,i.name=e.name,i._modifiedCount=0,i.width=e.game.width,i.height=e.game.height,i.id=i.local?void 0:i.game._cameraIdx++,i}return e(i,t),i.deserialize=function(t,e){var r=t;r.param.game=e;var s=new i(r.param);return s.id=r.id,s},i.prototype.modified=function(){this._modifiedCount=(this._modifiedCount+1)%32768,this._matrix&&(this._matrix._modified=!0),this.game.modified=!0},i.prototype.serialize=function(){return{id:this.id,param:{game:void 0,local:this.local,name:this.name,x:this.x,y:this.y,width:this.width,height:this.height,opacity:this.opacity,scaleX:this.scaleX,scaleY:this.scaleY,angle:this.angle,compositeOperation:this.compositeOperation}}},i.prototype._applyTransformToRenderer=function(t){this.angle||1!==this.scaleX||1!==this.scaleY?t.transform(this.getMatrix()._matrix):t.translate(-this.x,-this.y),1!==this.opacity&&t.opacity(this.opacity)},i.prototype._updateMatrix=function(){this.angle||1!==this.scaleX||1!==this.scaleY?this._matrix.updateByInverse(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y):this._matrix.reset(-this.x,-this.y)},i}(t.Object2D);t.Camera2D=i}(t||(t={}));var t;!function(t){var e=function(){function t(){}return t.prototype.draw=function(t,e){var i=t.scene();if(i){this.begin(),this.clear(),e&&(this.save(),e._applyTransformToRenderer(this));for(var r=i.children,s=0;s<r.length;++s)r[s].render(this,e);e&&this.restore(),this.end()}},t.prototype.begin=function(){},t.prototype.end=function(){},t}();t.Renderer=e}(t||(t={}));var t;!function(t){var e=function(){function e(e,i,r,s){if(void 0===s&&(s=!1),e%1!=0||i%1!=0)throw t.ExceptionFactory.createAssertionError("Surface#constructor: width and height must be integers");this.width=e,this.height=i,r&&(this._drawable=r),this.isDynamic=s,this.isDynamic?(this.animatingStarted=new t.Trigger,this.animatingStopped=new t.Trigger):(this.animatingStarted=void 0,this.animatingStopped=void 0)}return e.prototype.destroy=function(){this.animatingStarted&&this.animatingStarted.destroy(),this.animatingStopped&&this.animatingStopped.destroy(),this._destroyed=!0},e.prototype.destroyed=function(){return!!this._destroyed},e}();t.Surface=e}(t||(t={}));var t;!function(t){var i=function(i){function r(e){var r=i.call(this,e)||this;return r.text=e.text,r.font=e.font,r.textAlign="textAlign"in e?e.textAlign:t.TextAlign.Left,r.glyphs=new Array(e.text.length),r.fontSize=e.fontSize,r.maxWidth=e.maxWidth,r.widthAutoAdjust=!("widthAutoAdjust"in e)||e.widthAutoAdjust,r.textColor=e.textColor,r._textWidth=0,r._game=void 0,r._invalidateSelf(),r}return e(r,i),r.prototype.aligning=function(t,e){this.width=t,this.widthAutoAdjust=!1,this.textAlign=e},r.prototype.invalidate=function(){this._invalidateSelf(),i.prototype.invalidate.call(this)},r.prototype.renderCache=function(e){if(!(!this.fontSize||this.height<=0||this._textWidth<=0)){var i=this.scene.game.resourceFactory.createSurface(Math.ceil(this._textWidth),Math.ceil(this.height)),r=i.renderer();r.begin(),r.save();for(var s=0;s<this.glyphs.length;++s){var n=this.glyphs[s],o=this.fontSize/this.font.size,a=n.advanceWidth*o;n.surface&&(r.save(),r.transform([o,0,0,o,0,0]),r.drawImage(n.surface,n.x,n.y,n.width,n.height,n.offsetX,n.offsetY),r.restore()),r.translate(a,0)}r.restore(),r.end();var h,d=this.maxWidth>0&&this.maxWidth<this._textWidth?this.maxWidth/this._textWidth:1;switch(this.textAlign){case t.TextAlign.Center:h=this.width/2-this._textWidth/2*d;break;case t.TextAlign.Right:h=this.width-this._textWidth*d;break;default:h=0}e.save(),e.translate(h,0),1!==d&&e.transform([d,0,0,1,0,0]),e.drawImage(i,0,0,this._textWidth,this.height,0,0),i.destroy(),this.textColor&&(e.setCompositeOperation(t.CompositeOperation.SourceAtop),e.fillRect(0,0,this._textWidth,this.height,this.textColor)),e.restore()}},r.prototype.destroy=function(){i.prototype.destroy.call(this)},r.prototype._invalidateSelf=function(){if(this.glyphs.length=0,this._textWidth=0,!this.fontSize)return void(this.height=0);for(var e=0,i=this.font.size>0?this.fontSize/this.font.size:0,r=0;r<this.text.length;++r){var s=t.Util.charCodeAt(this.text,r);if(s){var n=this.font.glyphForCharacter(s);if(n){if(!(n.width<0||n.height<0||n.x<0||n.y<0)){this.glyphs.push(n),this._textWidth+=n.advanceWidth*i;var o=n.offsetY+n.height;e<o&&(e=o)}}else{var a=4294901760&s?String.fromCharCode((4294901760&s)>>>16,65535&s):String.fromCharCode(s);this.game().logger.warn("Label#_invalidateSelf(): failed to get a glyph for '"+a+"' (BitmapFont might not have the glyph or DynamicFont might create a glyph larger than its atlas).")}}}this.widthAutoAdjust&&(this.width=this._textWidth),this.height=e*i},r}(t.CacheableE);t.Label=i}(t||(t={}));var t;!function(t){var e=function(){function t(t,e,i,r,s,n,o,a,h,d){void 0===n&&(n=0),void 0===o&&(o=0),void 0===a&&(a=r),void 0===d&&(d=!!h),this.code=t,this.x=e,this.y=i,this.width=r,this.height=s,this.offsetX=n,this.offsetY=o,this.advanceWidth=a,this.surface=h,this.isSurfaceValid=d,this._atlas=null}return t.prototype.renderingWidth=function(t){return this.width&&this.height?t/this.height*this.width:0},t}();t.Glyph=e}(t||(t={}));var t;!function(t){var i=function(i){function r(e){var r=i.call(this,e)||this;if("string"!=typeof e.cssColor)throw t.ExceptionFactory.createTypeMismatchError("ColorBox#constructor(cssColor)","string",e.cssColor);return r.cssColor=e.cssColor,r}return e(r,i),r.prototype.renderSelf=function(t){return t.fillRect(0,0,this.width,this.height,this.cssColor),!0},r}(t.E);t.FilledRect=i}(t||(t={}));var t;!function(t){var i=function(i){function r(e){var r=i.call(this,e)||this;return r._oldWidth=e.width,r._oldHeight=e.height,r.backgroundImage=t.Util.asSurface(e.backgroundImage),r.backgroundEffector=e.backgroundEffector,r._shouldRenderChildren=!1,r._padding=e.padding,r._initialize(),r._paddingChanged=!1,r._bgSurface=void 0,r._bgRenderer=void 0,r}return e(r,i),Object.defineProperty(r.prototype,"padding",{get:function(){return this._padding},set:function(t){this._padding=t,this._paddingChanged=!0},enumerable:!0,configurable:!0}),r.prototype.modified=function(t){t&&(this.state&=-3),i.prototype.modified.call(this)},r.prototype.shouldFindChildrenByPoint=function(t){var e=this._normalizedPadding;return e.left<t.x&&this.width-e.right>t.x&&e.top<t.y&&this.height-e.bottom>t.y},r.prototype.renderCache=function(t,e){this.width<=0||this.height<=0||(this._renderBackground(),this._renderChildren(e),this._bgSurface?t.drawImage(this._bgSurface,0,0,this.width,this.height,0,0):this.backgroundImage&&t.drawImage(this.backgroundImage,0,0,this.width,this.height,0,0),this._childrenArea.width<=0||this._childrenArea.height<=0||(t.save(),0===this._childrenArea.x&&0===this._childrenArea.y||t.translate(this._childrenArea.x,this._childrenArea.y),t.drawImage(this._childrenSurface,0,0,this._childrenArea.width,this._childrenArea.height,0,0),t.restore()))},r.prototype.destroy=function(t){t&&this.backgroundImage&&!this.backgroundImage.destroyed()&&this.backgroundImage.destroy(),this._bgSurface&&!this._bgSurface.destroyed()&&this._bgSurface.destroy(),this._childrenSurface&&!this._childrenSurface.destroyed()&&this._childrenSurface.destroy(),this.backgroundImage=void 0,this._bgSurface=void 0,this._childrenSurface=void 0,i.prototype.destroy.call(this)},r.prototype._renderBackground=function(){this._bgSurface&&!this._bgSurface.destroyed()&&this._bgSurface.destroy(),this.backgroundImage&&this.backgroundEffector?this._bgSurface=this.backgroundEffector.render(this.backgroundImage,this.width,this.height):this._bgSurface=void 0},r.prototype._renderChildren=function(t){var e=this._oldWidth!==this.width||this._oldHeight!==this.height||this._paddingChanged;if(e&&(this._initialize(),this._paddingChanged=!1,this._oldWidth=this.width,this._oldHeight=this.height),this._childrenRenderer.begin(),e||this._childrenRenderer.clear(),this.children)for(var i=this.children,r=0;r<i.length;++r)i[r].render(this._childrenRenderer,t);this._childrenRenderer.end()},r.prototype._initialize=function(){var t,e=void 0===this._padding?0:this._padding;t="number"==typeof e?{top:e,bottom:e,left:e,right:e}:this._padding,this._childrenArea={x:t.left,y:t.top,width:this.width-t.left-t.right,height:this.height-t.top-t.bottom};var i=this.scene.game.resourceFactory;this._childrenSurface&&!this._childrenSurface.destroyed()&&this._childrenSurface.destroy(),this._childrenSurface=i.createSurface(Math.ceil(this._childrenArea.width),Math.ceil(this._childrenArea.height)),this._childrenRenderer=this._childrenSurface.renderer(),this._normalizedPadding=t},r.prototype._calculateBoundingRect=function(t,e){var i=this.getMatrix();if(t&&(i=t.multiplyNew(i)),this.visible()&&(!e||this._targetCameras&&-1!==this._targetCameras.indexOf(e))){for(var r={left:0,right:this.width,top:0,bottom:this.height},s=[{x:r.left,y:r.top},{x:r.left,y:r.bottom},{x:r.right,y:r.top},{x:r.right,y:r.bottom}],n=i.multiplyPoint(s[0]),o={left:n.x,right:n.x,top:n.y,bottom:n.y},a=1;a<s.length;++a)n=i.multiplyPoint(s[a]),o.left>n.x&&(o.left=n.x),o.right<n.x&&(o.right=n.x),o.top>n.y&&(o.top=n.y),o.bottom<n.y&&(o.bottom=n.y);return o}},r}(t.CacheableE);t.Pane=i}(t||(t={}));var t;!function(t){var e=function(){function t(t,e,i){this._code=t,this._handler=i,this._handlerOwner=e}return t.prototype.onOperation=function(t){var e;t instanceof Array?e={_code:this._code,data:t}:(e=t,e._code=this._code),this._handler.call(this._handlerOwner,e)},t}(),i=function(){function i(e,i,r){this.operated=new t.Trigger,this.plugins={},this._game=e,this._viewInfo=i,this._infos=r,this._initialized=!1}return i.prototype.initialize=function(){this._initialized||(this._initialized=!0,this._loadOperationPlugins()),this._doAutoStart()},i.prototype.destroy=function(){this.stopAll(),this.operated.destroy(),this.operated=void 0,this.plugins=void 0,this._game=void 0,this._viewInfo=void 0,this._infos=void 0},i.prototype.stopAll=function(){if(this._initialized)for(var t=0;t<this._infos.length;++t){var e=this._infos[t];e._plugin&&e._plugin.stop()}},i.prototype._doAutoStart=function(){for(var t=0;t<this._infos.length;++t){var e=this._infos[t];!e.manualStart&&e._plugin&&e._plugin.start()}},i.prototype._loadOperationPlugins=function(){for(var i=0;i<this._infos.length;++i){var r=this._infos[i];if(r.script){var s=t._require(this._game,r.script);if(s.isSupported()){var n=new s(this._game,this._viewInfo,r.option),o=r.code;if(this.plugins[o])throw new Error("Plugin#code conflicted for code: "+o);this.plugins[o]=n,r._plugin=n;var a=new e(o,this.operated,this.operated.fire);n.operationTrigger.handle(a,a.onOperation)}}}},i}();t.OperationPluginManager=i}(t||(t={}));var t;t||(t={});var t;!function(t){function e(t,e,i){for(;t;){if(t.width>=e&&t.height>=i)return t;t=t.next}return null}function i(t){return{width:Math.ceil(Math.min(t.initialAtlasWidth,t.maxAtlasWidth)),height:Math.ceil(Math.min(t.initialAtlasHeight,t.maxAtlasHeight))}}var r;!function(t){t[t.Normal=0]="Normal",t[t.Bold=1]="Bold"}(r=t.FontWeight||(t.FontWeight={}));var s=function(){function t(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r,this.prev=null,this.next=null}return t}();t.SurfaceAtlasSlot=s;var n=function(){function t(t){this._surface=t,this._emptySurfaceAtlasSlotHead=new s(0,0,this._surface.width,this._surface.height),this._accessScore=0,this._usedRectangleAreaSize={width:0,height:0}}return t.prototype._acquireSurfaceAtlasSlot=function(t,i){t+=1,i+=1;var r=e(this._emptySurfaceAtlasSlotHead,t,i);if(!r)return null;var n,o,a=r.width-t,h=r.height-i;a<=h?(n=new s(r.x+t,r.y,a,i),o=new s(r.x,r.y+i,r.width,h)):(n=new s(r.x,r.y+i,t,h),o=new s(r.x+t,r.y,a,r.height)),n.prev=r.prev,n.next=o,null===n.prev?this._emptySurfaceAtlasSlotHead=n:n.prev.next=n,o.prev=n,o.next=r.next,o.next&&(o.next.prev=o);var d=new s(r.x,r.y,t,i);return this._updateUsedRectangleAreaSize(d),d},t.prototype._updateUsedRectangleAreaSize=function(t){var e=t.x+t.width,i=t.y+t.height;e>this._usedRectangleAreaSize.width&&(this._usedRectangleAreaSize.width=e),i>this._usedRectangleAreaSize.height&&(this._usedRectangleAreaSize.height=i)},t.prototype.addSurface=function(t,e){var i=this._acquireSurfaceAtlasSlot(e.width,e.height);if(!i)return null;var r=this._surface.renderer();return r.begin(),r.drawImage(t,e.x,e.y,e.width,e.height,i.x,i.y),r.end(),i},t.prototype.destroy=function(){this._surface.destroy()},t.prototype.destroyed=function(){return this._surface.destroyed()},t.prototype.duplicateSurface=function(t){var e=this._surface,i=t.createSurface(this._usedRectangleAreaSize.width,this._usedRectangleAreaSize.height),r=i.renderer();return r.begin(),r.drawImage(e,0,0,this._usedRectangleAreaSize.width,this._usedRectangleAreaSize.height,0,0),r.end(),i},t}();t.SurfaceAtlas=n;var o=function(){function e(e){if(this.fontFamily=e.fontFamily,this.size=e.size,this.hint="hint"in e?e.hint:{},this.fontColor="fontColor"in e?e.fontColor:"black",this.fontWeight="fontWeight"in e?e.fontWeight:r.Normal,this.strokeWidth="strokeWidth"in e?e.strokeWidth:0,this.strokeColor="strokeColor"in e?e.strokeColor:"black",this.strokeOnly="strokeOnly"in e&&e.strokeOnly,this._resourceFactory=e.game.resourceFactory,this._glyphFactory=this._resourceFactory.createGlyphFactory(this.fontFamily,this.size,this.hint.baselineHeight,this.fontColor,this.strokeWidth,this.strokeColor,this.strokeOnly,this.fontWeight),this._glyphs={},this._atlases=[],this._currentAtlasIndex=0,this._destroyed=!1,this.hint.initialAtlasWidth=this.hint.initialAtlasWidth?this.hint.initialAtlasWidth:2048,this.hint.initialAtlasHeight=this.hint.initialAtlasHeight?this.hint.initialAtlasHeight:2048,this.hint.maxAtlasWidth=this.hint.maxAtlasWidth?this.hint.maxAtlasWidth:2048,this.hint.maxAtlasHeight=this.hint.maxAtlasHeight?this.hint.maxAtlasHeight:2048,this.hint.maxAtlasNum=this.hint.maxAtlasNum?this.hint.maxAtlasNum:1,this._atlasSize=i(this.hint),this._atlases.push(this._resourceFactory.createSurfaceAtlas(this._atlasSize.width,this._atlasSize.height)),this.hint.presetChars)for(var s=0,n=this.hint.presetChars.length;s<n;s++){var o=t.Util.charCodeAt(this.hint.presetChars,s);o&&this.glyphForCharacter(o)}}return e.prototype.glyphForCharacter=function(t){var e=this._glyphs[t];if(!e||!e.isSurfaceValid){if(e=this._glyphFactory.create(t),e.surface){if(e.width>this._atlasSize.width||e.height>this._atlasSize.height)return null;var i=this._addToAtlas(e);if(!(i||(this._reallocateAtlas(),i=this._addToAtlas(e))))return null;e._atlas=i}this._glyphs[t]=e}for(var r=0;r<this._atlases.length;r++){var s=this._atlases[r];s===e._atlas&&(s._accessScore+=1),s._accessScore/=2}return e},e.prototype.asBitmapFont=function(e){var i=this;if(1!==this._atlases.length)return null;var r;e&&(r=t.Util.charCodeAt(e,0),this.glyphForCharacter(r));var s={};Object.keys(this._glyphs).forEach(function(t){var e=Number(t),r=i._glyphs[e],n={x:r.x,y:r.y,width:r.width,height:r.height,offsetX:r.offsetX,offsetY:r.offsetY,advanceWidth:r.advanceWidth};s[e]=n});var n=s[r],o=this._atlases[0].duplicateSurface(this._resourceFactory);return new t.BitmapFont({src:o,map:s,defaultGlyphWidth:0,defaultGlyphHeight:this.size,missingGlyph:n})},e.prototype._removeLowUseAtlas=function(){for(var t=Number.MAX_VALUE,e=-1,i=0;i<this._atlases.length;i++)this._atlases[i]._accessScore<=t&&(t=this._atlases[i]._accessScore,e=i);return this._atlases.splice(e,1)[0]},e.prototype._reallocateAtlas=function(){if(this._atlases.length>=this.hint.maxAtlasNum){var t=this._removeLowUseAtlas(),e=this._glyphs;for(var i in e)if(e.hasOwnProperty(i)){var r=e[i];r.surface===t._surface&&(r.surface=null,r.isSurfaceValid=!1,r._atlas=null)}t.destroy()}this._atlases.push(this._resourceFactory.createSurfaceAtlas(this._atlasSize.width,this._atlasSize.height)),this._currentAtlasIndex=this._atlases.length-1},e.prototype._addToAtlas=function(t){for(var e=null,i=null,r={x:t.x,y:t.y,width:t.width,height:t.height},s=0;s<this._atlases.length;s++){var n=(this._currentAtlasIndex+s)%this._atlases.length;if(e=this._atlases[n],i=e.addSurface(t.surface,r)){this._currentAtlasIndex=n;break}}return i?(t.surface.destroy(),t.surface=e._surface,t.x=i.x,t.y=i.y,e):null},e.prototype.destroy=function(){for(var t=0;t<this._atlases.length;t++)this._atlases[t].destroy();this._glyphs=null,this._glyphFactory=null,this._destroyed=!0},e.prototype.destroyed=function(){return this._destroyed},e}();t.DynamicFont=o}(t||(t={}));var t;!function(t){var e=function(){function t(t){this._game=t,this._muted=!1,this._playbackRate=1}return t.prototype._setMuted=function(t){if(this._muted!==t){this._muted=t;var e=this._game.audio;for(var i in e)e.hasOwnProperty(i)&&e[i]._setMuted(t)}},t.prototype._setPlaybackRate=function(t){if(this._playbackRate!==t){this._playbackRate=t;var e=this._game.audio;for(var i in e)e.hasOwnProperty(i)&&e[i]._setPlaybackRate(t)}},t}();t.AudioSystemManager=e}(t||(t={}));var t;!function(t){!function(t){t[t.SourceOver=0]="SourceOver",t[t.SourceAtop=1]="SourceAtop",t[t.Lighter=2]="Lighter",t[t.Copy=3]="Copy",t[t.ExperimentalSourceIn=4]="ExperimentalSourceIn",t[t.ExperimentalSourceOut=5]="ExperimentalSourceOut",t[t.ExperimentalDestinationAtop=6]="ExperimentalDestinationAtop",t[t.ExperimentalDestinationIn=7]="ExperimentalDestinationIn",t[t.DestinationOut=8]="DestinationOut",t[t.DestinationOver=9]="DestinationOver",t[t.Xor=10]="Xor"}(t.CompositeOperation||(t.CompositeOperation={}))}(t||(t={}));var t;!function(t){var e=function(){function e(e,i,r,s,n,o,a,h){void 0===r&&(r=i),void 0===s&&(s="black"),void 0===n&&(n=0),void 0===o&&(o="black"),void 0===a&&(a=!1),void 0===h&&(h=t.FontWeight.Normal),this.fontFamily=e,this.fontSize=i,this.fontWeight=h,this.baselineHeight=r,this.fontColor=s,this.strokeWidth=n,this.strokeColor=o,this.strokeOnly=a}return e}();t.GlyphFactory=e}(t||(t={}));var t;!function(t){!function(t){t[t.NonLocal=0]="NonLocal",t[t.FullLocal=1]="FullLocal",t[t.InterpolateLocal=2]="InterpolateLocal"}(t.LocalTickMode||(t.LocalTickMode={}))}(t||(t={}));var t;!function(t){var e=function(){function t(t,e){void 0===e&&(e=4),this.game=t,this.borderWidth="number"==typeof e?{top:e,bottom:e,left:e,right:e}:e}return t.prototype.render=function(t,e,i){var r=this.game.resourceFactory.createSurface(Math.ceil(e),Math.ceil(i)),s=r.renderer();s.begin();var n=this.borderWidth.left,o=t.width-this.borderWidth.right,a=this.borderWidth.top,h=t.height-this.borderWidth.bottom,d=this.borderWidth.left,c=e-this.borderWidth.right,l=this.borderWidth.top,u=i-this.borderWidth.bottom,p=[{x:0,y:0,width:this.borderWidth.left,height:this.borderWidth.top},{x:o,y:0,width:this.borderWidth.right,height:this.borderWidth.top},{x:0,y:h,width:this.borderWidth.left,height:this.borderWidth.bottom},{x:o,y:h,width:this.borderWidth.right,height:this.borderWidth.bottom}],f=[{x:0,y:0},{x:c,y:0},{x:0,y:u},{x:c,y:u}],g=0;for(g=0;g<p.length;++g){var _=p[g];s.save(),s.translate(f[g].x,f[g].y),s.drawImage(t,_.x,_.y,_.width,_.height,0,0),s.restore()}var y=[{x:n,y:0,width:o-n,height:this.borderWidth.top},{x:0,y:a,width:this.borderWidth.left,height:h-a},{x:o,y:a,width:this.borderWidth.right,height:h-a},{x:n,y:h,width:o-n,height:this.borderWidth.bottom}],m=[{x:d,y:0,width:c-d,height:this.borderWidth.top},{x:0,y:l,width:this.borderWidth.left,height:u-l},{x:c,y:l,width:this.borderWidth.right,height:u-l},{x:d,y:u,width:c-d,height:this.borderWidth.bottom}];for(g=0;g<y.length;++g){var v=y[g],w=m[g];s.save(),s.translate(w.x,w.y),s.transform([w.width/v.width,0,0,w.height/v.height,0,0]),s.drawImage(t,v.x,v.y,v.width,v.height,0,0),s.restore()}var S=o-n,x=h-a,A=c-d,b=u-l;return s.save(),s.translate(d,l),s.transform([A/S,0,0,b/x,0,0]),s.drawImage(t,n,a,S,x,0,0),s.restore(),s.end(),r},t}();t.NinePatchSurfaceEffector=e}(t||(t={}));var t;!function(t){!function(e){function i(i,r){function s(t){var e=t.split("/");return""===e[e.length-1]&&e.pop(),e}if(""===r)return i;for(var n=e.splitPath(i),o=s(n.path).concat(s(r)),a=[],h=0;h<o.length;++h){var d=o[h];switch(d){case"..":var c=a.pop();if(void 0===c||""===c||"."===c)throw t.ExceptionFactory.createAssertionError("PathUtil.resolvePath: invalid arguments");break;case".":0===a.length&&a.push(".");break;case"":a=[""];break;default:a.push(d)}}return n.host+a.join("/")}function r(t){var e=t.lastIndexOf("/");return-1===e?t:t.substr(0,e)}function s(t){for(var e=t.length-1;e>=0;--e){var i=t.charAt(e);if("."===i)return t.substr(e);if("/"===i)return""}return""}function n(t){var i=e.splitPath(t),r=i.host;t=i.path,"/"===t[t.length-1]&&(t=t.slice(0,t.length-1));for(var s=t.split("/"),n=s.indexOf("node_modules"),o=n>0?n-1:0,a=[],h=s.length-1;h>=o;--h)if("node_modules"!==s[h]){var d=s.slice(0,h+1);d.push("node_modules");var c=d.join("/");a.push(r+c)}return a}function o(t,e){var i=t.indexOf("?");return-1===i?t+"."+e:t.substring(0,i)+"."+e+t.substring(i,t.length)}function a(t){var e="",i=t.indexOf("//");if(i>=0){var r=t.indexOf("/",i+2);r>=0?(e=t.slice(0,r),t=t.slice(r)):(e=t,t="/")}else e="";return{host:e,path:t}}e.resolvePath=i,e.resolveDirname=r,e.resolveExtname=s,e.makeNodeModulePaths=n,e.addExtname=o,e.splitPath=a}(t.PathUtil||(t.PathUtil={}))}(t||(t={}));var t;!function(t){!function(t){t[t.SansSerif=0]="SansSerif",t[t.Serif=1]="Serif",t[t.Monospace=2]="Monospace"}(t.FontFamily||(t.FontFamily={}))}(t||(t={}));var t;!function(t){var e=function(){function e(e){this.surface=t.Util.asSurface(e.src),this.map=e.map,this.defaultGlyphWidth=e.defaultGlyphWidth,this.defaultGlyphHeight=e.defaultGlyphHeight,this.missingGlyph=e.missingGlyph,this.size=e.defaultGlyphHeight}return e.prototype.glyphForCharacter=function(e){var i=this.map[e]||this.missingGlyph;if(!i)return null;var r=void 0===i.width?this.defaultGlyphWidth:i.width,s=void 0===i.height?this.defaultGlyphHeight:i.height,n=i.offsetX||0,o=i.offsetY||0,a=void 0===i.advanceWidth?r:i.advanceWidth,h=0===r||0===s?void 0:this.surface;return new t.Glyph(e,i.x,i.y,r,s,n,o,a,h,!0)},e.prototype.destroy=function(){this.surface&&!this.surface.destroyed()&&this.surface.destroy(),this.map=void 0},e.prototype.destroyed=function(){return!this.map},e}();t.BitmapFont=e}(t||(t={}));var t;!function(t){var i;!function(t){t[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Alphabetic=2]="Alphabetic",t[t.Bottom=3]="Bottom"}(i=t.TextBaseline||(t.TextBaseline={}));var r=function(r){function s(e){var s=r.call(this,e)||this;return s.text=e.text,s.fontSize=e.fontSize,s.textAlign="textAlign"in e?e.textAlign:t.TextAlign.Left,s.textBaseline="textBaseline"in e?e.textBaseline:i.Alphabetic,s.maxWidth=e.maxWidth,s.textColor="textColor"in e?e.textColor:"black",s.fontFamily="fontFamily"in e?e.fontFamily:t.FontFamily.SansSerif,s.strokeWidth="strokeWidth"in e?e.strokeWidth:0,s.strokeColor="strokeColor"in e?e.strokeColor:"black",s.strokeOnly="strokeOnly"in e&&e.strokeOnly,s}return e(s,r),s.prototype.renderSelf=function(e,i){if(this.text){var r;switch(this.textAlign){case t.TextAlign.Right:r=this.width;break;case t.TextAlign.Center:r=this.width/2;break;default:r=0}e.drawSystemText(this.text,r,0,this.maxWidth,this.fontSize,this.textAlign,this.textBaseline,this.textColor,this.fontFamily,this.strokeWidth,this.strokeColor,this.strokeOnly)}return!0},s}(t.E);t.SystemLabel=r}(t||(t={}));var t;!function(t){!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(t.TextAlign||(t.TextAlign={}))}(t||(t={}));var t;!function(t){!function(t){t[t.ByClock=0]="ByClock",t[t.Manual=1]="Manual"}(t.TickGenerationMode||(t.TickGenerationMode={}))}(t||(t={}));var t;!function(t){var e=function(){function t(t){this.initState(t)}return t.deserialize=function(e){var i=new t(0);return i._state0U=e._state0U,i._state0L=e._state0L,i._state1U=e._state1U,i._state1L=e._state1L,i},t.prototype.initState=function(t){t=1812433253*(t^t>>30)+1,this._state0U=t,t=1812433253*(t^t>>30)+2,this._state0L=t,t=1812433253*(t^t>>30)+3,this._state1U=t,t=1812433253*(t^t>>30)+4,this._state1L=t},t.prototype.randomInt=function(){var t=this._state0U,e=this._state0L,i=this._state1U,r=this._state1L;this._state0U=i,this._state0L=r;var s=0,n=0,o=0,a=0;s=t<<23|(-512&e)>>>9,n=e<<23,t^=s,e^=n,s=t^i,n=e^r;o=t>>>17,a=e>>>17|(131071&t)<<15,s^=o,n^=a;o=i>>>26,a=r>>>26|(67108863&i)<<6,s^=o,n^=a,this._state1U=s,this._state1L=n;var h=(n>>>0)+(r>>>0);return o=s+i+(h/2>>>31)>>>0,a=h>>>0,[o,a]},t.prototype.random=function(){var t=this.randomInt();return(4294967296*t[0]+t[1])/0x10000000000000000},t.prototype.nextInt=function(t,e){return Math.floor(t+this.random()*(e-t))},t.prototype.serialize=function(){return{_state0U:this._state0U,_state0L:this._state0L,_state1U:this._state1U,_state1L:this._state1L}},t}();t.Xorshift=e}(t||(t={}));var t;!function(t){var i=function(i){function r(e,r){var s=this;if(void 0===e)throw t.ExceptionFactory.createAssertionError("XorshiftRandomGenerator#constructor: seed is undefined");return s=i.call(this,e)||this,s._xorshift=r?t.Xorshift.deserialize(r):new t.Xorshift(e),s}return e(r,i),r.deserialize=function(t){return new r(t._seed,t._xorshift)},r.prototype.get=function(t,e){return this._xorshift.nextInt(t,e+1)},r.prototype.serialize=function(){return{_seed:this.seed,_xorshift:this._xorshift.serialize()}},r}(t.RandomGenerator);t.XorshiftRandomGenerator=i}(t||(t={})),module.exports=t}).call(this);