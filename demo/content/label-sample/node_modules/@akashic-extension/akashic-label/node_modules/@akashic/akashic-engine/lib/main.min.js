var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var g;(function(g){var AssetLoadErrorType;(function(AssetLoadErrorType){AssetLoadErrorType[AssetLoadErrorType["Unspecified"]=0]="Unspecified";AssetLoadErrorType[AssetLoadErrorType["RetryLimitExceeded"]=1]="RetryLimitExceeded";AssetLoadErrorType[AssetLoadErrorType["NetworkError"]=2]="NetworkError";AssetLoadErrorType[AssetLoadErrorType["ClientError"]=3]="ClientError";AssetLoadErrorType[AssetLoadErrorType["ServerError"]=4]="ServerError"})(AssetLoadErrorType=g.AssetLoadErrorType||(g.AssetLoadErrorType={}))})(g||(g={}));var g;(function(g){var ExceptionFactory;(function(ExceptionFactory){function createAssertionError(message,cause){var e=new Error(message);e.name="AssertionError";e.cause=cause;return e}ExceptionFactory.createAssertionError=createAssertionError;function createTypeMismatchError(methodName,expected,actual,cause){var message="Type mismatch on "+methodName+","+" expected type is "+expected;if(arguments.length>2){try{var actualString;if(actual&&actual.constructor&&actual.constructor.name){actualString=actual.constructor.name}else{actualString=typeof actual}message+=", actual type is "+(actualString.length>40?actualString.substr(0,40):actualString)}catch(ex){}}message+=".";var e=new Error(message);e.name="TypeMismatchError";e.cause=cause;e.expected=expected;e.actual=actual;return e}ExceptionFactory.createTypeMismatchError=createTypeMismatchError;function createAssetLoadError(message,retriable,type,cause){if(retriable===void 0){retriable=true}if(type===void 0){type=g.AssetLoadErrorType.Unspecified}var e=new Error(message);e.name="AssetLoadError";e.cause=cause;e.retriable=retriable;e.type=type;return e}ExceptionFactory.createAssetLoadError=createAssetLoadError})(ExceptionFactory=g.ExceptionFactory||(g.ExceptionFactory={}))})(g||(g={}));var g;(function(g){var ResourceFactory=function(){function ResourceFactory(){}ResourceFactory.prototype.createSurfaceAtlas=function(width,height){return new g.SurfaceAtlas(this.createSurface(width,height))};return ResourceFactory}();g.ResourceFactory=ResourceFactory})(g||(g={}));var g;(function(g){var RequireCachedValue=function(){function RequireCachedValue(value){this._value=value}RequireCachedValue.prototype._cachedValue=function(){return this._value};return RequireCachedValue}();g.RequireCachedValue=RequireCachedValue})(g||(g={}));var g;(function(g){var RandomGenerator=function(){function RandomGenerator(seed){this.seed=seed;this[0]=this}return RandomGenerator}();g.RandomGenerator=RandomGenerator})(g||(g={}));var g;(function(g){var Asset=function(){function Asset(id,path){this.id=id;this.originalPath=path;this.path=this._assetPathFilter(path);this.onDestroyed=new g.Trigger}Asset.prototype.destroy=function(){this.onDestroyed.fire(this);this.id=undefined;this.originalPath=undefined;this.path=undefined;this.onDestroyed.destroy();this.onDestroyed=undefined};Asset.prototype.destroyed=function(){return this.id===undefined};Asset.prototype.inUse=function(){return false};Asset.prototype._assetPathFilter=function(path){return path};return Asset}();g.Asset=Asset;var ImageAsset=function(_super){__extends(ImageAsset,_super);function ImageAsset(id,assetPath,width,height){var _this=_super.call(this,id,assetPath)||this;_this.width=width;_this.height=height;return _this}return ImageAsset}(Asset);g.ImageAsset=ImageAsset;var VideoAsset=function(_super){__extends(VideoAsset,_super);function VideoAsset(id,assetPath,width,height,system,loop,useRealSize){var _this=_super.call(this,id,assetPath,width,height)||this;_this.realWidth=0;_this.realHeight=0;_this._system=system;_this._loop=loop;_this._useRealSize=useRealSize;return _this}VideoAsset.prototype.play=function(loop){this.getPlayer().play(this);return this.getPlayer()};VideoAsset.prototype.stop=function(){this.getPlayer().stop()};VideoAsset.prototype.destroy=function(){this._system=undefined;_super.prototype.destroy.call(this)};return VideoAsset}(ImageAsset);g.VideoAsset=VideoAsset;var AudioAsset=function(_super){__extends(AudioAsset,_super);function AudioAsset(id,assetPath,duration,system,loop,hint){var _this=_super.call(this,id,assetPath)||this;_this.duration=duration;_this.loop=loop;_this.hint=hint;_this._system=system;_this.data=undefined;return _this}AudioAsset.prototype.play=function(){var player=this._system.createPlayer();player.play(this);this._lastPlayedPlayer=player;return player};AudioAsset.prototype.stop=function(){var players=this._system.findPlayers(this);for(var i=0;i<players.length;++i)players[i].stop()};AudioAsset.prototype.inUse=function(){return this._system.findPlayers(this).length>0};AudioAsset.prototype.destroy=function(){if(this._system)this.stop();this.data=undefined;this._system=undefined;this._lastPlayedPlayer=undefined;_super.prototype.destroy.call(this)};return AudioAsset}(Asset);g.AudioAsset=AudioAsset;var TextAsset=function(_super){__extends(TextAsset,_super);function TextAsset(id,assetPath){var _this=_super.call(this,id,assetPath)||this;_this.data=undefined;return _this}TextAsset.prototype.destroy=function(){this.data=undefined;_super.prototype.destroy.call(this)};return TextAsset}(Asset);g.TextAsset=TextAsset;var ScriptAsset=function(_super){__extends(ScriptAsset,_super);function ScriptAsset(){return _super!==null&&_super.apply(this,arguments)||this}ScriptAsset.prototype.destroy=function(){this.script=undefined;_super.prototype.destroy.call(this)};return ScriptAsset}(Asset);g.ScriptAsset=ScriptAsset})(g||(g={}));var g;(function(g){var AssetLoadingInfo=function(){function AssetLoadingInfo(asset,handler){this.asset=asset;this.handlers=[handler];this.errorCount=0;this.loading=false}return AssetLoadingInfo}();function normalizeAudioSystemConfMap(confMap){confMap=confMap||{};var systemDefaults={music:{loop:true,hint:{streaming:true}},sound:{loop:false,hint:{streaming:false}}};for(var key in systemDefaults){if(!(key in confMap)){confMap[key]=systemDefaults[key]}}return confMap}var AssetManager=function(){function AssetManager(game,conf,audioSystemConfMap,moduleMainScripts){this.game=game;this.configuration=this._normalize(conf||{},normalizeAudioSystemConfMap(audioSystemConfMap));this._assets={};this._liveAssetVirtualPathTable={};this._liveAbsolutePathTable={};this._moduleMainScripts=moduleMainScripts?moduleMainScripts:{};this._refCounts={};this._loadings={}}AssetManager.prototype.destroy=function(){var assetIds=Object.keys(this._refCounts);for(var i=0;i<assetIds.length;++i){this._releaseAsset(assetIds[i])}this.game=undefined;this.configuration=undefined;this._assets=undefined;this._liveAssetVirtualPathTable=undefined;this._liveAbsolutePathTable=undefined;this._refCounts=undefined;this._loadings=undefined};AssetManager.prototype.destroyed=function(){return this.game===undefined};AssetManager.prototype.retryLoad=function(asset){if(!this._loadings.hasOwnProperty(asset.id))throw g.ExceptionFactory.createAssertionError("AssetManager#retryLoad: invalid argument.");var loadingInfo=this._loadings[asset.id];if(loadingInfo.errorCount>AssetManager.MAX_ERROR_COUNT){if(!this.configuration[asset.id])return;throw g.ExceptionFactory.createAssertionError("AssetManager#retryLoad: too many retrying.")}if(!loadingInfo.loading){loadingInfo.loading=true;asset._load(this)}};AssetManager.prototype.globalAssetIds=function(){var ret=[];var conf=this.configuration;for(var p in conf){if(!conf.hasOwnProperty(p))continue;if(conf[p].global)ret.push(p)}return ret};AssetManager.prototype.requestAsset=function(assetIdOrConf,handler){var assetId=typeof assetIdOrConf==="string"?assetIdOrConf:assetIdOrConf.id;var waiting=false;var loadingInfo;if(this._assets.hasOwnProperty(assetId)){++this._refCounts[assetId];handler._onAssetLoad(this._assets[assetId])}else if(this._loadings.hasOwnProperty(assetId)){loadingInfo=this._loadings[assetId];loadingInfo.handlers.push(handler);++this._refCounts[assetId];waiting=true}else{var a=this._createAssetFor(assetIdOrConf);loadingInfo=new AssetLoadingInfo(a,handler);this._loadings[assetId]=loadingInfo;this._refCounts[assetId]=1;waiting=true;loadingInfo.loading=true;a._load(this)}return waiting};AssetManager.prototype.unrefAsset=function(assetOrId){var assetId=typeof assetOrId==="string"?assetOrId:assetOrId.id;if(--this._refCounts[assetId]>0)return;this._releaseAsset(assetId)};AssetManager.prototype.requestAssets=function(assetIdOrConfs,handler){var waitingCount=0;for(var i=0,len=assetIdOrConfs.length;i<len;++i){if(this.requestAsset(assetIdOrConfs[i],handler)){++waitingCount}}return waitingCount};AssetManager.prototype.unrefAssets=function(assetOrIds){for(var i=0,len=assetOrIds.length;i<len;++i){this.unrefAsset(assetOrIds[i])}};AssetManager.prototype._normalize=function(configuration,audioSystemConfMap){var ret={};if(!(configuration instanceof Object))throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: invalid arguments.");for(var p in configuration){if(!configuration.hasOwnProperty(p))continue;var conf=Object.create(configuration[p]);if(!conf.path){throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: No path given for: "+p)}if(!conf.virtualPath){throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: No virtualPath given for: "+p)}if(!conf.type){throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: No type given for: "+p)}if(conf.type==="image"){if(typeof conf.width!=="number")throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the image asset: "+p);if(typeof conf.height!=="number")throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the image asset: "+p)}if(conf.type==="audio"){if(conf.duration===undefined)conf.duration=0;var audioSystemConf=audioSystemConfMap[conf.systemId];if(conf.loop===undefined){conf.loop=!!audioSystemConf&&!!audioSystemConf.loop}if(conf.hint===undefined){conf.hint=audioSystemConf?audioSystemConf.hint:{}}}if(conf.type==="video"){if(!conf.useRealSize){if(typeof conf.width!=="number")throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the video asset: "+p);if(typeof conf.height!=="number")throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the video asset: "+p);conf.useRealSize=false}}if(!conf.global)conf.global=false;ret[p]=conf}return ret};AssetManager.prototype._createAssetFor=function(idOrConf){var id;var uri;var conf;if(typeof idOrConf==="string"){id=idOrConf;conf=this.configuration[id];uri=this.configuration[id].path}else{var dynConf=idOrConf;id=dynConf.id;conf=dynConf;uri=dynConf.uri}var resourceFactory=this.game.resourceFactory;if(!conf)throw g.ExceptionFactory.createAssertionError("AssetManager#_createAssetFor: unknown asset ID: "+id);switch(conf.type){case"image":return resourceFactory.createImageAsset(id,uri,conf.width,conf.height);case"audio":var system=conf.systemId?this.game.audio[conf.systemId]:this.game.audio[this.game.defaultAudioSystemId];return resourceFactory.createAudioAsset(id,uri,conf.duration,system,conf.loop,conf.hint);case"text":return resourceFactory.createTextAsset(id,uri);case"script":return resourceFactory.createScriptAsset(id,uri);case"video":return resourceFactory.createVideoAsset(id,uri,conf.width,conf.height,new g.VideoSystem,conf.loop,conf.useRealSize);default:throw g.ExceptionFactory.createAssertionError("AssertionError#_createAssetFor: unknown asset type "+conf.type+" for asset ID: "+id)}};AssetManager.prototype._releaseAsset=function(assetId){var asset=this._assets[assetId]||this._loadings[assetId]&&this._loadings[assetId].asset;var path;if(asset){path=asset.path;if(asset.inUse()){if(asset instanceof g.AudioAsset){asset._system.requestDestroy(asset)}else if(asset instanceof g.VideoAsset){asset.destroy()}else{throw g.ExceptionFactory.createAssertionError("AssetManager#unrefAssets: Unsupported in-use "+asset.id)}}else{asset.destroy()}}delete this._refCounts[assetId];delete this._loadings[assetId];delete this._assets[assetId];if(this.configuration[assetId]){var virtualPath=this.configuration[assetId].virtualPath;if(virtualPath&&this._liveAssetVirtualPathTable.hasOwnProperty(virtualPath))delete this._liveAssetVirtualPathTable[virtualPath];if(path&&this._liveAbsolutePathTable.hasOwnProperty(path))delete this._liveAbsolutePathTable[path]}};AssetManager.prototype._countLoadingAsset=function(){return Object.keys(this._loadings).length};AssetManager.prototype._onAssetError=function(asset,error){if(this.destroyed()||asset.destroyed())return;var loadingInfo=this._loadings[asset.id];var hs=loadingInfo.handlers;loadingInfo.loading=false;++loadingInfo.errorCount;if(loadingInfo.errorCount>AssetManager.MAX_ERROR_COUNT&&error.retriable){error=g.ExceptionFactory.createAssetLoadError("Retry limit exceeded",false,g.AssetLoadErrorType.RetryLimitExceeded,error)}if(!error.retriable)delete this._loadings[asset.id];for(var i=0;i<hs.length;++i)hs[i]._onAssetError(asset,error,this)};AssetManager.prototype._onAssetLoad=function(asset){if(this.destroyed()||asset.destroyed())return;var loadingInfo=this._loadings[asset.id];loadingInfo.loading=false;delete this._loadings[asset.id];this._assets[asset.id]=asset;if(this.configuration[asset.id]){var virtualPath=this.configuration[asset.id].virtualPath;if(!this._liveAssetVirtualPathTable.hasOwnProperty(virtualPath)){this._liveAssetVirtualPathTable[virtualPath]=asset}else{if(this._liveAssetVirtualPathTable[virtualPath].path!==asset.path)throw g.ExceptionFactory.createAssertionError("AssetManager#_onAssetLoad(): duplicated asset path")}if(!this._liveAbsolutePathTable.hasOwnProperty(asset.path))this._liveAbsolutePathTable[asset.path]=virtualPath}var hs=loadingInfo.handlers;for(var i=0;i<hs.length;++i)hs[i]._onAssetLoad(asset)};return AssetManager}();AssetManager.MAX_ERROR_COUNT=3;g.AssetManager=AssetManager})(g||(g={}));var g;(function(g){function _require(game,path,currentModule){var basedir=currentModule?currentModule._dirname:game.assetBase;var targetScriptAsset;var resolvedPath;var resolvedVirtualPath;var liveAssetVirtualPathTable=game._assetManager._liveAssetVirtualPathTable;var moduleMainScripts=game._assetManager._moduleMainScripts;if(path.indexOf("/")===-1){if(game._assetManager._assets.hasOwnProperty(path))targetScriptAsset=game._assetManager._assets[path]}if(/^\.\/|^\.\.\/|^\//.test(path)){resolvedPath=g.PathUtil.resolvePath(basedir,path);if(game._scriptCaches.hasOwnProperty(resolvedPath)){return game._scriptCaches[resolvedPath]._cachedValue()}else if(game._scriptCaches.hasOwnProperty(resolvedPath+".js")){return game._scriptCaches[resolvedPath+".js"]._cachedValue()}if(currentModule){if(currentModule._virtualDirname){resolvedVirtualPath=g.PathUtil.resolvePath(currentModule._virtualDirname,path)}else{throw g.ExceptionFactory.createAssertionError("g._require: require from DynamicAsset is not supported")}}else{if(path.substring(0,2)==="./"){resolvedVirtualPath=path.substring(2)}else{throw g.ExceptionFactory.createAssertionError("g._require: entry point must start with './'")}}if(!targetScriptAsset)targetScriptAsset=g.Util.findAssetByPathAsFile(resolvedVirtualPath,liveAssetVirtualPathTable);if(!targetScriptAsset)targetScriptAsset=g.Util.findAssetByPathAsDirectory(resolvedVirtualPath,liveAssetVirtualPathTable)}else{if(moduleMainScripts[path]){targetScriptAsset=game._assetManager._liveAssetVirtualPathTable[moduleMainScripts[path]]}if(!targetScriptAsset){var dirs=currentModule?currentModule.paths:[];dirs.push("node_modules");for(var i=0;i<dirs.length;++i){var dir=dirs[i];resolvedVirtualPath=g.PathUtil.resolvePath(dir,path);targetScriptAsset=g.Util.findAssetByPathAsFile(resolvedVirtualPath,liveAssetVirtualPathTable);if(targetScriptAsset)break;targetScriptAsset=g.Util.findAssetByPathAsDirectory(resolvedVirtualPath,liveAssetVirtualPathTable);if(targetScriptAsset)break}}}if(targetScriptAsset){if(game._scriptCaches.hasOwnProperty(targetScriptAsset.path))return game._scriptCaches[targetScriptAsset.path]._cachedValue();if(targetScriptAsset instanceof g.ScriptAsset){var context=new g.ScriptAssetContext(game,targetScriptAsset);game._scriptCaches[targetScriptAsset.path]=context;return context._executeScript(currentModule)}else if(targetScriptAsset instanceof g.TextAsset){if(targetScriptAsset&&g.PathUtil.resolveExtname(path)===".json"){var cache=game._scriptCaches[targetScriptAsset.path]=new g.RequireCachedValue(JSON.parse(targetScriptAsset.data));return cache._cachedValue()}}}throw g.ExceptionFactory.createAssertionError("g._require: can not find module: "+path)}g._require=_require;var Module=function(){function Module(game,id,path){var _this=this;var dirname=g.PathUtil.resolveDirname(path);var virtualPath=game._assetManager._liveAbsolutePathTable[path];var virtualDirname=virtualPath?g.PathUtil.resolveDirname(virtualPath):undefined;var _g=Object.create(g,{game:{value:game,enumerable:true},filename:{value:path,enumerable:true},dirname:{value:dirname,enumerable:true},module:{value:this,writable:true,enumerable:true,configurable:true}});this.id=id;this.filename=path;this.exports={};this.parent=null;this.loaded=false;this.children=[];this.paths=virtualDirname?g.PathUtil.makeNodeModulePaths(virtualDirname):[];this._dirname=dirname;this._virtualDirname=virtualDirname;this._g=_g;this.require=function(path){return path==="g"?_g:g._require(game,path,_this)}}return Module}();g.Module=Module})(g||(g={}));var g;(function(g){var ScriptAssetContext=function(){function ScriptAssetContext(game,asset){this._game=game;this._asset=asset;this._module=new g.Module(game,asset.path,asset.path);this._g=this._module._g;this._started=false}ScriptAssetContext.prototype._cachedValue=function(){if(!this._started)throw g.ExceptionFactory.createAssertionError("ScriptAssetContext#_cachedValue: not executed yet.");return this._module.exports};ScriptAssetContext.prototype._executeScript=function(currentModule){if(this._started)return this._module.exports;if(currentModule){this._module.parent=currentModule;currentModule.children.push(this._module)}this._started=true;this._asset.execute(this._g);this._module.loaded=true;return this._module.exports};return ScriptAssetContext}();g.ScriptAssetContext=ScriptAssetContext})(g||(g={}));var g;(function(g){var PlainMatrix=function(){function PlainMatrix(widthOrSrc,height,scaleX,scaleY,angle){if(widthOrSrc===undefined){this._modified=false;this._matrix=[1,0,0,1,0,0]}else if(typeof widthOrSrc==="number"){this._modified=false;this._matrix=new Array(6);this.update(widthOrSrc,height,scaleX,scaleY,angle,0,0)}else{this._modified=widthOrSrc._modified;this._matrix=[widthOrSrc._matrix[0],widthOrSrc._matrix[1],widthOrSrc._matrix[2],widthOrSrc._matrix[3],widthOrSrc._matrix[4],widthOrSrc._matrix[5]]}}PlainMatrix.prototype.update=function(width,height,scaleX,scaleY,angle,x,y){var r=angle*Math.PI/180;var _cos=Math.cos(r);var _sin=Math.sin(r);var a=_cos*scaleX;var b=_sin*scaleX;var c=_sin*scaleY;var d=_cos*scaleY;var w=width/2;var h=height/2;this._matrix[0]=a;this._matrix[1]=b;this._matrix[2]=-c;this._matrix[3]=d;this._matrix[4]=-a*w+c*h+w+x;this._matrix[5]=-b*w-d*h+h+y};PlainMatrix.prototype.updateByInverse=function(width,height,scaleX,scaleY,angle,x,y){var r=angle*Math.PI/180;var _cos=Math.cos(r);var _sin=Math.sin(r);var a=_cos/scaleX;var b=_sin/scaleY;var c=_sin/scaleX;var d=_cos/scaleY;var w=width/2;var h=height/2;this._matrix[0]=a;this._matrix[1]=-b;this._matrix[2]=c;this._matrix[3]=d;this._matrix[4]=-a*(w+x)-c*(h+y)+w;this._matrix[5]=b*(w+x)-d*(h+y)+h};PlainMatrix.prototype.multiply=function(matrix){var m1=this._matrix;var m2=matrix._matrix;var m10=m1[0];var m11=m1[1];var m12=m1[2];var m13=m1[3];m1[0]=m10*m2[0]+m12*m2[1];m1[1]=m11*m2[0]+m13*m2[1];m1[2]=m10*m2[2]+m12*m2[3];m1[3]=m11*m2[2]+m13*m2[3];m1[4]=m10*m2[4]+m12*m2[5]+m1[4];m1[5]=m11*m2[4]+m13*m2[5]+m1[5]};PlainMatrix.prototype.multiplyNew=function(matrix){var ret=this.clone();ret.multiply(matrix);return ret};PlainMatrix.prototype.reset=function(x,y){this._matrix[0]=1;this._matrix[1]=0;this._matrix[2]=0;this._matrix[3]=1;this._matrix[4]=x||0;this._matrix[5]=y||0};PlainMatrix.prototype.clone=function(){return new PlainMatrix(this)};PlainMatrix.prototype.multiplyInverseForPoint=function(point){var m=this._matrix;var _id=1/(m[0]*m[3]+m[2]*-m[1]);return{x:m[3]*_id*point.x+-m[2]*_id*point.y+(m[5]*m[2]-m[4]*m[3])*_id,y:m[0]*_id*point.y+-m[1]*_id*point.x+(-m[5]*m[0]+m[4]*m[1])*_id}};PlainMatrix.prototype.scale=function(x,y){var m=this._matrix;m[0]*=x;m[1]*=y;m[2]*=x;m[3]*=y;m[4]*=x;m[5]*=y};PlainMatrix.prototype.multiplyPoint=function(point){var m=this._matrix;var x=m[0]*point.x+m[2]*point.y+m[4];var y=m[1]*point.x+m[3]*point.y+m[5];return{x:x,y:y}};return PlainMatrix}();g.PlainMatrix=PlainMatrix})(g||(g={}));var g;(function(g){var Util;(function(Util){function distance(p1x,p1y,p2x,p2y){return Math.sqrt(Math.pow(p1x-p2x,2)+Math.pow(p1y-p2y,2))}Util.distance=distance;function distanceBetweenOffsets(p1,p2){return Util.distance(p1.x,p1.y,p2.x,p2.y)}Util.distanceBetweenOffsets=distanceBetweenOffsets;function distanceBetweenAreas(p1,p2){return Util.distance(p1.x-p1.width/2,p1.y-p1.height/2,p2.x-p2.width/2,p2.y-p2.height/2)}Util.distanceBetweenAreas=distanceBetweenAreas;function createMatrix(width,height,scaleX,scaleY,angle){if(width===undefined)return new g.PlainMatrix;return new g.PlainMatrix(width,height,scaleX,scaleY,angle)}Util.createMatrix=createMatrix;function createSpriteFromE(scene,e,camera){var oldX=e.x;var oldY=e.y;var x=0;var y=0;var width=e.width;var height=e.height;var boundingRect=e.calculateBoundingRect(camera);if(!boundingRect){throw g.ExceptionFactory.createAssertionError("Util#createSpriteFromE: camera must look e")}width=boundingRect.right-boundingRect.left;height=boundingRect.bottom-boundingRect.top;if(boundingRect.left<e.x)x=e.x-boundingRect.left;if(boundingRect.top<e.y)y=e.y-boundingRect.top;e.moveTo(x,y);if(e._matrix)e._matrix._modified=true;var surface=scene.game.resourceFactory.createSurface(Math.ceil(width),Math.ceil(height));var renderer=surface.renderer();renderer.begin();e.render(renderer,camera);renderer.end();var s=new g.Sprite({scene:scene,src:surface,width:width,height:height});s.moveTo(boundingRect.left,boundingRect.top);e.moveTo(oldX,oldY);if(e._matrix)e._matrix._modified=true;return s}Util.createSpriteFromE=createSpriteFromE;function createSpriteFromScene(toScene,fromScene,camera){var surface=toScene.game.resourceFactory.createSurface(Math.ceil(fromScene.game.width),Math.ceil(fromScene.game.height));var renderer=surface.renderer();renderer.begin();var children=fromScene.children;for(var i=0;i<children.length;++i)children[i].render(renderer,camera);renderer.end();return new g.Sprite({scene:toScene,src:surface,width:fromScene.game.width,height:fromScene.game.height})}Util.createSpriteFromScene=createSpriteFromScene;function asSurface(src){if(!src)return src;if(src instanceof g.Surface)return src;if(src instanceof g.ImageAsset)return src.asSurface();throw g.ExceptionFactory.createTypeMismatchError("Util#asSurface","ImageAsset|Surface",src)}Util.asSurface=asSurface;function findAssetByPathAsFile(resolvedPath,liveAssetPathTable){if(liveAssetPathTable.hasOwnProperty(resolvedPath))return liveAssetPathTable[resolvedPath];if(liveAssetPathTable.hasOwnProperty(resolvedPath+".js"))return liveAssetPathTable[resolvedPath+".js"];return undefined}Util.findAssetByPathAsFile=findAssetByPathAsFile;function findAssetByPathAsDirectory(resolvedPath,liveAssetPathTable){var path;path=resolvedPath+"/package.json";if(liveAssetPathTable.hasOwnProperty(path)&&liveAssetPathTable[path]instanceof g.TextAsset){var pkg=JSON.parse(liveAssetPathTable[path].data);if(pkg&&typeof pkg.main==="string"){var asset=Util.findAssetByPathAsFile(g.PathUtil.resolvePath(resolvedPath,pkg.main),liveAssetPathTable);if(asset)return asset}}path=resolvedPath+"/index.js";if(liveAssetPathTable.hasOwnProperty(path))return liveAssetPathTable[path];return undefined}Util.findAssetByPathAsDirectory=findAssetByPathAsDirectory;function charCodeAt(str,idx){var code=str.charCodeAt(idx);if(55296<=code&&code<=56319){var hi=code;var low=str.charCodeAt(idx+1);return hi<<16|low}if(56320<=code&&code<=57343){return null}return code}Util.charCodeAt=charCodeAt;function setupAnimatingHandler(animatingHandler,surface){if(surface.isDynamic){surface.animatingStarted.add(animatingHandler._onAnimatingStarted,animatingHandler);surface.animatingStopped.add(animatingHandler._onAnimatingStopped,animatingHandler);if(surface.isPlaying()){animatingHandler._onAnimatingStarted()}}}Util.setupAnimatingHandler=setupAnimatingHandler;function migrateAnimatingHandler(animatingHandler,beforeSurface,afterSurface){animatingHandler._onAnimatingStopped();if(!beforeSurface.destroyed()&&beforeSurface.isDynamic){beforeSurface.animatingStarted.remove(animatingHandler._onAnimatingStarted,animatingHandler);beforeSurface.animatingStopped.remove(animatingHandler._onAnimatingStopped,animatingHandler)}if(afterSurface.isDynamic){afterSurface.animatingStarted.add(animatingHandler._onAnimatingStarted,animatingHandler);afterSurface.animatingStopped.add(animatingHandler._onAnimatingStopped,animatingHandler);if(afterSurface.isPlaying()){animatingHandler._onAnimatingStarted()}}}Util.migrateAnimatingHandler=migrateAnimatingHandler})(Util=g.Util||(g.Util={}))})(g||(g={}));var g;(function(g){var Collision;(function(Collision){function intersect(x1,y1,width1,height1,x2,y2,width2,height2){return x1<=x2+width2&&x2<=x1+width1&&y1<=y2+height2&&y2<=y1+height1}Collision.intersect=intersect;function intersectAreas(t1,t2){return Collision.intersect(t1.x,t1.y,t1.width,t1.height,t2.x,t2.y,t2.width,t2.height)}Collision.intersectAreas=intersectAreas;function within(t1x,t1y,t2x,t2y,distance){if(distance===void 0){distance=1}return distance>=g.Util.distance(t1x,t1y,t2x,t2y)}Collision.within=within;function withinAreas(t1,t2,distance){if(distance===void 0){distance=1}return distance>=g.Util.distanceBetweenAreas(t1,t2)}Collision.withinAreas=withinAreas})(Collision=g.Collision||(g.Collision={}))})(g||(g={}));var g;(function(g){var Trigger=function(){function Trigger(){this._handlers=[];this.length=0}Trigger.prototype.add=function(paramsOrFunc,owner){if(typeof paramsOrFunc==="function"){this._handlers.push({func:paramsOrFunc,owner:owner,once:false,name:undefined})}else{var params=paramsOrFunc;if(typeof params.index==="number"){this._handlers.splice(params.index,0,{func:params.func,owner:params.owner,once:false,name:params.name})}else{this._handlers.push({func:params.func,owner:params.owner,once:false,name:params.name})}}this.length=this._handlers.length};Trigger.prototype.addOnce=function(paramsOrFunc,owner){if(typeof paramsOrFunc==="function"){this._handlers.push({func:paramsOrFunc,owner:owner,once:true,name:undefined})}else{var params=paramsOrFunc;if(typeof params.index==="number"){this._handlers.splice(params.index,0,{func:params.func,owner:params.owner,once:true,name:params.name})}else{this._handlers.push({func:params.func,owner:params.owner,once:true,name:params.name})}}this.length=this._handlers.length};Trigger.prototype.handle=function(owner,func,name){this.add(func?{owner:owner,func:func,name:name}:{func:owner})};Trigger.prototype.fire=function(arg){if(!this._handlers.length)return;var handlers=this._handlers.concat();for(var i=0;i<handlers.length;i++){var handler=handlers[i];if(handler.func.call(handler.owner,arg)||handler.once){var index=this._handlers.indexOf(handler);if(index!==-1)this._handlers.splice(index,1)}}if(this._handlers)this.length=this._handlers.length};Trigger.prototype.contains=function(paramsOrFunc,owner){var condition=typeof paramsOrFunc==="function"?{func:paramsOrFunc,owner:owner}:paramsOrFunc;for(var i=0;i<this._handlers.length;i++){if(this._comparePartial(condition,this._handlers[i])){return true}}return false};Trigger.prototype.remove=function(paramsOrFunc,owner){var condition=typeof paramsOrFunc==="function"?{func:paramsOrFunc,owner:owner}:paramsOrFunc;for(var i=0;i<this._handlers.length;i++){var handler=this._handlers[i];if(condition.func===handler.func&&condition.owner===handler.owner&&condition.name===handler.name){this._handlers.splice(i,1);--this.length;return}}};Trigger.prototype.removeAll=function(params){var handlers=[];if(params){for(var i=0;i<this._handlers.length;i++){var handler=this._handlers[i];if(!this._comparePartial(params,handler)){handlers.push(handler)}}}this._handlers=handlers;this.length=this._handlers.length};Trigger.prototype.destroy=function(){this._handlers=null;this.length=null};Trigger.prototype.destroyed=function(){return this._handlers===null};Trigger.prototype._comparePartial=function(target,compare){if(target.func!==undefined&&target.func!==compare.func)return false;if(target.owner!==undefined&&target.owner!==compare.owner)return false;if(target.name!==undefined&&target.name!==compare.name)return false;return true};return Trigger}();g.Trigger=Trigger;var ChainTrigger=function(_super){__extends(ChainTrigger,_super);function ChainTrigger(chain,filter,filterOwner){var _this=_super.call(this)||this;_this.chain=chain;_this.filter=filter;_this.filterOwner=filterOwner;_this._isActivated=false;return _this}ChainTrigger.prototype.add=function(paramsOrHandler,owner){_super.prototype.add.call(this,paramsOrHandler,owner);if(!this._isActivated){this.chain.add(this._onChainTriggerFired,this);this._isActivated=true}};ChainTrigger.prototype.addOnce=function(paramsOrHandler,owner){_super.prototype.addOnce.call(this,paramsOrHandler,owner);if(!this._isActivated){this.chain.add(this._onChainTriggerFired,this);this._isActivated=true}};ChainTrigger.prototype.remove=function(paramsOrFunc,owner){_super.prototype.remove.call(this,paramsOrFunc,owner);if(this.length===0&&this._isActivated){this.chain.remove(this._onChainTriggerFired,this);this._isActivated=false}};ChainTrigger.prototype.removeAll=function(params){_super.prototype.removeAll.call(this,params);if(this.length===0&&this._isActivated){this.chain.remove(this._onChainTriggerFired,this);this._isActivated=false}};ChainTrigger.prototype.destroy=function(){_super.prototype.destroy.call(this);this.chain.remove(this._onChainTriggerFired,this);this.filter=null;this.filterOwner=null;this._isActivated=false};ChainTrigger.prototype._onChainTriggerFired=function(args){if(!this.filter||this.filter.call(this.filterOwner,args)){this.fire(args)}};return ChainTrigger}(Trigger);g.ChainTrigger=ChainTrigger})(g||(g={}));var g;(function(g){var Timer=function(){function Timer(interval,fps){this.interval=interval;this._scaledInterval=Math.round(interval*fps);this.elapsed=new g.Trigger;this._scaledElapsed=0}Timer.prototype.tick=function(){this._scaledElapsed+=1e3;while(this._scaledElapsed>=this._scaledInterval){if(!this.elapsed){break}this.elapsed.fire();this._scaledElapsed-=this._scaledInterval}};Timer.prototype.canDelete=function(){return!this.elapsed||this.elapsed.length===0};Timer.prototype.destroy=function(){this.interval=undefined;this.elapsed.destroy();this.elapsed=undefined;this._scaledInterval=0;this._scaledElapsed=0};Timer.prototype.destroyed=function(){return this.elapsed===undefined};return Timer}();g.Timer=Timer})(g||(g={}));var g;(function(g){var TimerIdentifier=function(){function TimerIdentifier(timer,handler,handlerOwner,fired,firedOwner){this._timer=timer;this._handler=handler;this._handlerOwner=handlerOwner;this._fired=fired;this._firedOwner=firedOwner;this._timer.elapsed.add(this._fire,this)}TimerIdentifier.prototype.destroy=function(){this._timer.elapsed.remove(this._fire,this);this._timer=undefined;this._handler=undefined;this._handlerOwner=undefined;this._fired=undefined;this._firedOwner=undefined};TimerIdentifier.prototype.destroyed=function(){return this._timer===undefined};TimerIdentifier.prototype._fire=function(){this._handler.call(this._handlerOwner);if(this._fired){this._fired.call(this._firedOwner,this)}};return TimerIdentifier}()
;g.TimerIdentifier=TimerIdentifier;var TimerManager=function(){function TimerManager(trigger,fps){this._timers=[];this._trigger=trigger;this._identifiers=[];this._fps=fps;this._registered=false}TimerManager.prototype.destroy=function(){for(var i=0;i<this._identifiers.length;++i){this._identifiers[i].destroy()}for(var i=0;i<this._timers.length;++i){this._timers[i].destroy()}this._timers=undefined;this._trigger=undefined;this._identifiers=undefined;this._fps=undefined};TimerManager.prototype.destroyed=function(){return this._timers===undefined};TimerManager.prototype.createTimer=function(interval){if(!this._registered){this._trigger.add(this._tick,this);this._registered=true}if(interval<0)throw g.ExceptionFactory.createAssertionError("TimerManager#createTimer: invalid interval");if(interval<1)interval=1;var acceptableMargin=Math.min(1e3,interval*this._fps);for(var i=0;i<this._timers.length;++i){if(this._timers[i].interval===interval){if(this._timers[i]._scaledElapsed<acceptableMargin){return this._timers[i]}}}var timer=new g.Timer(interval,this._fps);this._timers.push(timer);return timer};TimerManager.prototype.deleteTimer=function(timer){if(!timer.canDelete())return;var index=this._timers.indexOf(timer);if(index<0)throw g.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: can not find timer");this._timers.splice(index,1);timer.destroy();if(!this._timers.length){if(!this._registered)throw g.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: handler is not handled");this._trigger.remove(this._tick,this);this._registered=false}};TimerManager.prototype.setTimeout=function(handler,milliseconds,owner){var timer=this.createTimer(milliseconds);var identifier=new TimerIdentifier(timer,handler,owner,this._onTimeoutFired,this);this._identifiers.push(identifier);return identifier};TimerManager.prototype.clearTimeout=function(identifier){this._clear(identifier)};TimerManager.prototype.setInterval=function(handler,interval,owner){var timer=this.createTimer(interval);var identifier=new TimerIdentifier(timer,handler,owner);this._identifiers.push(identifier);return identifier};TimerManager.prototype.clearInterval=function(identifier){this._clear(identifier)};TimerManager.prototype._tick=function(){var timers=this._timers.concat();for(var i=0;i<timers.length;++i)timers[i].tick()};TimerManager.prototype._onTimeoutFired=function(identifier){var index=this._identifiers.indexOf(identifier);if(index<0)throw g.ExceptionFactory.createAssertionError("TimerManager#_onTimeoutFired: can not find identifier");this._identifiers.splice(index,1);var timer=identifier._timer;identifier.destroy();this.deleteTimer(timer)};TimerManager.prototype._clear=function(identifier){var index=this._identifiers.indexOf(identifier);if(index<0)throw g.ExceptionFactory.createAssertionError("TimerManager#_clear: can not find identifier");if(identifier.destroyed())throw g.ExceptionFactory.createAssertionError("TimerManager#_clear: invalid identifier");this._identifiers.splice(index,1);var timer=identifier._timer;identifier.destroy();this.deleteTimer(timer)};return TimerManager}();g.TimerManager=TimerManager})(g||(g={}));var g;(function(g){var AudioPlayer=function(){function AudioPlayer(system){this.played=new g.Trigger;this.stopped=new g.Trigger;this.currentAudio=undefined;this.volume=system.volume;this._muted=system._muted;this._playbackRate=system._playbackRate;this._system=system}AudioPlayer.prototype.play=function(audio){this.currentAudio=audio;this.played.fire({player:this,audio:audio})};AudioPlayer.prototype.stop=function(){var audio=this.currentAudio;this.currentAudio=undefined;this.stopped.fire({player:this,audio:audio})};AudioPlayer.prototype.canHandleStopped=function(){return true};AudioPlayer.prototype.changeVolume=function(volume){this.volume=volume};AudioPlayer.prototype._changeMuted=function(muted){this._muted=muted};AudioPlayer.prototype._changePlaybackRate=function(rate){this._playbackRate=rate};AudioPlayer.prototype._supportsPlaybackRate=function(){return false};AudioPlayer.prototype._onVolumeChanged=function(){};return AudioPlayer}();g.AudioPlayer=AudioPlayer})(g||(g={}));var g;(function(g){var AudioSystem=function(){function AudioSystem(id,game){var audioSystemManager=game._audioSystemManager;this.id=id;this.game=game;this._volume=1;this._destroyRequestedAssets={};this._muted=audioSystemManager._muted;this._playbackRate=audioSystemManager._playbackRate}Object.defineProperty(AudioSystem.prototype,"volume",{get:function(){return this._volume},set:function(value){if(value<0||value>1||isNaN(value)||typeof value!=="number")throw g.ExceptionFactory.createAssertionError("AudioSystem#volume: expected: 0.0-1.0, actual: "+value);this._volume=value;this._onVolumeChanged()},enumerable:true,configurable:true});AudioSystem.prototype.requestDestroy=function(asset){this._destroyRequestedAssets[asset.id]=asset};AudioSystem.prototype._setMuted=function(value){var before=this._muted;this._muted=!!value;if(this._muted!==before){this._onMutedChanged()}};AudioSystem.prototype._setPlaybackRate=function(value){if(value<0||isNaN(value)||typeof value!=="number")throw g.ExceptionFactory.createAssertionError("AudioSystem#playbackRate: expected: greater or equal to 0.0, actual: "+value);var before=this._playbackRate;this._playbackRate=value;if(this._playbackRate!==before){this._onPlaybackRateChanged()}};return AudioSystem}();g.AudioSystem=AudioSystem;var MusicAudioSystem=function(_super){__extends(MusicAudioSystem,_super);function MusicAudioSystem(id,game){var _this=_super.call(this,id,game)||this;_this._player=undefined;_this._suppressingAudio=undefined;return _this}Object.defineProperty(MusicAudioSystem.prototype,"player",{get:function(){if(!this._player){this._player=this.game.resourceFactory.createAudioPlayer(this);this._player.played.handle(this,this._onPlayerPlayed);this._player.stopped.handle(this,this._onPlayerStopped)}return this._player},set:function(v){this._player=v},enumerable:true,configurable:true});MusicAudioSystem.prototype.findPlayers=function(asset){if(this.player.currentAudio&&this.player.currentAudio.id===asset.id)return[this.player];return[]};MusicAudioSystem.prototype.createPlayer=function(){return this.player};MusicAudioSystem.prototype.stopAll=function(){if(!this._player)return;this._player.stop()};MusicAudioSystem.prototype._onVolumeChanged=function(){this.player.changeVolume(this._volume)};MusicAudioSystem.prototype._onMutedChanged=function(){this.player._changeMuted(this._muted)};MusicAudioSystem.prototype._onPlaybackRateChanged=function(){var player=this.player;player._changePlaybackRate(this._playbackRate);if(!player._supportsPlaybackRate()){this._onUnsupportedPlaybackRateChanged()}};MusicAudioSystem.prototype._onUnsupportedPlaybackRateChanged=function(){if(this._playbackRate===1){if(this._suppressingAudio){var audio=this._suppressingAudio;this._suppressingAudio=undefined;if(!audio.destroyed()){this.player.play(audio)}}}};MusicAudioSystem.prototype._onPlayerPlayed=function(e){if(e.player!==this._player)throw g.ExceptionFactory.createAssertionError("MusicAudioSystem#_onPlayerPlayed: unexpected audio player");if(e.player._supportsPlaybackRate())return;if(this._playbackRate!==1){e.player.stop();this._suppressingAudio=e.audio}};MusicAudioSystem.prototype._onPlayerStopped=function(e){if(this._destroyRequestedAssets[e.audio.id]){delete this._destroyRequestedAssets[e.audio.id];e.audio.destroy()}};return MusicAudioSystem}(AudioSystem);g.MusicAudioSystem=MusicAudioSystem;var SoundAudioSystem=function(_super){__extends(SoundAudioSystem,_super);function SoundAudioSystem(id,game){var _this=_super.call(this,id,game)||this;_this.players=[];return _this}SoundAudioSystem.prototype.createPlayer=function(){var player=this.game.resourceFactory.createAudioPlayer(this);if(player.canHandleStopped())this.players.push(player);player.played.handle(this,this._onPlayerPlayed);player.stopped.handle(this,this._onPlayerStopped);return player};SoundAudioSystem.prototype.findPlayers=function(asset){var ret=[];for(var i=0;i<this.players.length;++i){if(this.players[i].currentAudio&&this.players[i].currentAudio.id===asset.id)ret.push(this.players[i])}return ret};SoundAudioSystem.prototype.stopAll=function(){var players=this.players.concat();for(var i=0;i<players.length;++i){players[i].stop()}};SoundAudioSystem.prototype._onMutedChanged=function(){var players=this.players;for(var i=0;i<players.length;++i){players[i]._changeMuted(this._muted)}};SoundAudioSystem.prototype._onPlaybackRateChanged=function(){var players=this.players;for(var i=0;i<players.length;++i){players[i]._changePlaybackRate(this._playbackRate)}};SoundAudioSystem.prototype._onPlayerPlayed=function(e){if(e.player._supportsPlaybackRate())return;if(this._playbackRate!==1){e.player.stop()}};SoundAudioSystem.prototype._onPlayerStopped=function(e){var index=this.players.indexOf(e.player);if(index<0)return;e.player.stopped.remove({owner:this,func:this._onPlayerStopped});this.players.splice(index,1);if(this._destroyRequestedAssets[e.audio.id]){delete this._destroyRequestedAssets[e.audio.id];e.audio.destroy()}};SoundAudioSystem.prototype._onVolumeChanged=function(){for(var i=0;i<this.players.length;++i){this.players[i].changeVolume(this._volume)}};return SoundAudioSystem}(AudioSystem);g.SoundAudioSystem=SoundAudioSystem})(g||(g={}));var g;(function(g){var VideoPlayer=function(){function VideoPlayer(loop){this._loop=!!loop;this.played=new g.Trigger;this.stopped=new g.Trigger;this.currentVideo=undefined;this.volume=1}VideoPlayer.prototype.play=function(videoAsset){this.currentVideo=videoAsset;this.played.fire({player:this,video:videoAsset});videoAsset.asSurface().animatingStarted.fire()};VideoPlayer.prototype.stop=function(){var videoAsset=this.currentVideo;this.stopped.fire({player:this,video:videoAsset});videoAsset.asSurface().animatingStopped.fire()};VideoPlayer.prototype.changeVolume=function(volume){this.volume=volume};return VideoPlayer}();g.VideoPlayer=VideoPlayer})(g||(g={}));var g;(function(g){var VideoSystem=function(){function VideoSystem(){}return VideoSystem}();g.VideoSystem=VideoSystem})(g||(g={}));var g;(function(g){var Object2D=function(){function Object2D(param){if(!param){this.x=0;this.y=0;this.width=0;this.height=0;this.opacity=1;this.scaleX=1;this.scaleY=1;this.angle=0;this.compositeOperation=undefined;this._matrix=undefined}else{this.x=param.x||0;this.y=param.y||0;this.width=param.width||0;this.height=param.height||0;this.opacity="opacity"in param?param.opacity:1;this.scaleX="scaleX"in param?param.scaleX:1;this.scaleY="scaleY"in param?param.scaleY:1;this.angle=param.angle||0;this.compositeOperation=param.compositeOperation;this._matrix=undefined}}Object2D.prototype.moveTo=function(posOrX,y){if(typeof posOrX==="number"&&typeof y!=="number"){throw g.ExceptionFactory.createAssertionError("Object2D#moveTo: arguments must be CommonOffset or pair of x and y as a number.")}if(typeof posOrX==="number"){this.x=posOrX;this.y=y}else{this.x=posOrX.x;this.y=posOrX.y}};Object2D.prototype.moveBy=function(x,y){this.x+=x;this.y+=y};Object2D.prototype.resizeTo=function(sizeOrWidth,height){if(typeof sizeOrWidth==="number"&&typeof height!=="number"){throw g.ExceptionFactory.createAssertionError("Object2D#resizeTo: arguments must be CommonSize or pair of width and height as a number.")}if(typeof sizeOrWidth==="number"){this.width=sizeOrWidth;this.height=height}else{this.width=sizeOrWidth.width;this.height=sizeOrWidth.height}};Object2D.prototype.resizeBy=function(width,height){this.width+=width;this.height+=height};Object2D.prototype.scale=function(scale){this.scaleX=scale;this.scaleY=scale};Object2D.prototype.getMatrix=function(){if(!this._matrix){this._matrix=g.Util.createMatrix()}else if(!this._matrix._modified){return this._matrix}this._updateMatrix();this._matrix._modified=false;return this._matrix};Object2D.prototype._updateMatrix=function(){if(this.angle||this.scaleX!==1||this.scaleY!==1){this._matrix.update(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y)}else{this._matrix.reset(this.x,this.y)}};return Object2D}();g.Object2D=Object2D})(g||(g={}));var g;(function(g){var E=function(_super){__extends(E,_super);function E(param){var _this=_super.call(this,param)||this;_this.children=undefined;_this.parent=undefined;_this._touchable=false;_this.state=0;_this._hasTouchableChildren=false;_this._update=undefined;_this._message=undefined;_this._pointDown=undefined;_this._pointMove=undefined;_this._pointUp=undefined;_this._targetCameras=undefined;_this.tag=param.tag;_this.local=param.scene.local!==g.LocalTickMode.NonLocal||!!param.local;if(param.children){for(var i=0;i<param.children.length;++i)_this.append(param.children[i])}if(param.parent){param.parent.append(_this)}if(param.targetCameras)_this.targetCameras=param.targetCameras;if("touchable"in param)_this.touchable=param.touchable;if(!!param.hidden)_this.hide();_this.id=param.id;param.scene.register(_this);return _this}Object.defineProperty(E.prototype,"update",{get:function(){if(!this._update)this._update=new g.ChainTrigger(this.scene.update);return this._update},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"message",{get:function(){if(!this._message)this._message=new g.ChainTrigger(this.scene.message);return this._message},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"pointDown",{get:function(){if(!this._pointDown)this._pointDown=new g.ChainTrigger(this.scene.pointDownCapture,this._isTargetOperation,this);return this._pointDown},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"pointUp",{get:function(){if(!this._pointUp)this._pointUp=new g.ChainTrigger(this.scene.pointUpCapture,this._isTargetOperation,this);return this._pointUp},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"pointMove",{get:function(){if(!this._pointMove)this._pointMove=new g.ChainTrigger(this.scene.pointMoveCapture,this._isTargetOperation,this);return this._pointMove},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"targetCameras",{get:function(){return this._targetCameras||(this._targetCameras=[])},set:function(v){this._targetCameras=v},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"touchable",{get:function(){return this._touchable},set:function(v){if(this._touchable===v)return;this._touchable=v;if(v){this._enableTouchPropagation()}else{this._disableTouchPropagation()}},enumerable:true,configurable:true});E.prototype.render=function(renderer,camera){this.state&=~4;if(this.state&1)return;var cams=this._targetCameras;if(cams&&cams.length>0&&(!camera||cams.indexOf(camera)===-1))return;if(this.state&8){renderer.translate(this.x,this.y);var goDown=this.renderSelf(renderer,camera);if(goDown&&this.children){var children=this.children;var len=children.length;for(var i=0;i<len;++i)children[i].render(renderer,camera)}renderer.translate(-this.x,-this.y);return}renderer.save();if(this.angle||this.scaleX!==1||this.scaleY!==1){renderer.transform(this.getMatrix()._matrix)}else{renderer.translate(this.x,this.y)}if(this.opacity!==1)renderer.opacity(this.opacity);if(this.compositeOperation!==undefined)renderer.setCompositeOperation(this.compositeOperation);var goDown=this.renderSelf(renderer,camera);if(goDown&&this.children){var children=this.children;for(var i=0;i<children.length;++i)children[i].render(renderer,camera)}renderer.restore()};E.prototype.renderSelf=function(renderer,camera){return true};E.prototype.game=function(){return this.scene.game};E.prototype.append=function(e){this.insertBefore(e,undefined)};E.prototype.insertBefore=function(e,target){if(e.parent)e.remove();if(!this.children)this.children=[];e.parent=this;var index=-1;if(target!==undefined&&(index=this.children.indexOf(target))>-1){this.children.splice(index,0,e)}else{this.children.push(e)}if(e._touchable||e._hasTouchableChildren){this._hasTouchableChildren=true;this._enableTouchPropagation()}this.modified(true)};E.prototype.remove=function(e){if(e===undefined){this.parent.remove(this);return}var index=this.children?this.children.indexOf(e):-1;if(index<0)throw g.ExceptionFactory.createAssertionError("E#remove: invalid child");this.children[index].parent=undefined;this.children.splice(index,1);if(e._touchable||e._hasTouchableChildren){if(!this._findTouchableChildren(this)){this._hasTouchableChildren=false;this._disableTouchPropagation()}}this.modified(true)};E.prototype.destroy=function(){if(this.parent)this.remove();if(this.children){while(this.children.length)this.children[this.children.length-1].destroy();this.children=undefined}if(this._update){this._update.destroy();this._update=undefined}if(this._message){this._message.destroy();this._message=undefined}if(this._pointDown){this._pointDown.destroy();this._pointDown=undefined}if(this._pointMove){this._pointMove.destroy();this._pointMove=undefined}if(this._pointUp){this._pointUp.destroy();this._pointUp=undefined}this.scene.unregister(this)};E.prototype.destroyed=function(){return this.scene===undefined};E.prototype.modified=function(isBubbling){if(this._matrix)this._matrix._modified=true;if(this.angle||this.scaleX!==1||this.scaleY!==1||this.opacity!==1||this.compositeOperation!==undefined){this.state&=~8}else{this.state|=8}if(this.state&4)return;this.state|=4;if(this.parent)this.parent.modified(true)};E.prototype.shouldFindChildrenByPoint=function(point){return true};E.prototype.findPointSourceByPoint=function(point,m,force,camera){if(this.state&1)return undefined;var cams=this._targetCameras;if(cams&&cams.length>0&&(!camera||cams.indexOf(camera)===-1))return undefined;m=m?m.multiplyNew(this.getMatrix()):this.getMatrix().clone();var p=m.multiplyInverseForPoint(point);if(this._hasTouchableChildren||force&&this.children&&this.children.length){if(this.shouldFindChildrenByPoint(p)){for(var i=this.children.length-1;i>=0;--i){var child=this.children[i];if(force||child._touchable||child._hasTouchableChildren){var target=child.findPointSourceByPoint(point,m,force,camera);if(target)return target}}}}if(!(force||this._touchable))return undefined;if(0<=p.x&&this.width>p.x&&0<=p.y&&this.height>p.y){return{target:this,point:p}}return undefined};E.prototype.visible=function(){return(this.state&1)!==1};E.prototype.show=function(){if(!(this.state&1))return;this.state&=~1;if(this.parent){this.parent.modified(true)}};E.prototype.hide=function(){if(this.state&1)return;this.state|=1;if(this.parent){this.parent.modified(true)}};E.prototype.calculateBoundingRect=function(c){return this._calculateBoundingRect(undefined,c)};E.prototype._calculateBoundingRect=function(m,c){var matrix=this.getMatrix();if(m){matrix=m.multiplyNew(matrix)}if(!this.visible()||c&&(!this._targetCameras||this._targetCameras.indexOf(c)===-1)){return undefined}var thisBoundingRect={left:0,right:this.width,top:0,bottom:this.height};var targetCoordinates=[{x:thisBoundingRect.left,y:thisBoundingRect.top},{x:thisBoundingRect.left,y:thisBoundingRect.bottom},{x:thisBoundingRect.right,y:thisBoundingRect.top},{x:thisBoundingRect.right,y:thisBoundingRect.bottom}];var convertedPoint=matrix.multiplyPoint(targetCoordinates[0]);var result={left:convertedPoint.x,right:convertedPoint.x,top:convertedPoint.y,bottom:convertedPoint.y};for(var i=1;i<targetCoordinates.length;++i){convertedPoint=matrix.multiplyPoint(targetCoordinates[i]);if(result.left>convertedPoint.x)result.left=convertedPoint.x;if(result.right<convertedPoint.x)result.right=convertedPoint.x;if(result.top>convertedPoint.y)result.top=convertedPoint.y;if(result.bottom<convertedPoint.y)result.bottom=convertedPoint.y}if(this.children!==undefined){for(var i=0;i<this.children.length;++i){var nowResult=this.children[i]._calculateBoundingRect(matrix,c);if(nowResult){if(result.left>nowResult.left)result.left=nowResult.left;if(result.right<nowResult.right)result.right=nowResult.right;if(result.top>nowResult.top)result.top=nowResult.top;if(result.bottom<nowResult.bottom)result.bottom=nowResult.bottom}}}return result};E.prototype._enableTouchPropagation=function(){var p=this.parent;while(p instanceof E&&!p._hasTouchableChildren){p._hasTouchableChildren=true;p=p.parent}};E.prototype._disableTouchPropagation=function(){var p=this.parent;while(p instanceof E&&p._hasTouchableChildren){if(this._findTouchableChildren(p))break;p._hasTouchableChildren=false;p=p.parent}};E.prototype._isTargetOperation=function(e){if(this.state&1)return false;if(e instanceof g.PointEvent)return this._touchable&&e.target===this;return false};E.prototype._findTouchableChildren=function(e){if(e.children){for(var i=0;i<e.children.length;++i){if(e.children[i].touchable)return e.children[i];var tmp=this._findTouchableChildren(e.children[i]);if(tmp)return tmp}}return undefined};return E}(g.Object2D);g.E=E})(g||(g={}));var g;(function(g){var CacheableE=function(_super){__extends(CacheableE,_super);function CacheableE(param){var _this=_super.call(this,param)||this;_this._shouldRenderChildren=true;_this._cache=undefined;_this._renderer=undefined;_this._renderedCamera=undefined;return _this}CacheableE.prototype.invalidate=function(){this.state&=~2;this.modified()};CacheableE.prototype.renderSelf=function(renderer,camera){if(this._renderedCamera!==camera){this.state&=~2;this._renderedCamera=camera}if(!(this.state&2)){this._cacheSize=this.calculateCacheSize();var isNew=!this._cache||this._cache.width<Math.ceil(this._cacheSize.width)||this._cache.height<Math.ceil(this._cacheSize.height);if(isNew){if(this._cache&&!this._cache.destroyed()){this._cache.destroy()}this._cache=this.scene.game.resourceFactory.createSurface(Math.ceil(this._cacheSize.width),Math.ceil(this._cacheSize.height));this._renderer=this._cache.renderer()}this._renderer.begin();if(!isNew){this._renderer.clear()}this.renderCache(this._renderer,camera);this.state|=2;this._renderer.end()}if(this._cache&&this._cacheSize.width>0&&this._cacheSize.height>0){renderer.drawImage(this._cache,0,0,this._cacheSize.width,this._cacheSize.height,0,0)}return this._shouldRenderChildren};CacheableE.prototype.destroy=function(){if(this._cache&&!this._cache.destroyed()){this._cache.destroy()}this._cache=undefined;_super.prototype.destroy.call(this)};CacheableE.prototype.calculateCacheSize=function(){return{width:this.width,height:this.height}};return CacheableE}(g.E);g.CacheableE=CacheableE})(g||(g={}));var g;(function(g){var StorageRegion;(function(StorageRegion){StorageRegion[StorageRegion["Slots"]=1]="Slots";StorageRegion[StorageRegion["Scores"]=2]="Scores";StorageRegion[StorageRegion["Counts"]=3]="Counts";StorageRegion[StorageRegion["Values"]=4]="Values"})(StorageRegion=g.StorageRegion||(g.StorageRegion={}));var StorageOrder;(function(StorageOrder){StorageOrder[StorageOrder["Asc"]=0]="Asc";StorageOrder[StorageOrder["Desc"]=1]="Desc"})(StorageOrder=g.StorageOrder||(g.StorageOrder={}));var StorageCondition;(function(StorageCondition){StorageCondition[StorageCondition["Equal"]=1]="Equal";StorageCondition[StorageCondition["GreaterThan"]=2]="GreaterThan";StorageCondition[StorageCondition["LessThan"]=3]="LessThan"})(StorageCondition=g.StorageCondition||(g.StorageCondition={}));var StorageCountsOperation;(function(StorageCountsOperation){StorageCountsOperation[StorageCountsOperation["Incr"]=1]="Incr";StorageCountsOperation[StorageCountsOperation["Decr"]=2]="Decr"})(StorageCountsOperation=g.StorageCountsOperation||(g.StorageCountsOperation={}));var StorageValueStore=function(){function StorageValueStore(keys,values){this._keys=keys;this._values=values}StorageValueStore.prototype.get=function(keyOrIndex){if(this._values===undefined){return[]}if(typeof keyOrIndex==="number"){return this._values[keyOrIndex]}else{var index=this._keys.indexOf(keyOrIndex);if(index!==-1){return this._values[index]}for(var i=0;i<this._keys.length;++i){var target=this._keys[i];if(target.region===keyOrIndex.region&&target.regionKey===keyOrIndex.regionKey&&target.userId===keyOrIndex.userId&&target.gameId===keyOrIndex.gameId){return this._values[i]}}}return[]};StorageValueStore.prototype.getOne=function(keyOrIndex){var values=this.get(keyOrIndex);if(!values)return undefined;return values[0]};return StorageValueStore}();g.StorageValueStore=StorageValueStore;var StorageLoader=function(){function StorageLoader(storage,keys,serialization){this._loaded=false;this._storage=storage;this._valueStore=new StorageValueStore(keys);this._handler=undefined;this._valueStoreSerialization=serialization}StorageLoader.prototype._load=function(handler){this._handler=handler;if(this._storage._load){this._storage._load.call(this._storage,this._valueStore._keys,this,this._valueStoreSerialization)}};StorageLoader.prototype._onLoaded=function(values,serialization){this._valueStore._values=values;this._loaded=true;if(serialization)this._valueStoreSerialization=serialization;if(this._handler)this._handler._onStorageLoaded()};StorageLoader.prototype._onError=function(error){if(this._handler)this._handler._onStorageLoadError(error)};return StorageLoader}();g.StorageLoader=StorageLoader;var Storage=function(){function Storage(game){this._game=game}Storage.prototype.write=function(key,value,option){if(this._write){this._write(key,value,option)}};Storage.prototype.requestValuesForJoinPlayer=function(keys){this._requestedKeysForJoinPlayer=keys};Storage.prototype._createLoader=function(keys,serialization){return new StorageLoader(this,keys,serialization)};Storage.prototype._registerWrite=function(write){this._write=write};Storage.prototype._registerLoad=function(load){this._load=load};return Storage}();g.Storage=Storage})(g||(g={}));var g;(function(g){var SceneAssetHolder=function(){function SceneAssetHolder(param){this.waitingAssetsCount=param.assetIds.length;this._scene=param.scene;this._assetManager=param.assetManager;this._assetIds=param.assetIds;this._assets=[];this._handler=param.handler;this._handlerOwner=param.handlerOwner||null;this._direct=!!param.direct;this._requested=false}SceneAssetHolder.prototype.request=function(){if(this.waitingAssetsCount===0)return false;if(this._requested)return true;this._requested=true;this._assetManager.requestAssets(this._assetIds,this);return true};SceneAssetHolder.prototype.destroy=function(){if(this._requested){this._assetManager.unrefAssets(this._assets)}this.waitingAssetsCount=0;this._scene=undefined;this._assetIds=undefined;this._handler=undefined;this._requested=false};SceneAssetHolder.prototype.destroyed=function(){return!this._scene};SceneAssetHolder.prototype.callHandler=function(){this._handler.call(this._handlerOwner)};SceneAssetHolder.prototype._onAssetError=function(asset,error,assetManager){if(this.destroyed()||this._scene.destroyed())return;var failureInfo={asset:asset,error:error,cancelRetry:false};this._scene.assetLoadFailed.fire(failureInfo);if(error.retriable&&!failureInfo.cancelRetry){this._assetManager.retryLoad(asset)}else{if(this._assetManager.configuration[asset.id])this._scene.game.terminateGame()}this._scene.assetLoadCompleted.fire(asset)};SceneAssetHolder.prototype._onAssetLoad=function(asset){if(this.destroyed()||this._scene.destroyed())return;this._scene.assets[asset.id]=asset;this._scene.assetLoaded.fire(asset);this._scene.assetLoadCompleted.fire(asset);this._assets.push(asset);--this.waitingAssetsCount;if(this.waitingAssetsCount<0)throw g.ExceptionFactory.createAssertionError("SceneAssetHolder#_onAssetLoad: broken waitingAssetsCount");if(this.waitingAssetsCount>0)return;if(this._direct){this.callHandler()}else{this._scene.game._callSceneAssetHolderHandler(this)}};return SceneAssetHolder}();g.SceneAssetHolder=SceneAssetHolder;var SceneState;(function(SceneState){SceneState[SceneState["Destroyed"]=0]="Destroyed";SceneState[SceneState["Standby"]=1]="Standby";SceneState[SceneState["Active"]=2]="Active";SceneState[SceneState["Deactive"]=3]="Deactive";SceneState[SceneState["BeforeDestroyed"]=4]="BeforeDestroyed"})(SceneState=g.SceneState||(g.SceneState={}));var SceneLoadState;(function(SceneLoadState){SceneLoadState[SceneLoadState["Initial"]=0]="Initial";SceneLoadState[SceneLoadState["Ready"]=1]="Ready";SceneLoadState[SceneLoadState["ReadyFired"]=2]="ReadyFired";SceneLoadState[SceneLoadState["LoadedFired"]=3]="LoadedFired"})(SceneLoadState=g.SceneLoadState||(g.SceneLoadState={}));var Scene=function(){function Scene(param){var game;var local;var tickGenerationMode;var assetIds;game=param.game;assetIds=param.assetIds;if(!param.storageKeys){this._storageLoader=undefined;this.storageValues=undefined}else{this._storageLoader=game.storage._createLoader(param.storageKeys,param.storageValuesSerialization);this.storageValues=this._storageLoader._valueStore}local=param.local===undefined?g.LocalTickMode.NonLocal:param.local===false?g.LocalTickMode.NonLocal:param.local===true?g.LocalTickMode.FullLocal:param.local;tickGenerationMode=param.tickGenerationMode!==undefined?param.tickGenerationMode:g.TickGenerationMode.ByClock;this.name=param.name;if(!assetIds)assetIds=[];this.game=game;this.local=local;this.tickGenerationMode=tickGenerationMode;this.loaded=new g.Trigger;this._ready=new g.Trigger;this.assets={};this._loaded=false;this._prefetchRequested=false;this._loadingState=SceneLoadState.Initial;this.update=new g.Trigger;this._timer=new g.TimerManager(this.update,this.game.fps);this.assetLoaded=new g.Trigger;this.assetLoadFailed=new g.Trigger;this.assetLoadCompleted=new g.Trigger;this.message=new g.Trigger;this.pointDownCapture=new g.Trigger;this.pointMoveCapture=new g.Trigger;this.pointUpCapture=new g.Trigger;this.operation=new g.Trigger;this.children=[];this.state=SceneState.Standby;this.stateChanged=new g.Trigger;this._assetHolders=[];this._sceneAssetHolder=new SceneAssetHolder({scene:this,assetManager:this.game._assetManager,assetIds:assetIds,handler:this._onSceneAssetsLoad,handlerOwner:this,direct:true})}Scene.prototype.modified=function(isBubbling){this.game.modified=true};Scene.prototype.destroy=function(){this.state=SceneState.BeforeDestroyed;this.stateChanged.fire(this.state);var gameDb=this.game.db;for(var p in gameDb){if(gameDb.hasOwnProperty(p)&&gameDb[p].scene===this)gameDb[p].destroy()}var gameDb=this.game._localDb;for(var p in gameDb){if(gameDb.hasOwnProperty(p)&&gameDb[p].scene===this)gameDb[p].destroy()}this._timer.destroy();this.update.destroy();this.message.destroy();this.pointDownCapture.destroy();this.pointMoveCapture.destroy();this.pointUpCapture.destroy();this.operation.destroy();this.loaded.destroy();this.assetLoaded.destroy();this.assetLoadFailed.destroy();this.assetLoadCompleted.destroy();this.assets={};for(var i=0;i<this._assetHolders.length;++i)this._assetHolders[i].destroy();this._sceneAssetHolder.destroy();this._storageLoader=undefined;this.game=undefined;this.state=SceneState.Destroyed;this.stateChanged.fire(this.state);this.stateChanged.destroy()};Scene.prototype.destroyed=function(){return this.game===undefined};Scene.prototype.createTimer=function(interval){return this._timer.createTimer(interval)};Scene.prototype.deleteTimer=function(timer){this._timer.deleteTimer(timer)};Scene.prototype.setInterval=function(handler,interval,owner){var t=this._timer;if(typeof handler==="number"){this.game.logger.warn("[deprecated] Scene#setInterval(): this arguments ordering is now deprecated. Specify the function first.");return owner!=null?t.setInterval(owner,handler,interval):t.setInterval(interval,handler,null)}return t.setInterval(handler,interval,owner)};Scene.prototype.clearInterval=function(identifier){this._timer.clearInterval(identifier)};Scene.prototype.setTimeout=function(handler,milliseconds,owner){var t=this._timer;if(typeof handler==="number"){this.game.logger.warn("[deprecated] Scene#setTimeout(): this arguments ordering is now deprecated. Specify the function first.");return owner!=null?t.setTimeout(owner,handler,milliseconds):t.setTimeout(milliseconds,handler,null)}return t.setTimeout(handler,milliseconds,owner)};Scene.prototype.clearTimeout=function(identifier){this._timer.clearTimeout(identifier)};Scene.prototype.isCurrentScene=function(){
return this.game.scene()===this};Scene.prototype.gotoScene=function(next,toPush){if(!this.isCurrentScene())throw g.ExceptionFactory.createAssertionError("Scene#gotoScene: this scene is not the current scene");if(toPush){this.game.pushScene(next)}else{this.game.replaceScene(next)}};Scene.prototype.end=function(){if(!this.isCurrentScene())throw g.ExceptionFactory.createAssertionError("Scene#end: this scene is not the current scene");this.game.popScene()};Scene.prototype.register=function(e){this.game.register(e);e.scene=this};Scene.prototype.unregister=function(e){e.scene=undefined;this.game.unregister(e)};Scene.prototype.append=function(e){this.insertBefore(e,undefined)};Scene.prototype.insertBefore=function(e,target){if(e.parent)e.remove();e.parent=this;var index=-1;if(target!==undefined&&(index=this.children.indexOf(target))>-1){this.children.splice(index,0,e)}else{this.children.push(e)}this.modified(true)};Scene.prototype.remove=function(e){var index=this.children.indexOf(e);if(index===-1)return;this.children[index].parent=undefined;this.children.splice(index,1);this.modified(true)};Scene.prototype.findPointSourceByPoint=function(point,force,camera){var mayConsumeLocalTick=this.local!==g.LocalTickMode.NonLocal;var children=this.children;var m=undefined;if(camera&&camera instanceof g.Camera2D)m=camera.getMatrix();for(var i=children.length-1;i>=0;--i){var ret=children[i].findPointSourceByPoint(point,m,force,camera);if(ret){ret.local=ret.target.local||mayConsumeLocalTick;return ret}}return{target:undefined,point:undefined,local:mayConsumeLocalTick}};Scene.prototype.prefetch=function(){if(this._loaded){return}if(this._prefetchRequested)return;this._prefetchRequested=true;this._sceneAssetHolder.request()};Scene.prototype.serializeStorageValues=function(){if(!this._storageLoader)return undefined;return this._storageLoader._valueStoreSerialization};Scene.prototype.requestAssets=function(assetIds,handler){if(this._loadingState<SceneLoadState.ReadyFired){throw g.ExceptionFactory.createAssertionError("Scene#requestAsset(): can be called after loaded.")}var holder=new SceneAssetHolder({scene:this,assetManager:this.game._assetManager,assetIds:assetIds,handler:handler});this._assetHolders.push(holder);holder.request()};Scene.prototype._activate=function(){this.state=SceneState.Active;this.stateChanged.fire(this.state)};Scene.prototype._deactivate=function(){this.state=SceneState.Deactive;this.stateChanged.fire(this.state)};Scene.prototype._needsLoading=function(){return this._sceneAssetHolder.waitingAssetsCount>0||this._storageLoader&&!this._storageLoader._loaded};Scene.prototype._load=function(){if(this._loaded)return;this._loaded=true;var needsWait=this._sceneAssetHolder.request();if(this._storageLoader){this._storageLoader._load(this);needsWait=true}if(!needsWait)this._notifySceneReady()};Scene.prototype._onSceneAssetsLoad=function(){if(!this._loaded){return}if(this._storageLoader&&!this._storageLoader._loaded){return}this._notifySceneReady()};Scene.prototype._onStorageLoadError=function(error){this.game.terminateGame()};Scene.prototype._onStorageLoaded=function(){if(this._sceneAssetHolder.waitingAssetsCount===0)this._notifySceneReady()};Scene.prototype._notifySceneReady=function(){this._loadingState=SceneLoadState.Ready;this.game._fireSceneReady(this)};Scene.prototype._fireReady=function(){this._ready.fire(this);this._loadingState=SceneLoadState.ReadyFired};Scene.prototype._fireLoaded=function(){this.loaded.fire(this);this._loadingState=SceneLoadState.LoadedFired};return Scene}();g.Scene=Scene})(g||(g={}));var g;(function(g){var LoadingScene=function(_super){__extends(LoadingScene,_super);function LoadingScene(param){var _this=this;param.local=true;_this=_super.call(this,param)||this;_this.targetReset=new g.Trigger;_this.targetReady=new g.Trigger;_this.targetAssetLoaded=new g.Trigger;_this._explicitEnd=!!param.explicitEnd;_this._targetScene=undefined;return _this}LoadingScene.prototype.destroy=function(){this._clearTargetScene();_super.prototype.destroy.call(this)};LoadingScene.prototype.reset=function(targetScene){this._clearTargetScene();this._targetScene=targetScene;if(this._loadingState<g.SceneLoadState.LoadedFired){this.loaded.addOnce(this._doReset,this)}else{this._doReset()}};LoadingScene.prototype.getTargetWaitingAssetsCount=function(){return this._targetScene?this._targetScene._sceneAssetHolder.waitingAssetsCount:0};LoadingScene.prototype.end=function(){if(!this._targetScene||this._targetScene._loadingState<g.SceneLoadState.Ready){var state=this._targetScene?g.SceneLoadState[this._targetScene._loadingState]:"(no scene)";var msg="LoadingScene#end(): the target scene is in invalid state: "+state;throw g.ExceptionFactory.createAssertionError(msg)}this.game.popScene(true);this.game._fireSceneLoaded(this._targetScene);this._clearTargetScene()};LoadingScene.prototype._clearTargetScene=function(){if(!this._targetScene)return;this._targetScene._ready.removeAll({owner:this});this._targetScene.assetLoaded.removeAll({owner:this});this._targetScene=undefined};LoadingScene.prototype._doReset=function(){this.targetReset.fire(this._targetScene);if(this._targetScene._loadingState<g.SceneLoadState.ReadyFired){this._targetScene._ready.add(this._fireTriggerOnTargetReady,this);this._targetScene.assetLoaded.add(this._fireTriggerOnTargetAssetLoad,this);this._targetScene._load()}else{this._fireTriggerOnTargetReady(this._targetScene)}};LoadingScene.prototype._fireTriggerOnTargetAssetLoad=function(asset){this.targetAssetLoaded.fire(asset)};LoadingScene.prototype._fireTriggerOnTargetReady=function(scene){this.targetReady.fire(scene);if(!this._explicitEnd){this.end()}};return LoadingScene}(g.Scene);g.LoadingScene=LoadingScene})(g||(g={}));var g;(function(g){var CameraCancellingE=function(_super){__extends(CameraCancellingE,_super);function CameraCancellingE(param){var _this=_super.call(this,param)||this;_this._canceller=new g.Object2D;return _this}CameraCancellingE.prototype.renderSelf=function(renderer,camera){if(!this.children)return false;if(camera){var c=camera;var canceller=this._canceller;if(c.x!==canceller.x||c.y!==canceller.y||c.angle!==canceller.angle||c.scaleX!==canceller.scaleX||c.scaleY!==canceller.scaleY){canceller.x=c.x;canceller.y=c.y;canceller.angle=c.angle;canceller.scaleX=c.scaleX;canceller.scaleY=c.scaleY;if(canceller._matrix){canceller._matrix._modified=true}}renderer.save();renderer.transform(canceller.getMatrix()._matrix)}var children=this.children;for(var i=0;i<children.length;++i)children[i].render(renderer,camera);if(camera){renderer.restore()}return false};return CameraCancellingE}(g.E);var DefaultLoadingScene=function(_super){__extends(DefaultLoadingScene,_super);function DefaultLoadingScene(param){var _this=_super.call(this,{game:param.game,name:"akashic:default-loading-scene"})||this;_this._barWidth=Math.min(param.game.width,Math.max(100,param.game.width/2));_this._barHeight=5;_this._gauge=undefined;_this._gaugeUpdateCount=0;_this._totalWaitingAssetCount=0;_this.loaded.handle(_this,_this._onLoaded);_this.targetReset.handle(_this,_this._onTargetReset);_this.targetAssetLoaded.handle(_this,_this._onTargetAssetLoaded);return _this}DefaultLoadingScene.prototype._onLoaded=function(){var gauge;this.append(new CameraCancellingE({scene:this,children:[new g.FilledRect({scene:this,width:this.game.width,height:this.game.height,cssColor:"rgba(0, 0, 0, 0.8)",children:[new g.FilledRect({scene:this,x:(this.game.width-this._barWidth)/2,y:(this.game.height-this._barHeight)/2,width:this._barWidth,height:this._barHeight,cssColor:"gray",children:[gauge=new g.FilledRect({scene:this,width:0,height:this._barHeight,cssColor:"white"})]})]})]}));gauge.update.handle(this,this._onUpdateGuage);this._gauge=gauge;return true};DefaultLoadingScene.prototype._onUpdateGuage=function(){var BLINK_RANGE=50;var BLINK_PER_SEC=2/3;++this._gaugeUpdateCount;var c=Math.round(255-BLINK_RANGE+Math.sin(this._gaugeUpdateCount/this.game.fps*BLINK_PER_SEC*(2*Math.PI))*BLINK_RANGE);this._gauge.cssColor="rgb("+c+","+c+","+c+")";this._gauge.modified()};DefaultLoadingScene.prototype._onTargetReset=function(targetScene){if(this._gauge){this._gauge.width=0;this._gauge.modified()}this._totalWaitingAssetCount=targetScene._sceneAssetHolder.waitingAssetsCount};DefaultLoadingScene.prototype._onTargetAssetLoaded=function(asset){var waitingAssetsCount=this._targetScene._sceneAssetHolder.waitingAssetsCount;this._gauge.width=Math.ceil((1-waitingAssetsCount/this._totalWaitingAssetCount)*this._barWidth);this._gauge.modified()};return DefaultLoadingScene}(g.LoadingScene);g.DefaultLoadingScene=DefaultLoadingScene})(g||(g={}));var g;(function(g){var Sprite=function(_super){__extends(Sprite,_super);function Sprite(param){var _this=_super.call(this,param)||this;_this.surface=g.Util.asSurface(param.src);if(!("width"in param))_this.width=_this.surface.width;if(!("height"in param))_this.height=_this.surface.height;_this.srcWidth="srcWidth"in param?param.srcWidth:_this.width;_this.srcHeight="srcHeight"in param?param.srcHeight:_this.height;_this.srcX=param.srcX||0;_this.srcY=param.srcY||0;_this._stretchMatrix=undefined;_this._beforeSurface=_this.surface;g.Util.setupAnimatingHandler(_this,_this.surface);_this._invalidateSelf();return _this}Sprite.prototype._onUpdate=function(){this.modified()};Sprite.prototype._onAnimatingStarted=function(){if(!this.update.contains(this._onUpdate,this)){this.update.add(this._onUpdate,this)}};Sprite.prototype._onAnimatingStopped=function(){if(!this.destroyed()){this.update.remove(this._onUpdate,this)}};Sprite.prototype.renderSelf=function(renderer,camera){if(this.srcWidth<=0||this.srcHeight<=0){return true}if(this._stretchMatrix){renderer.save();renderer.transform(this._stretchMatrix._matrix)}renderer.drawImage(this.surface,this.srcX,this.srcY,this.srcWidth,this.srcHeight,0,0);if(this._stretchMatrix)renderer.restore();return true};Sprite.prototype.invalidate=function(){this._invalidateSelf();this.modified()};Sprite.prototype.destroy=function(destroySurface){if(this.surface&&!this.surface.destroyed()){if(destroySurface){this.surface.destroy()}else if(this.surface.isDynamic){this.surface.animatingStarted.remove(this._onAnimatingStarted,this);this.surface.animatingStopped.remove(this._onAnimatingStopped,this)}}this.surface=undefined;_super.prototype.destroy.call(this)};Sprite.prototype._invalidateSelf=function(){if(this.width===this.srcWidth&&this.height===this.srcHeight){this._stretchMatrix=undefined}else{this._stretchMatrix=g.Util.createMatrix();this._stretchMatrix.scale(this.width/this.srcWidth,this.height/this.srcHeight)}if(this.surface!==this._beforeSurface){g.Util.migrateAnimatingHandler(this,this._beforeSurface,this.surface);this._beforeSurface=this.surface}};return Sprite}(g.E);g.Sprite=Sprite})(g||(g={}));var g;(function(g){var FrameSprite=function(_super){__extends(FrameSprite,_super);function FrameSprite(param){var _this=_super.call(this,param)||this;_this._lastUsedIndex=0;_this.frameNumber=param.frameNumber||0;_this.frames="frames"in param?param.frames:[0];_this.interval=param.interval;_this._timer=undefined;_this._modifiedSelf();return _this}FrameSprite.createBySprite=function(sprite,width,height){var frameSprite=new FrameSprite({scene:sprite.scene,src:sprite.surface,width:width===undefined?sprite.width:width,height:height===undefined?sprite.height:height});frameSprite.srcHeight=height===undefined?sprite.srcHeight:height;frameSprite.srcWidth=width===undefined?sprite.srcWidth:width;return frameSprite};FrameSprite.prototype.start=function(){if(this.interval===undefined)this.interval=1e3/this.game().fps;if(this._timer)this._free();this._timer=this.scene.createTimer(this.interval);this._timer.elapsed.add(this._onElapsed,this)};FrameSprite.prototype.destroy=function(destroySurface){this.stop();_super.prototype.destroy.call(this,destroySurface)};FrameSprite.prototype.stop=function(){if(this._timer)this._free()};FrameSprite.prototype.modified=function(isBubbling){this._modifiedSelf(isBubbling);_super.prototype.modified.call(this,isBubbling)};FrameSprite.prototype._onElapsed=function(){if(++this.frameNumber>=this.frames.length)this.frameNumber=0;this.modified()};FrameSprite.prototype._free=function(){if(!this._timer)return;this._timer.elapsed.remove(this._onElapsed,this);if(this._timer.canDelete())this.scene.deleteTimer(this._timer);this._timer=undefined};FrameSprite.prototype._changeFrame=function(){var frame=this.frames[this.frameNumber];var sep=Math.floor(this.surface.width/this.srcWidth);this.srcX=frame%sep*this.srcWidth;this.srcY=Math.floor(frame/sep)*this.srcHeight;this._lastUsedIndex=frame};FrameSprite.prototype._modifiedSelf=function(isBubbling){if(this._lastUsedIndex!==this.frames[this.frameNumber])this._changeFrame()};return FrameSprite}(g.Sprite);g.FrameSprite=FrameSprite})(g||(g={}));var g;(function(g){var EventType;(function(EventType){EventType[EventType["Unknown"]=0]="Unknown";EventType[EventType["Join"]=1]="Join";EventType[EventType["Leave"]=2]="Leave";EventType[EventType["Timestamp"]=3]="Timestamp";EventType[EventType["Seed"]=4]="Seed";EventType[EventType["PointDown"]=5]="PointDown";EventType[EventType["PointMove"]=6]="PointMove";EventType[EventType["PointUp"]=7]="PointUp";EventType[EventType["Message"]=8]="Message";EventType[EventType["Operation"]=9]="Operation"})(EventType=g.EventType||(g.EventType={}));var PointEvent=function(){function PointEvent(pointerId,target,point,player,local,priority){this.priority=priority;this.local=local;this.player=player;this.pointerId=pointerId;this.target=target;this.point=point}return PointEvent}();g.PointEvent=PointEvent;var PointDownEvent=function(_super){__extends(PointDownEvent,_super);function PointDownEvent(pointerId,target,point,player,local,priority){var _this=_super.call(this,pointerId,target,point,player,local,priority)||this;_this.type=EventType.PointDown;return _this}return PointDownEvent}(PointEvent);g.PointDownEvent=PointDownEvent;var PointUpEvent=function(_super){__extends(PointUpEvent,_super);function PointUpEvent(pointerId,target,point,prevDelta,startDelta,player,local,priority){var _this=_super.call(this,pointerId,target,point,player,local,priority)||this;_this.type=EventType.PointUp;_this.prevDelta=prevDelta;_this.startDelta=startDelta;return _this}return PointUpEvent}(PointEvent);g.PointUpEvent=PointUpEvent;var PointMoveEvent=function(_super){__extends(PointMoveEvent,_super);function PointMoveEvent(pointerId,target,point,prevDelta,startDelta,player,local,priority){var _this=_super.call(this,pointerId,target,point,player,local,priority)||this;_this.type=EventType.PointMove;_this.prevDelta=prevDelta;_this.startDelta=startDelta;return _this}return PointMoveEvent}(PointEvent);g.PointMoveEvent=PointMoveEvent;var MessageEvent=function(){function MessageEvent(data,player,local,priority){this.type=EventType.Message;this.priority=priority;this.local=local;this.player=player;this.data=data}return MessageEvent}();g.MessageEvent=MessageEvent;var OperationEvent=function(){function OperationEvent(code,data,player,local,priority){this.type=EventType.Operation;this.priority=priority;this.local=local;this.player=player;this.code=code;this.data=data}return OperationEvent}();g.OperationEvent=OperationEvent;var JoinEvent=function(){function JoinEvent(player,storageValues,priority){this.type=EventType.Join;this.priority=priority;this.player=player;this.storageValues=storageValues}return JoinEvent}();g.JoinEvent=JoinEvent;var LeaveEvent=function(){function LeaveEvent(player,priority){this.type=EventType.Leave;this.priority=priority;this.player=player}return LeaveEvent}();g.LeaveEvent=LeaveEvent;var TimestampEvent=function(){function TimestampEvent(timestamp,player,priority){this.type=EventType.Timestamp;this.priority=priority;this.player=player;this.timestamp=timestamp}return TimestampEvent}();g.TimestampEvent=TimestampEvent;var SeedEvent=function(){function SeedEvent(generator,priority){this.type=EventType.Seed;this.priority=priority;this.generator=generator}return SeedEvent}();g.SeedEvent=SeedEvent})(g||(g={}));var g;(function(g){var LogLevel;(function(LogLevel){LogLevel[LogLevel["Error"]=0]="Error";LogLevel[LogLevel["Warn"]=1]="Warn";LogLevel[LogLevel["Info"]=2]="Info";LogLevel[LogLevel["Debug"]=3]="Debug"})(LogLevel=g.LogLevel||(g.LogLevel={}));var Logger=function(){function Logger(game){this.game=game;this.logging=new g.Trigger}Logger.prototype.error=function(message,cause){this.logging.fire({game:this.game,level:LogLevel.Error,message:message,cause:cause})};Logger.prototype.warn=function(message,cause){this.logging.fire({game:this.game,level:LogLevel.Warn,message:message,cause:cause})};Logger.prototype.info=function(message,cause){this.logging.fire({game:this.game,level:LogLevel.Info,message:message,cause:cause})};Logger.prototype.debug=function(message,cause){this.logging.fire({game:this.game,level:LogLevel.Debug,message:message,cause:cause})};return Logger}();g.Logger=Logger})(g||(g={}));var g;(function(g){var Game=function(){function Game(gameConfiguration,resourceFactory,assetBase,selfId,operationPluginViewInfo){gameConfiguration=this._normalizeConfiguration(gameConfiguration);this.fps=gameConfiguration.fps;this.width=gameConfiguration.width;this.height=gameConfiguration.height;this.renderers=[];this.scenes=[];this.random=null;this.age=0;this.assetBase=assetBase||"";this.resourceFactory=resourceFactory;this.selfId=selfId||undefined;this.playId=undefined;this._audioSystemManager=new g.AudioSystemManager(this);this.audio={music:new g.MusicAudioSystem("music",this),sound:new g.SoundAudioSystem("sound",this)};this.defaultAudioSystemId="sound";this.storage=new g.Storage(this);this.assets={};this.join=new g.Trigger;this.leave=new g.Trigger;this.seed=new g.Trigger;this._eventTriggerMap={};this._eventTriggerMap[g.EventType.Join]=this.join;this._eventTriggerMap[g.EventType.Leave]=this.leave;this._eventTriggerMap[g.EventType.Seed]=this.seed;this._eventTriggerMap[g.EventType.Message]=undefined;this._eventTriggerMap[g.EventType.PointDown]=undefined;this._eventTriggerMap[g.EventType.PointMove]=undefined;this._eventTriggerMap[g.EventType.PointUp]=undefined;this._eventTriggerMap[g.EventType.Operation]=undefined;this.resized=new g.Trigger;this._loaded=new g.Trigger;this._started=new g.Trigger;this.isLoaded=false;this.snapshotRequest=new g.Trigger;this.external={};this.logger=new g.Logger(this);this._main=gameConfiguration.main;this._mainParameter=undefined;this._configuration=gameConfiguration;this._assetManager=new g.AssetManager(this,gameConfiguration.assets,gameConfiguration.audio,gameConfiguration.moduleMainScripts);var operationPluginsField=gameConfiguration.operationPlugins||[];this._operationPluginManager=new g.OperationPluginManager(this,operationPluginViewInfo,operationPluginsField);this._operationPluginOperated=new g.Trigger;this._operationPluginManager.operated.add(this._operationPluginOperated.fire,this._operationPluginOperated);this._sceneChanged=new g.Trigger;this._sceneChanged.add(this._updateEventTriggers,this);this._initialScene=new g.Scene({game:this,assetIds:this._assetManager.globalAssetIds(),local:true,name:"akashic:initial-scene"});this._initialScene.loaded.add(this._onInitialSceneLoaded,this);this._reset({age:0})}Object.defineProperty(Game.prototype,"focusingCamera",{get:function(){return this._focusingCamera},set:function(c){if(c===this._focusingCamera)return;if(this.modified)this.render(this._focusingCamera);this._focusingCamera=c},enumerable:true,configurable:true});Game.prototype.pushScene=function(scene){this._sceneChangeRequests.push({type:0,scene:scene})};Game.prototype.replaceScene=function(scene,preserveCurrent){this._sceneChangeRequests.push({type:1,scene:scene,preserveCurrent:preserveCurrent})};Game.prototype.popScene=function(preserveCurrent){this._sceneChangeRequests.push({type:2,preserveCurrent:preserveCurrent})};Game.prototype.scene=function(){if(!this.scenes.length)return undefined;return this.scenes[this.scenes.length-1]};Game.prototype.tick=function(advanceAge){var scene=undefined;if(this._isTerminated)return false;if(this.scenes.length){scene=this.scenes[this.scenes.length-1];if(this.events.length){var events=this.events;this.events=[];for(var i=0;i<events.length;++i){var trigger=this._eventTriggerMap[events[i].type];if(trigger)trigger.fire(events[i])}}scene.update.fire();if(advanceAge===true||advanceAge===undefined&&scene.local!==g.LocalTickMode.FullLocal){++this.age}}if(this._sceneChangeRequests.length){this._flushSceneChangeRequests();return scene!==this.scenes[this.scenes.length-1]}return false};Game.prototype.render=function(camera){if(!camera)camera=this.focusingCamera;var renderers=this.renderers;for(var i=0;i<renderers.length;++i)renderers[i].draw(this,camera);this.modified=false};Game.prototype.findPointSource=function(point,camera){if(!camera)camera=this.focusingCamera;return this.scene().findPointSourceByPoint(point,false,camera)};Game.prototype.register=function(e){if(e.local){if(e.id===undefined){e.id=--this._localIdx}else{if(e.id>0)throw g.ExceptionFactory.createAssertionError("Game#register: invalid local id: "+e.id);if(this._localDb.hasOwnProperty(String(e.id)))throw g.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+e.id);if(this._localIdx>e.id)this._localIdx=e.id}this._localDb[e.id]=e}else{if(e.id===undefined){e.id=++this._idx}else{if(e.id<0)throw g.ExceptionFactory.createAssertionError("Game#register: invalid non-local id: "+e.id);if(this.db.hasOwnProperty(String(e.id)))throw g.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+e.id);if(this._idx<e.id)this._idx=e.id}this.db[e.id]=e}};Game.prototype.unregister=function(e){if(e.local){delete this._localDb[e.id]}else{delete this.db[e.id]}};Game.prototype.leaveGame=function(){this._leaveGame()};Game.prototype.terminateGame=function(){this._leaveGame();this._isTerminated=true;this._terminateGame()};Game.prototype._fireSceneReady=function(scene){this._sceneChangeRequests.push({type:3,scene:scene})};Game.prototype._fireSceneLoaded=function(scene){if(scene._loadingState<g.SceneLoadState.LoadedFired){this._sceneChangeRequests.push({type:4,scene:scene})}};Game.prototype._callSceneAssetHolderHandler=function(assetHolder){this._sceneChangeRequests.push({type:5,assetHolder:assetHolder})};Game.prototype._normalizeConfiguration=function(gameConfiguration){if(!gameConfiguration)throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: invalid arguments");if(!("assets"in gameConfiguration))gameConfiguration.assets={};if(!("fps"in gameConfiguration))gameConfiguration.fps=30;if(typeof gameConfiguration.fps!=="number")throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be given as a number");if(!(0<=gameConfiguration.fps&&gameConfiguration.fps<=60))throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be a number in (0, 60].");if(typeof gameConfiguration.width!=="number")throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: width must be given as a number");if(typeof gameConfiguration.height!=="number")throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: height must be given as a number");return gameConfiguration};Game.prototype._setAudioPlaybackRate=function(playbackRate){this._audioSystemManager._setPlaybackRate(playbackRate)};Game.prototype._setMuted=function(muted){this._audioSystemManager._setMuted(muted)};Game.prototype._decodeOperationPluginOperation=function(code,op){var plugins=this._operationPluginManager.plugins;if(!plugins[code]||!plugins[code].decode)return op;return plugins[code].decode(op)};Game.prototype._reset=function(param){this._operationPluginManager.stopAll();if(this.scene()){while(this.scene()!==this._initialScene){this.popScene();this._flushSceneChangeRequests()}if(!this.isLoaded){this.scenes.pop()}}if(param){if(param.age!==undefined)this.age=param.age;if(param.randGen!==undefined)this.random=param.randGen}this._loaded.removeAll({func:this._start,owner:this});this.join.removeAll();this.leave.removeAll();this.seed.removeAll();this.resized.removeAll();this._idx=0;this._localIdx=0;this._cameraIdx=0;this.db={};this._localDb={};this.events=[];this.modified=true;this.loadingScene=undefined;this._focusingCamera=undefined;this._scriptCaches={};this.snapshotRequest.removeAll();this._sceneChangeRequests=[];this._isTerminated=false;this.vars={};switch(this._configuration.defaultLoadingScene){case"none":this._defaultLoadingScene=new g.LoadingScene({game:this});break;default:this._defaultLoadingScene=new g.DefaultLoadingScene({game:this});break}};Game.prototype._loadAndStart=function(param){this._mainParameter=param||{};if(!this.isLoaded){this._loaded.add(this._start,this);this.pushScene(this._initialScene);this._flushSceneChangeRequests()}else{this._start()}};Game.prototype._startLoadingGlobalAssets=function(){if(this.isLoaded)throw g.ExceptionFactory.createAssertionError("Game#_startLoadingGlobalAssets: already loaded.");this.pushScene(this._initialScene);this._flushSceneChangeRequests()};Game.prototype._updateEventTriggers=function(scene){this.modified=true;if(!scene){this._eventTriggerMap[g.EventType.Message]=undefined;this._eventTriggerMap[g.EventType.PointDown]=undefined;this._eventTriggerMap[g.EventType.PointMove]=undefined;this._eventTriggerMap[g.EventType.PointUp]=undefined;this._eventTriggerMap[g.EventType.Operation]=undefined;return}this._eventTriggerMap[g.EventType.Message]=scene.message;this._eventTriggerMap[g.EventType.PointDown]=scene.pointDownCapture;this._eventTriggerMap[g.EventType.PointMove]=scene.pointMoveCapture;this._eventTriggerMap[g.EventType.PointUp]=scene.pointUpCapture;this._eventTriggerMap[g.EventType.Operation]=scene.operation;scene._activate()};Game.prototype._onInitialSceneLoaded=function(){this._initialScene.loaded.remove(this._onInitialSceneLoaded,this);this.assets=this._initialScene.assets;this.isLoaded=true;this._loaded.fire()};Game.prototype._terminateGame=function(){};Game.prototype._flushSceneChangeRequests=function(){do{var reqs=this._sceneChangeRequests;this._sceneChangeRequests=[];for(var i=0;i<reqs.length;++i){var req=reqs[i];switch(req.type){case 0:var oldScene=this.scene();if(oldScene){oldScene._deactivate()}this._doPushScene(req.scene);break;case 1:this._doPopScene(req.preserveCurrent,false);this._doPushScene(req.scene);break;case 2:this._doPopScene(req.preserveCurrent,true);break;case 3:if(!req.scene.destroyed())req.scene._fireReady();break;case 4:if(!req.scene.destroyed())req.scene._fireLoaded();break;case 5:req.assetHolder.callHandler();break;default:throw g.ExceptionFactory.createAssertionError("Game#_flushSceneChangeRequests: unknown scene change request.")}}}while(this._sceneChangeRequests.length>0)};Game.prototype._doPopScene=function(preserveCurrent,fireSceneChanged){var scene=this.scenes.pop();if(scene===this._initialScene)throw g.ExceptionFactory.createAssertionError("Game#_doPopScene: invalid call; attempting to pop the initial scene");if(!preserveCurrent)scene.destroy();if(fireSceneChanged)this._sceneChanged.fire(this.scene())};Game.prototype._start=function(){this._operationPluginManager.initialize();this.operationPlugins=this._operationPluginManager.plugins;if(!this._main){if(!this._mainParameter.snapshot){if(!this.assets.mainScene)throw g.ExceptionFactory.createAssertionError("Game#_start: global asset 'mainScene' not found.");var mainScene=g._require(this,"mainScene")();this.pushScene(mainScene);this._flushSceneChangeRequests()}else{if(!this.assets.snapshotLoader)throw g.ExceptionFactory.createAssertionError("Game#_start: global asset 'snapshotLoader' not found.");var loader=g._require(this,"snapshotLoader");loader(this._mainParameter.snapshot);this._flushSceneChangeRequests()}this._started.fire();return}var mainFun=g._require(this,this._main);if(!mainFun||typeof mainFun!=="function")throw g.ExceptionFactory.createAssertionError("Game#_start: Entry point '"+this._main+"' not found.");mainFun(this._mainParameter);this._flushSceneChangeRequests();this._started.fire()};Game.prototype._doPushScene=function(scene,loadingScene){if(!loadingScene)loadingScene=this.loadingScene||this._defaultLoadingScene;this.scenes.push(scene);if(scene._needsLoading()&&scene._loadingState<g.SceneLoadState.LoadedFired){if(this._defaultLoadingScene._needsLoading())throw g.ExceptionFactory.createAssertionError("Game#_doPushScene: _defaultLoadingScene must not depend on any assets/storages.");this._doPushScene(loadingScene,this._defaultLoadingScene);loadingScene.reset(scene)}else{this._sceneChanged.fire(scene);if(!scene._loaded){scene._load();this._fireSceneLoaded(scene)}}this.modified=true};return Game}();g.Game=Game})(g||(g={}));var g;(function(g){var Camera2D=function(_super){__extends(Camera2D,_super);function Camera2D(param){var _this=_super.call(this,param)||this;_this.game=param.game;_this.local=!!param.local;_this.name=param.name;_this._modifiedCount=0;_this.width=param.game.width;_this.height=param.game.height;_this.id=_this.local?undefined:_this.game._cameraIdx++;return _this}Camera2D.deserialize=function(ser,game){var s=ser;s.param.game=game;var ret=new Camera2D(s.param);ret.id=s.id;return ret};Camera2D.prototype.modified=function(){this._modifiedCount=(this._modifiedCount+1)%32768;if(this._matrix)this._matrix._modified=true;this.game.modified=true};Camera2D.prototype.serialize=function(){var ser={id:this.id,param:{game:undefined,local:this.local,name:this.name,x:this.x,y:this.y,width:this.width,height:this.height,opacity:this.opacity,scaleX:this.scaleX,scaleY:this.scaleY,angle:this.angle,compositeOperation:this.compositeOperation}};return ser};Camera2D.prototype._applyTransformToRenderer=function(renderer){if(this.angle||this.scaleX!==1||this.scaleY!==1){renderer.transform(this.getMatrix()._matrix)}else{renderer.translate(-this.x,-this.y)}if(this.opacity!==1)renderer.opacity(this.opacity)};Camera2D.prototype._updateMatrix=function(){if(this.angle||this.scaleX!==1||this.scaleY!==1){this._matrix.updateByInverse(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y)}else{this._matrix.reset(-this.x,-this.y)}};return Camera2D}(g.Object2D);g.Camera2D=Camera2D})(g||(g={}));var g;(function(g){var Renderer=function(){function Renderer(){}Renderer.prototype.draw=function(game,camera){var scene=game.scene();if(!scene)return;this.begin();this.clear();if(camera){this.save();camera._applyTransformToRenderer(this)}var children=scene.children;for(var i=0;i<children.length;++i)children[i].render(this,camera);if(camera){this.restore()}this.end()};Renderer.prototype.begin=function(){};Renderer.prototype.end=function(){};return Renderer}();g.Renderer=Renderer})(g||(g={}));var g;(function(g){var Surface=function(){function Surface(width,height,drawable,isDynamic){if(isDynamic===void 0){isDynamic=false}if(width%1!==0||height%1!==0){throw g.ExceptionFactory.createAssertionError("Surface#constructor: width and height must be integers")}this.width=width;this.height=height;if(drawable)this._drawable=drawable;this.isDynamic=isDynamic;if(this.isDynamic){this.animatingStarted=new g.Trigger;this.animatingStopped=new g.Trigger}else{this.animatingStarted=undefined;this.animatingStopped=undefined}}Surface.prototype.destroy=function(){if(this.animatingStarted){this.animatingStarted.destroy()}if(this.animatingStopped){this.animatingStopped.destroy()}this._destroyed=true};Surface.prototype.destroyed=function(){return!!this._destroyed};return Surface}();g.Surface=Surface})(g||(g={}));var g;(function(g){var Label=function(_super){__extends(Label,_super);function Label(param){var _this=_super.call(this,param)||this;_this.text=param.text;_this.font=param.font;_this.textAlign="textAlign"in param?param.textAlign:g.TextAlign.Left;_this.glyphs=new Array(param.text.length);_this.fontSize=param.fontSize;_this.maxWidth=param.maxWidth;_this.widthAutoAdjust="widthAutoAdjust"in param?param.widthAutoAdjust:true;_this.textColor=param.textColor;_this._textWidth=0;_this._game=undefined
;_this._invalidateSelf();return _this}Label.prototype.aligning=function(width,textAlign){this.width=width;this.widthAutoAdjust=false;this.textAlign=textAlign};Label.prototype.invalidate=function(){this._invalidateSelf();_super.prototype.invalidate.call(this)};Label.prototype.renderCache=function(renderer){if(!this.fontSize||this.height<=0||this._textWidth<=0){return}var textSurface=this.scene.game.resourceFactory.createSurface(Math.ceil(this._textWidth),Math.ceil(this.height));var textRenderer=textSurface.renderer();textRenderer.begin();textRenderer.save();for(var i=0;i<this.glyphs.length;++i){var glyph=this.glyphs[i];var glyphScale=this.fontSize/this.font.size;var glyphWidth=glyph.advanceWidth*glyphScale;if(glyph.surface){textRenderer.save();textRenderer.transform([glyphScale,0,0,glyphScale,0,0]);textRenderer.drawImage(glyph.surface,glyph.x,glyph.y,glyph.width,glyph.height,glyph.offsetX,glyph.offsetY);textRenderer.restore()}textRenderer.translate(glyphWidth,0)}textRenderer.restore();textRenderer.end();var scale=this.maxWidth>0&&this.maxWidth<this._textWidth?this.maxWidth/this._textWidth:1;var offsetX;switch(this.textAlign){case g.TextAlign.Center:offsetX=this.width/2-this._textWidth/2*scale;break;case g.TextAlign.Right:offsetX=this.width-this._textWidth*scale;break;default:offsetX=0;break}renderer.save();renderer.translate(offsetX,0);if(scale!==1){renderer.transform([scale,0,0,1,0,0])}renderer.drawImage(textSurface,0,0,this._textWidth,this.height,0,0);textSurface.destroy();if(this.textColor){renderer.setCompositeOperation(g.CompositeOperation.SourceAtop);renderer.fillRect(0,0,this._textWidth,this.height,this.textColor)}renderer.restore()};Label.prototype.destroy=function(){_super.prototype.destroy.call(this)};Label.prototype._invalidateSelf=function(){this.glyphs.length=0;this._textWidth=0;if(!this.fontSize){this.height=0;return}var maxHeight=0;var glyphScale=this.font.size>0?this.fontSize/this.font.size:0;for(var i=0;i<this.text.length;++i){var code=g.Util.charCodeAt(this.text,i);if(!code){continue}var glyph=this.font.glyphForCharacter(code);if(!glyph){var str=code&4294901760?String.fromCharCode((code&4294901760)>>>16,code&65535):String.fromCharCode(code);this.game().logger.warn("Label#_invalidateSelf(): failed to get a glyph for '"+str+"' "+"(BitmapFont might not have the glyph or DynamicFont might create a glyph larger than its atlas).");continue}if(glyph.width<0||glyph.height<0){continue}if(glyph.x<0||glyph.y<0){continue}this.glyphs.push(glyph);this._textWidth+=glyph.advanceWidth*glyphScale;var height=glyph.offsetY+glyph.height;if(maxHeight<height){maxHeight=height}}if(this.widthAutoAdjust){this.width=this._textWidth}this.height=maxHeight*glyphScale};return Label}(g.CacheableE);g.Label=Label})(g||(g={}));var g;(function(g){var Glyph=function(){function Glyph(code,x,y,width,height,offsetX,offsetY,advanceWidth,surface,isSurfaceValid){if(offsetX===void 0){offsetX=0}if(offsetY===void 0){offsetY=0}if(advanceWidth===void 0){advanceWidth=width}if(isSurfaceValid===void 0){isSurfaceValid=!!surface}this.code=code;this.x=x;this.y=y;this.width=width;this.height=height;this.offsetX=offsetX;this.offsetY=offsetY;this.advanceWidth=advanceWidth;this.surface=surface;this.isSurfaceValid=isSurfaceValid;this._atlas=null}Glyph.prototype.renderingWidth=function(fontSize){if(!this.width||!this.height){return 0}return fontSize/this.height*this.width};return Glyph}();g.Glyph=Glyph})(g||(g={}));var g;(function(g){var FilledRect=function(_super){__extends(FilledRect,_super);function FilledRect(param){var _this=_super.call(this,param)||this;if(typeof param.cssColor!=="string")throw g.ExceptionFactory.createTypeMismatchError("ColorBox#constructor(cssColor)","string",param.cssColor);_this.cssColor=param.cssColor;return _this}FilledRect.prototype.renderSelf=function(renderer){renderer.fillRect(0,0,this.width,this.height,this.cssColor);return true};return FilledRect}(g.E);g.FilledRect=FilledRect})(g||(g={}));var g;(function(g){var Pane=function(_super){__extends(Pane,_super);function Pane(param){var _this=_super.call(this,param)||this;_this._oldWidth=param.width;_this._oldHeight=param.height;_this.backgroundImage=g.Util.asSurface(param.backgroundImage);_this.backgroundEffector=param.backgroundEffector;_this._shouldRenderChildren=false;_this._padding=param.padding;_this._initialize();_this._paddingChanged=false;_this._bgSurface=undefined;_this._bgRenderer=undefined;return _this}Object.defineProperty(Pane.prototype,"padding",{get:function(){return this._padding},set:function(padding){this._padding=padding;this._paddingChanged=true},enumerable:true,configurable:true});Pane.prototype.modified=function(isBubbling){if(isBubbling)this.state&=~2;_super.prototype.modified.call(this)};Pane.prototype.shouldFindChildrenByPoint=function(point){var p=this._normalizedPadding;if(p.left<point.x&&this.width-p.right>point.x&&p.top<point.y&&this.height-p.bottom>point.y){return true}return false};Pane.prototype.renderCache=function(renderer,camera){if(this.width<=0||this.height<=0){return}this._renderBackground();this._renderChildren(camera);if(this._bgSurface){renderer.drawImage(this._bgSurface,0,0,this.width,this.height,0,0)}else if(this.backgroundImage){renderer.drawImage(this.backgroundImage,0,0,this.width,this.height,0,0)}if(this._childrenArea.width<=0||this._childrenArea.height<=0){return}renderer.save();if(this._childrenArea.x!==0||this._childrenArea.y!==0){renderer.translate(this._childrenArea.x,this._childrenArea.y)}renderer.drawImage(this._childrenSurface,0,0,this._childrenArea.width,this._childrenArea.height,0,0);renderer.restore()};Pane.prototype.destroy=function(destroySurface){if(destroySurface&&this.backgroundImage&&!this.backgroundImage.destroyed()){this.backgroundImage.destroy()}if(this._bgSurface&&!this._bgSurface.destroyed()){this._bgSurface.destroy()}if(this._childrenSurface&&!this._childrenSurface.destroyed()){this._childrenSurface.destroy()}this.backgroundImage=undefined;this._bgSurface=undefined;this._childrenSurface=undefined;_super.prototype.destroy.call(this)};Pane.prototype._renderBackground=function(){if(this._bgSurface&&!this._bgSurface.destroyed()){this._bgSurface.destroy()}if(this.backgroundImage&&this.backgroundEffector){this._bgSurface=this.backgroundEffector.render(this.backgroundImage,this.width,this.height)}else{this._bgSurface=undefined}};Pane.prototype._renderChildren=function(camera){var isNew=this._oldWidth!==this.width||this._oldHeight!==this.height||this._paddingChanged;if(isNew){this._initialize();this._paddingChanged=false;this._oldWidth=this.width;this._oldHeight=this.height}this._childrenRenderer.begin();if(!isNew){this._childrenRenderer.clear()}if(this.children){var children=this.children;for(var i=0;i<children.length;++i){children[i].render(this._childrenRenderer,camera)}}this._childrenRenderer.end()};Pane.prototype._initialize=function(){var p=this._padding===undefined?0:this._padding;var r;if(typeof p==="number"){r={top:p,bottom:p,left:p,right:p}}else{r=this._padding}this._childrenArea={x:r.left,y:r.top,width:this.width-r.left-r.right,height:this.height-r.top-r.bottom};var resourceFactory=this.scene.game.resourceFactory;if(this._childrenSurface&&!this._childrenSurface.destroyed()){this._childrenSurface.destroy()}this._childrenSurface=resourceFactory.createSurface(Math.ceil(this._childrenArea.width),Math.ceil(this._childrenArea.height));this._childrenRenderer=this._childrenSurface.renderer();this._normalizedPadding=r};Pane.prototype._calculateBoundingRect=function(m,c){var matrix=this.getMatrix();if(m){matrix=m.multiplyNew(matrix)}if(!this.visible()||c&&(!this._targetCameras||this._targetCameras.indexOf(c)===-1)){return undefined}var thisBoundingRect={left:0,right:this.width,top:0,bottom:this.height};var targetCoordinates=[{x:thisBoundingRect.left,y:thisBoundingRect.top},{x:thisBoundingRect.left,y:thisBoundingRect.bottom},{x:thisBoundingRect.right,y:thisBoundingRect.top},{x:thisBoundingRect.right,y:thisBoundingRect.bottom}];var convertedPoint=matrix.multiplyPoint(targetCoordinates[0]);var result={left:convertedPoint.x,right:convertedPoint.x,top:convertedPoint.y,bottom:convertedPoint.y};for(var i=1;i<targetCoordinates.length;++i){convertedPoint=matrix.multiplyPoint(targetCoordinates[i]);if(result.left>convertedPoint.x)result.left=convertedPoint.x;if(result.right<convertedPoint.x)result.right=convertedPoint.x;if(result.top>convertedPoint.y)result.top=convertedPoint.y;if(result.bottom<convertedPoint.y)result.bottom=convertedPoint.y}return result};return Pane}(g.CacheableE);g.Pane=Pane})(g||(g={}));var g;(function(g){var OperationHandler=function(){function OperationHandler(code,owner,handler){this._code=code;this._handler=handler;this._handlerOwner=owner}OperationHandler.prototype.onOperation=function(op){var iop;if(op instanceof Array){iop={_code:this._code,data:op}}else{iop=op;iop._code=this._code}this._handler.call(this._handlerOwner,iop)};return OperationHandler}();var OperationPluginManager=function(){function OperationPluginManager(game,viewInfo,infos){this.operated=new g.Trigger;this.plugins={};this._game=game;this._viewInfo=viewInfo;this._infos=infos;this._initialized=false}OperationPluginManager.prototype.initialize=function(){if(!this._initialized){this._initialized=true;this._loadOperationPlugins()}this._doAutoStart()};OperationPluginManager.prototype.destroy=function(){this.stopAll();this.operated.destroy();this.operated=undefined;this.plugins=undefined;this._game=undefined;this._viewInfo=undefined;this._infos=undefined};OperationPluginManager.prototype.stopAll=function(){if(!this._initialized)return;for(var i=0;i<this._infos.length;++i){var info=this._infos[i];if(info._plugin)info._plugin.stop()}};OperationPluginManager.prototype._doAutoStart=function(){for(var i=0;i<this._infos.length;++i){var info=this._infos[i];if(!info.manualStart&&info._plugin)info._plugin.start()}};OperationPluginManager.prototype._loadOperationPlugins=function(){for(var i=0;i<this._infos.length;++i){var info=this._infos[i];if(!info.script)continue;var pluginClass=g._require(this._game,info.script);if(!pluginClass.isSupported())continue;var plugin=new pluginClass(this._game,this._viewInfo,info.option);var code=info.code;if(this.plugins[code]){throw new Error("Plugin#code conflicted for code: "+code)}this.plugins[code]=plugin;info._plugin=plugin;var handler=new OperationHandler(code,this.operated,this.operated.fire);plugin.operationTrigger.handle(handler,handler.onOperation)}};return OperationPluginManager}();g.OperationPluginManager=OperationPluginManager})(g||(g={}));var g;(function(g){})(g||(g={}));var g;(function(g){var FontWeight;(function(FontWeight){FontWeight[FontWeight["Normal"]=0]="Normal";FontWeight[FontWeight["Bold"]=1]="Bold"})(FontWeight=g.FontWeight||(g.FontWeight={}));var SurfaceAtlasSlot=function(){function SurfaceAtlasSlot(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;this.prev=null;this.next=null}return SurfaceAtlasSlot}();g.SurfaceAtlasSlot=SurfaceAtlasSlot;function getSurfaceAtlasSlot(slot,width,height){while(slot){if(slot.width>=width&&slot.height>=height){return slot}slot=slot.next}return null}function calcAtlasSize(hint){var width=Math.ceil(Math.min(hint.initialAtlasWidth,hint.maxAtlasWidth));var height=Math.ceil(Math.min(hint.initialAtlasHeight,hint.maxAtlasHeight));return{width:width,height:height}}var SurfaceAtlas=function(){function SurfaceAtlas(surface){this._surface=surface;this._emptySurfaceAtlasSlotHead=new SurfaceAtlasSlot(0,0,this._surface.width,this._surface.height);this._accessScore=0;this._usedRectangleAreaSize={width:0,height:0}}SurfaceAtlas.prototype._acquireSurfaceAtlasSlot=function(width,height){width+=1;height+=1;var slot=getSurfaceAtlasSlot(this._emptySurfaceAtlasSlotHead,width,height);if(!slot){return null}var remainWidth=slot.width-width;var remainHeight=slot.height-height;var left;var right;if(remainWidth<=remainHeight){left=new SurfaceAtlasSlot(slot.x+width,slot.y,remainWidth,height);right=new SurfaceAtlasSlot(slot.x,slot.y+height,slot.width,remainHeight)}else{left=new SurfaceAtlasSlot(slot.x,slot.y+height,width,remainHeight);right=new SurfaceAtlasSlot(slot.x+width,slot.y,remainWidth,slot.height)}left.prev=slot.prev;left.next=right;if(left.prev===null){this._emptySurfaceAtlasSlotHead=left}else{left.prev.next=left}right.prev=left;right.next=slot.next;if(right.next){right.next.prev=right}var acquiredSlot=new SurfaceAtlasSlot(slot.x,slot.y,width,height);this._updateUsedRectangleAreaSize(acquiredSlot);return acquiredSlot};SurfaceAtlas.prototype._updateUsedRectangleAreaSize=function(slot){var slotRight=slot.x+slot.width;var slotBottom=slot.y+slot.height;if(slotRight>this._usedRectangleAreaSize.width){this._usedRectangleAreaSize.width=slotRight}if(slotBottom>this._usedRectangleAreaSize.height){this._usedRectangleAreaSize.height=slotBottom}};SurfaceAtlas.prototype.addSurface=function(surface,rect){var slot=this._acquireSurfaceAtlasSlot(rect.width,rect.height);if(!slot){return null}var renderer=this._surface.renderer();renderer.begin();renderer.drawImage(surface,rect.x,rect.y,rect.width,rect.height,slot.x,slot.y);renderer.end();return slot};SurfaceAtlas.prototype.destroy=function(){this._surface.destroy()};SurfaceAtlas.prototype.destroyed=function(){return this._surface.destroyed()};SurfaceAtlas.prototype.duplicateSurface=function(resourceFactory){var src=this._surface;var dst=resourceFactory.createSurface(this._usedRectangleAreaSize.width,this._usedRectangleAreaSize.height);var renderer=dst.renderer();renderer.begin();renderer.drawImage(src,0,0,this._usedRectangleAreaSize.width,this._usedRectangleAreaSize.height,0,0);renderer.end();return dst};return SurfaceAtlas}();g.SurfaceAtlas=SurfaceAtlas;var DynamicFont=function(){function DynamicFont(param){this.fontFamily=param.fontFamily;this.size=param.size;this.hint="hint"in param?param.hint:{};this.fontColor="fontColor"in param?param.fontColor:"black";this.fontWeight="fontWeight"in param?param.fontWeight:FontWeight.Normal;this.strokeWidth="strokeWidth"in param?param.strokeWidth:0;this.strokeColor="strokeColor"in param?param.strokeColor:"black";this.strokeOnly="strokeOnly"in param?param.strokeOnly:false;this._resourceFactory=param.game.resourceFactory;this._glyphFactory=this._resourceFactory.createGlyphFactory(this.fontFamily,this.size,this.hint.baselineHeight,this.fontColor,this.strokeWidth,this.strokeColor,this.strokeOnly,this.fontWeight);this._glyphs={};this._atlases=[];this._currentAtlasIndex=0;this._destroyed=false;this.hint.initialAtlasWidth=this.hint.initialAtlasWidth?this.hint.initialAtlasWidth:2048;this.hint.initialAtlasHeight=this.hint.initialAtlasHeight?this.hint.initialAtlasHeight:2048;this.hint.maxAtlasWidth=this.hint.maxAtlasWidth?this.hint.maxAtlasWidth:2048;this.hint.maxAtlasHeight=this.hint.maxAtlasHeight?this.hint.maxAtlasHeight:2048;this.hint.maxAtlasNum=this.hint.maxAtlasNum?this.hint.maxAtlasNum:1;this._atlasSize=calcAtlasSize(this.hint);this._atlases.push(this._resourceFactory.createSurfaceAtlas(this._atlasSize.width,this._atlasSize.height));if(this.hint.presetChars){for(var i=0,len=this.hint.presetChars.length;i<len;i++){var code=g.Util.charCodeAt(this.hint.presetChars,i);if(!code){continue}this.glyphForCharacter(code)}}}DynamicFont.prototype.glyphForCharacter=function(code){var glyph=this._glyphs[code];if(!(glyph&&glyph.isSurfaceValid)){glyph=this._glyphFactory.create(code);if(glyph.surface){if(glyph.width>this._atlasSize.width||glyph.height>this._atlasSize.height){return null}var atlas_1=this._addToAtlas(glyph);if(!atlas_1){this._reallocateAtlas();atlas_1=this._addToAtlas(glyph);if(!atlas_1){return null}}glyph._atlas=atlas_1}this._glyphs[code]=glyph}for(var i=0;i<this._atlases.length;i++){var atlas=this._atlases[i];if(atlas===glyph._atlas){atlas._accessScore+=1}atlas._accessScore/=2}return glyph};DynamicFont.prototype.asBitmapFont=function(missingGlyphChar){var _this=this;if(this._atlases.length!==1){return null}var missingGlyphCharCodePoint;if(missingGlyphChar){missingGlyphCharCodePoint=g.Util.charCodeAt(missingGlyphChar,0);this.glyphForCharacter(missingGlyphCharCodePoint)}var glyphAreaMap={};Object.keys(this._glyphs).forEach(function(_key){var key=Number(_key);var glyph=_this._glyphs[key];var glyphArea={x:glyph.x,y:glyph.y,width:glyph.width,height:glyph.height,offsetX:glyph.offsetX,offsetY:glyph.offsetY,advanceWidth:glyph.advanceWidth};glyphAreaMap[key]=glyphArea});var missingGlyph=glyphAreaMap[missingGlyphCharCodePoint];var surface=this._atlases[0].duplicateSurface(this._resourceFactory);var bitmapFont=new g.BitmapFont({src:surface,map:glyphAreaMap,defaultGlyphWidth:0,defaultGlyphHeight:this.size,missingGlyph:missingGlyph});return bitmapFont};DynamicFont.prototype._removeLowUseAtlas=function(){var minScore=Number.MAX_VALUE;var lowScoreAtlasIndex=-1;for(var i=0;i<this._atlases.length;i++){if(this._atlases[i]._accessScore<=minScore){minScore=this._atlases[i]._accessScore;lowScoreAtlasIndex=i}}var removedAtlas=this._atlases.splice(lowScoreAtlasIndex,1)[0];return removedAtlas};DynamicFont.prototype._reallocateAtlas=function(){if(this._atlases.length>=this.hint.maxAtlasNum){var atlas=this._removeLowUseAtlas();var glyphs=this._glyphs;for(var key in glyphs){if(glyphs.hasOwnProperty(key)){var glyph=glyphs[key];if(glyph.surface===atlas._surface){glyph.surface=null;glyph.isSurfaceValid=false;glyph._atlas=null}}}atlas.destroy()}this._atlases.push(this._resourceFactory.createSurfaceAtlas(this._atlasSize.width,this._atlasSize.height));this._currentAtlasIndex=this._atlases.length-1};DynamicFont.prototype._addToAtlas=function(glyph){var atlas=null;var slot=null;var area={x:glyph.x,y:glyph.y,width:glyph.width,height:glyph.height};for(var i=0;i<this._atlases.length;i++){var index=(this._currentAtlasIndex+i)%this._atlases.length;atlas=this._atlases[index];slot=atlas.addSurface(glyph.surface,area);if(slot){this._currentAtlasIndex=index;break}}if(!slot){return null}glyph.surface.destroy();glyph.surface=atlas._surface;glyph.x=slot.x;glyph.y=slot.y;return atlas};DynamicFont.prototype.destroy=function(){for(var i=0;i<this._atlases.length;i++){this._atlases[i].destroy()}this._glyphs=null;this._glyphFactory=null;this._destroyed=true};DynamicFont.prototype.destroyed=function(){return this._destroyed};return DynamicFont}();g.DynamicFont=DynamicFont})(g||(g={}));var g;(function(g){var AudioSystemManager=function(){function AudioSystemManager(game){this._game=game;this._muted=false;this._playbackRate=1}AudioSystemManager.prototype._setMuted=function(muted){if(this._muted===muted)return;this._muted=muted;var systems=this._game.audio;for(var id in systems){if(!systems.hasOwnProperty(id))continue;systems[id]._setMuted(muted)}};AudioSystemManager.prototype._setPlaybackRate=function(rate){if(this._playbackRate===rate)return;this._playbackRate=rate;var systems=this._game.audio;for(var id in systems){if(!systems.hasOwnProperty(id))continue;systems[id]._setPlaybackRate(rate)}};return AudioSystemManager}();g.AudioSystemManager=AudioSystemManager})(g||(g={}));var g;(function(g){var CompositeOperation;(function(CompositeOperation){CompositeOperation[CompositeOperation["SourceOver"]=0]="SourceOver";CompositeOperation[CompositeOperation["SourceAtop"]=1]="SourceAtop";CompositeOperation[CompositeOperation["Lighter"]=2]="Lighter";CompositeOperation[CompositeOperation["Copy"]=3]="Copy";CompositeOperation[CompositeOperation["ExperimentalSourceIn"]=4]="ExperimentalSourceIn";CompositeOperation[CompositeOperation["ExperimentalSourceOut"]=5]="ExperimentalSourceOut";CompositeOperation[CompositeOperation["ExperimentalDestinationAtop"]=6]="ExperimentalDestinationAtop";CompositeOperation[CompositeOperation["ExperimentalDestinationIn"]=7]="ExperimentalDestinationIn";CompositeOperation[CompositeOperation["DestinationOut"]=8]="DestinationOut";CompositeOperation[CompositeOperation["DestinationOver"]=9]="DestinationOver";CompositeOperation[CompositeOperation["Xor"]=10]="Xor"})(CompositeOperation=g.CompositeOperation||(g.CompositeOperation={}))})(g||(g={}));var g;(function(g){var GlyphFactory=function(){function GlyphFactory(fontFamily,fontSize,baselineHeight,fontColor,strokeWidth,strokeColor,strokeOnly,fontWeight){if(baselineHeight===void 0){baselineHeight=fontSize}if(fontColor===void 0){fontColor="black"}if(strokeWidth===void 0){strokeWidth=0}if(strokeColor===void 0){strokeColor="black"}if(strokeOnly===void 0){strokeOnly=false}if(fontWeight===void 0){fontWeight=g.FontWeight.Normal}this.fontFamily=fontFamily;this.fontSize=fontSize;this.fontWeight=fontWeight;this.baselineHeight=baselineHeight;this.fontColor=fontColor;this.strokeWidth=strokeWidth;this.strokeColor=strokeColor;this.strokeOnly=strokeOnly}return GlyphFactory}();g.GlyphFactory=GlyphFactory})(g||(g={}));var g;(function(g){var LocalTickMode;(function(LocalTickMode){LocalTickMode[LocalTickMode["NonLocal"]=0]="NonLocal";LocalTickMode[LocalTickMode["FullLocal"]=1]="FullLocal";LocalTickMode[LocalTickMode["InterpolateLocal"]=2]="InterpolateLocal"})(LocalTickMode=g.LocalTickMode||(g.LocalTickMode={}))})(g||(g={}));var g;(function(g){var NinePatchSurfaceEffector=function(){function NinePatchSurfaceEffector(game,borderWidth){if(borderWidth===void 0){borderWidth=4}this.game=game;if(typeof borderWidth==="number"){this.borderWidth={top:borderWidth,bottom:borderWidth,left:borderWidth,right:borderWidth}}else{this.borderWidth=borderWidth}}NinePatchSurfaceEffector.prototype.render=function(srcSurface,width,height){var surface=this.game.resourceFactory.createSurface(Math.ceil(width),Math.ceil(height));var renderer=surface.renderer();renderer.begin();var sx1=this.borderWidth.left;var sx2=srcSurface.width-this.borderWidth.right;var sy1=this.borderWidth.top;var sy2=srcSurface.height-this.borderWidth.bottom;var dx1=this.borderWidth.left;var dx2=width-this.borderWidth.right;var dy1=this.borderWidth.top;var dy2=height-this.borderWidth.bottom;var srcCorners=[{x:0,y:0,width:this.borderWidth.left,height:this.borderWidth.top},{x:sx2,y:0,width:this.borderWidth.right,height:this.borderWidth.top},{x:0,y:sy2,width:this.borderWidth.left,height:this.borderWidth.bottom},{x:sx2,y:sy2,width:this.borderWidth.right,height:this.borderWidth.bottom}];var destCorners=[{x:0,y:0},{x:dx2,y:0},{x:0,y:dy2},{x:dx2,y:dy2}];var i=0;for(i=0;i<srcCorners.length;++i){var c=srcCorners[i];renderer.save();renderer.translate(destCorners[i].x,destCorners[i].y);renderer.drawImage(srcSurface,c.x,c.y,c.width,c.height,0,0);renderer.restore()}var srcBorders=[{x:sx1,y:0,width:sx2-sx1,height:this.borderWidth.top},{x:0,y:sy1,width:this.borderWidth.left,height:sy2-sy1},{x:sx2,y:sy1,width:this.borderWidth.right,height:sy2-sy1},{x:sx1,y:sy2,width:sx2-sx1,height:this.borderWidth.bottom}];var destBorders=[{x:dx1,y:0,width:dx2-dx1,height:this.borderWidth.top},{x:0,y:dy1,width:this.borderWidth.left,height:dy2-dy1},{x:dx2,y:dy1,width:this.borderWidth.right,height:dy2-dy1},{x:dx1,y:dy2,width:dx2-dx1,height:this.borderWidth.bottom}];for(i=0;i<srcBorders.length;++i){var s=srcBorders[i];var d=destBorders[i];renderer.save();renderer.translate(d.x,d.y);renderer.transform([d.width/s.width,0,0,d.height/s.height,0,0]);renderer.drawImage(srcSurface,s.x,s.y,s.width,s.height,0,0);renderer.restore()}var sw=sx2-sx1;var sh=sy2-sy1;var dw=dx2-dx1;var dh=dy2-dy1;renderer.save();renderer.translate(dx1,dy1);renderer.transform([dw/sw,0,0,dh/sh,0,0]);renderer.drawImage(srcSurface,sx1,sy1,sw,sh,0,0);renderer.restore();renderer.end();return surface};return NinePatchSurfaceEffector}();g.NinePatchSurfaceEffector=NinePatchSurfaceEffector})(g||(g={}));var g;(function(g){var PathUtil;(function(PathUtil){function resolvePath(base,path){function split(str){var ret=str.split("/");if(ret[ret.length-1]==="")ret.pop();return ret}if(path==="")return base;var baseComponents=PathUtil.splitPath(base);var parts=split(baseComponents.path).concat(split(path));var resolved=[];for(var i=0;i<parts.length;++i){var part=parts[i];switch(part){case"..":var popped=resolved.pop();if(popped===undefined||popped===""||popped===".")throw g.ExceptionFactory.createAssertionError("PathUtil.resolvePath: invalid arguments");break;case".":if(resolved.length===0){resolved.push(".")}break;case"":resolved=[""];break;default:resolved.push(part)}}return baseComponents.host+resolved.join("/")}PathUtil.resolvePath=resolvePath;function resolveDirname(path){var index=path.lastIndexOf("/");if(index===-1)return path;return path.substr(0,index)}PathUtil.resolveDirname=resolveDirname;function resolveExtname(path){for(var i=path.length-1;i>=0;--i){var c=path.charAt(i);if(c==="."){return path.substr(i)}else if(c==="/"){return""}}return""}PathUtil.resolveExtname=resolveExtname;function makeNodeModulePaths(path){var pathComponents=PathUtil.splitPath(path);var host=pathComponents.host;path=pathComponents.path;if(path[path.length-1]==="/"){path=path.slice(0,path.length-1)}var parts=path.split("/");var firstDir=parts.indexOf("node_modules");var root=firstDir>0?firstDir-1:0;var dirs=[];for(var i=parts.length-1;i>=root;--i){if(parts[i]==="node_modules")continue;var dirParts=parts.slice(0,i+1);dirParts.push("node_modules");var dir=dirParts.join("/");dirs.push(host+dir)}return dirs}PathUtil.makeNodeModulePaths=makeNodeModulePaths;function addExtname(path,ext){var index=path.indexOf("?");if(index===-1){return path+"."+ext}return path.substring(0,index)+"."+ext+path.substring(index,path.length)}PathUtil.addExtname=addExtname;function splitPath(path){var host="";var doubleSlashIndex=path.indexOf("//");if(doubleSlashIndex>=0){var hostSlashIndex=path.indexOf("/",doubleSlashIndex+2);if(hostSlashIndex>=0){host=path.slice(0,hostSlashIndex);path=path.slice(hostSlashIndex)}else{host=path;path="/"}}else{host=""}return{host:host,path:path}}PathUtil.splitPath=splitPath})(PathUtil=g.PathUtil||(g.PathUtil={}))})(g||(g={}));var g;(function(g){var FontFamily;(function(FontFamily){FontFamily[FontFamily["SansSerif"]=0]="SansSerif";FontFamily[FontFamily["Serif"]=1]="Serif";FontFamily[FontFamily["Monospace"]=2]="Monospace"})(FontFamily=g.FontFamily||(g.FontFamily={}))})(g||(g={}));var g;(function(g_1){var BitmapFont=function(){function BitmapFont(param){this.surface=g_1.Util.asSurface(param.src);this.map=param.map;this.defaultGlyphWidth=param.defaultGlyphWidth;this.defaultGlyphHeight=param.defaultGlyphHeight;this.missingGlyph=param.missingGlyph;this.size=param.defaultGlyphHeight}BitmapFont.prototype.glyphForCharacter=function(code){var g=this.map[code]||this.missingGlyph;if(!g){return null}var w=g.width===undefined?this.defaultGlyphWidth:g.width;var h=g.height===undefined?this.defaultGlyphHeight:g.height;var offsetX=g.offsetX||0;var offsetY=g.offsetY||0;var advanceWidth=g.advanceWidth===undefined?w:g.advanceWidth;var surface=w===0||h===0?undefined:this.surface;return new g_1.Glyph(code,g.x,g.y,w,h,offsetX,offsetY,advanceWidth,surface,true)};BitmapFont.prototype.destroy=function(){if(this.surface&&!this.surface.destroyed()){this.surface.destroy()}this.map=undefined};BitmapFont.prototype.destroyed=function(){return!this.map};return BitmapFont}();g_1.BitmapFont=BitmapFont})(g||(g={}));var g;(function(g){var TextBaseline;(function(TextBaseline){TextBaseline[TextBaseline["Top"]=0]="Top";TextBaseline[TextBaseline["Middle"]=1]="Middle";TextBaseline[TextBaseline["Alphabetic"]=2]="Alphabetic";TextBaseline[TextBaseline["Bottom"]=3]="Bottom"})(TextBaseline=g.TextBaseline||(g.TextBaseline={}));var SystemLabel=function(_super){__extends(SystemLabel,_super);function SystemLabel(param){var _this=_super.call(this,param)||this;_this.text=param.text;_this.fontSize=param.fontSize;_this.textAlign="textAlign"in param?param.textAlign:g.TextAlign.Left;_this.textBaseline="textBaseline"in param?param.textBaseline:TextBaseline.Alphabetic;_this.maxWidth=param.maxWidth;_this.textColor="textColor"in param?param.textColor:"black";_this.fontFamily="fontFamily"in param?param.fontFamily:g.FontFamily.SansSerif;_this.strokeWidth="strokeWidth"in param?param.strokeWidth:0;_this.strokeColor="strokeColor"in param?param.strokeColor:"black";_this.strokeOnly="strokeOnly"in param?param.strokeOnly:false;return _this}SystemLabel.prototype.renderSelf=function(renderer,camera){if(this.text){var offsetX;switch(this.textAlign){case g.TextAlign.Right:offsetX=this.width;break;case g.TextAlign.Center:offsetX=this.width/2;break;default:offsetX=0}renderer.drawSystemText(this.text,offsetX,0,this.maxWidth,this.fontSize,this.textAlign,this.textBaseline,this.textColor,this.fontFamily,this.strokeWidth,this.strokeColor,this.strokeOnly)}return true};return SystemLabel}(g.E);g.SystemLabel=SystemLabel})(g||(g={}));var g;(function(g){var TextAlign;(function(TextAlign){TextAlign[TextAlign["Left"]=0]="Left";TextAlign[TextAlign["Center"]=1]="Center";TextAlign[TextAlign["Right"]=2]="Right"})(TextAlign=g.TextAlign||(g.TextAlign={}))})(g||(g={}));var g;(function(g){var TickGenerationMode;(function(TickGenerationMode){TickGenerationMode[TickGenerationMode["ByClock"]=0]="ByClock";TickGenerationMode[TickGenerationMode["Manual"]=1]="Manual"})(TickGenerationMode=g.TickGenerationMode||(g.TickGenerationMode={}))})(g||(g={}));var g;(function(g){var Xorshift=function(){function Xorshift(seed){this.initState(seed)}Xorshift.deserialize=function(ser){var ret=new Xorshift(0);ret._state0U=ser._state0U;ret._state0L=ser._state0L;ret._state1U=ser._state1U;ret._state1L=ser._state1L;return ret};Xorshift.prototype.initState=function(seed){var factor=1812433253;seed=factor*(seed^seed>>30)+1;this._state0U=seed;seed=factor*(seed^seed>>30)+2;this._state0L=seed;seed=factor*(seed^seed>>30)+3;this._state1U=seed;seed=factor*(seed^seed>>30)+4;this._state1L=seed};Xorshift.prototype.randomInt=function(){var s1U=this._state0U;var s1L=this._state0L;var s0U=this._state1U;var s0L=this._state1L;this._state0U=s0U;this._state0L=s0L;var t1U=0;var t1L=0;var t2U=0;var t2L=0;var a1=23;var m1=4294967295<<32-a1;t1U=s1U<<a1|(s1L&m1)>>>32-a1;t1L=s1L<<a1;s1U=s1U^t1U;s1L=s1L^t1L;t1U=s1U^s0U;t1L=s1L^s0L;var a2=17;var m2=4294967295>>>32-a2;t2U=s1U>>>a2;t2L=s1L>>>a2|(s1U&m2)<<32-a2;t1U=t1U^t2U;t1L=t1L^t2L;var a3=26;var m3=4294967295>>>32-a3;t2U=s0U>>>a3;t2L=s0L>>>a3|(s0U&m3)<<32-a3;t1U=t1U^t2U;t1L=t1L^t2L;this._state1U=t1U;this._state1L=t1L;var sumL=(t1L>>>0)+(s0L>>>0);t2U=t1U+s0U+(sumL/2>>>31)>>>0;t2L=sumL>>>0;return[t2U,t2L]};Xorshift.prototype.random=function(){var t2=this.randomInt();return(t2[0]*4294967296+t2[1])/0x10000000000000000};Xorshift.prototype.nextInt=function(min,sup){return Math.floor(min+this.random()*(sup-min))};Xorshift.prototype.serialize=function(){return{_state0U:this._state0U,_state0L:this._state0L,_state1U:this._state1U,_state1L:this._state1L}};return Xorshift}();g.Xorshift=Xorshift})(g||(g={}));var g;(function(g){var XorshiftRandomGenerator=function(_super){__extends(XorshiftRandomGenerator,_super);function XorshiftRandomGenerator(seed,xorshift){var _this=this;if(seed===undefined){throw g.ExceptionFactory.createAssertionError("XorshiftRandomGenerator#constructor: seed is undefined")}else{_this=_super.call(this,seed)||this;if(!!xorshift){_this._xorshift=g.Xorshift.deserialize(xorshift)}else{_this._xorshift=new g.Xorshift(seed)}}return _this}XorshiftRandomGenerator.deserialize=function(ser){return new XorshiftRandomGenerator(ser._seed,ser._xorshift)};XorshiftRandomGenerator.prototype.get=function(min,max){return this._xorshift.nextInt(min,max+1)};XorshiftRandomGenerator.prototype.serialize=function(){return{_seed:this.seed,_xorshift:this._xorshift.serialize()}};return XorshiftRandomGenerator}(g.RandomGenerator);g.XorshiftRandomGenerator=XorshiftRandomGenerator})(g||(g={}));